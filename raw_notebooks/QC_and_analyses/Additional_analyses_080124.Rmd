---
title: Cell_type_proportions_analyses080124
summary: Some additional analyses I wanted to do: Dystonia vs Parkinsonism DE, Immune DE, Female (more "healthy" cells?) vs Male DE, D1 vs D2 proportions, CaH vs Put proportions, DNA repair genes, CaH vs Put SPN expression (why is cah more degenerative??)
---
#libraries to load
```{r}
library(Seurat)
library(ggplot2)
library(dplyr)
library(tidyr)
library(qs)
library(tibble)
library(gridExtra)
```

#functions: plot_histogram, 
```{r}
plot_overlapping_density_histogram = function(
    df, 
    hist_col,
    fill_col,
    colors = c("blue", "red"),
    alpha=0.5,
    breaks=seq(0, 16, 1),
    title= NULL,
    xlab = NULL,
    fig_filename = NULL

){
    # hist_col is the column you're making a histogram of (e.g. nUMI)
    # fill_col is the column you're coloring by (e.g. cell_class)
    # if fig_filename is not null, the plot will be saved to that file
     
    if (is.null(xlab)){
        xlab = hist_col
    }

    if (is.null(title)){
        title = paste0("Density Histogram of ", xlab, " by ", fill_col)
    }


    p = (
        ggplot(df, aes_string(x=hist_col, fill=fill_col)) 
        + geom_histogram(aes(y=..density..), alpha=alpha, position="identity", breaks=breaks)
        + labs(title=title, x=xlab, y="Density")    
        + theme(
                plot.title = element_text(size=16),
                axis.line = element_line(color = "black"),  # Add axis lines
                axis.ticks = element_line(color = "black"),  # Add axis ticks
                axis.text = element_text(size = 14),  # Increase tick label font size
                axis.title = element_text(size = 15)  # Increase axis label font size
            ) 
        + scale_fill_manual(values=colors)   
    )

    if (!is.null(fig_filename)){
        ggsave(fig_filename, p, width=8, height=6)
    }

    return(p)
}
```

```{r}
SPN_score = function(gene_df, SCtransform_counts, logfc_val, method = "multiply"){

significant_genes = unique(gene_df$gene)

exp = FetchData(SCtransform_counts, vars = significant_genes)

rownames(gene_df) = gene_df$gene
gene_df$gene = NULL

# Assuming gene_df and exp are your dataframes
logfc_df <- gene_df
counts_df <- exp

print(logfc_df)
print(counts_df)

# Check if all column names in counts_df are in the row names of logfc_df
if (!all(colnames(counts_df) %in% rownames(logfc_df))) {
  stop("Not all genes in counts_df are present in logfc_df")
}

# Reorder logfc_df to match the columns in counts_df
logfc_ordered <- logfc_df[colnames(counts_df), , drop = FALSE]
logfc_ordered

logfc = logfc_ordered[[logfc_val]]

# Check for NA values in logfc_ordered
if (any(is.na(logfc))) {
  stop("There are NA values in the logFC values for the genes")
}


# Ensure logfc_ordered$logfc is a numeric vector
logfc_vector <- as.numeric(logfc)
logfc_vector


if (method == "multiply") {
  
#THE ACTUAL
result_df <- sweep(counts_df, 2, logfc_vector, FUN = "*")
} else if(method == "log"){
  custom_log_transform <- function(x, logFC_value) {
     x * 2^logFC_value
  }
  result_df <- sweep(counts_df, 2, logfc_vector, FUN = custom_log_transform)
} else{
  stop("Calculation is not working")
}

# Print the result
print(result_df)


metadata <- SCtransform_counts@meta.data
# Assume that metadata has a column 'donor' that contains donor information
# If not, modify this part according to your metadata structure
if(!"donor_id" %in% colnames(metadata)) {
  stop("Metadata does not contain 'donor' information. Please check your metadata structure.")
}

# Create unique identifiers for cell column to avoid conflicts
expr_data <- result_df %>%
  rownames_to_column(var = "cell_id")

metadata <- metadata %>%
  rownames_to_column(var = "cell_id")

# Combine expression data with donor information
expr_data_long <- expr_data %>%
  pivot_longer(cols = -cell_id, names_to = "gene", values_to = "expression") %>%
  left_join(metadata %>% select(cell_id, donor_id, Condition, subcluster, sub_class, cell_class), by = "cell_id")
# Assuming your data frame is named expr_data_long
print(expr_data_long)
# Count the number of occurrences for each gene per donor

summarized_expr_data <- expr_data_long %>%
  group_by(cell_id, donor_id, Condition, subcluster, sub_class, cell_class) %>%
  summarize(total_expression = sum(expression), .groups = 'drop')
print(summarized_expr_data)

spn_scores = summarized_expr_data$total_expression
mean_spn <- mean(spn_scores, na.rm = TRUE)
sd_spn <- sd(spn_scores, na.rm = TRUE)
# Compute the z-score for each SPN score
summarized_expr_data$z_score  <- (spn_scores - mean_spn) / sd_spn

return(summarized_expr_data)
}
```


```{r}
# Add z-scores to Seurat object metadata
caudate_neurons_transformed <- AddMetaData(caudate_neurons_transformed, metadata = spn_zscores, col.name = "SPN_zscore")

# Visualize SPN z-scores on UMAP
plot <- FeaturePlot(caudate_neurons_transformed, features = "SPN_zscore") +
  ggtitle("SPN Z-Score on UMAP")

# Save the UMAP plot with SPN z-scores as a PNG file
ggsave("SPN_zscore_umap.png", plot = plot, width = 10, height = 8, dpi = 300)

```

```{r}
SPN_score_graphs <- function(SPN_score_output, 
                             donor_order = donors, 
                             total_expression = "total_expression", 
                             fillcol = "subcluster", 
                             color = color1, 
                             donor_graph_title = "CaH SPNs vs non-SPNs", 
                             SCtransformcounts, 
                             SPN_score_col_name) {
  
  # Ensure total_expression is a string
  total_expression <- as.character(total_expression)
  
  # Calculate min, max, and median
  min_SPN_score <- min(SPN_score_output[[total_expression]], na.rm = TRUE)
  max_SPN_score <- max(SPN_score_output[[total_expression]], na.rm = TRUE)
  median_SPN_score <- median(SPN_score_output[[total_expression]], na.rm = TRUE)
  
  print("min, max, median scores")
  print(min_SPN_score)
  print(max_SPN_score)
  print(median_SPN_score)
  
  options(repr.plot.width = 24, repr.plot.height = 16)
  plots <- list()
  
  for (donor in donor_order) {
    test <- SPN_score_output[SPN_score_output$donor_id == donor, ]
    plots[[donor]] <- plot_overlapping_density_histogram(df = test,
                                                         hist_col = total_expression,
                                                         fill_col = fillcol,
                                                         colors = color,
                                                         breaks = seq(min_SPN_score, max_SPN_score, round(max_SPN_score / 50)),
                                                         title = paste(donor_graph_title, ": ", donor),
                                                         xlab = "SPN Score",
                                                         fig_filename = NULL)
  }
  
  layout_matrix <- rbind(
    c(1, 2, 3, 4, 5),
    c(6, 7, 8, 9, 10),
    c(11, 12, 13, NA, NA),
    c(14, 15, 16, 17, NA)
  )
  
  # Arrange the plots according to the custom layout
  grid_plots <- grid.arrange(grobs = plots, layout_matrix = layout_matrix)
  
  # Save the arranged plots to a PNG file
  ggsave(filename = "SPN_SCORE_Output/USETEST.png", plot = grid_plots, width = 30, height = 16)
  
  print("donor plot done")
  
  XDP <- SPN_score_output[SPN_score_output$Condition == "XDP", ]
  a <- plot_overlapping_density_histogram(df = XDP, 
                                          hist_col = total_expression,
                                          fill_col = fillcol,
                                          colors = color,
                                          breaks = seq(min_SPN_score, max_SPN_score, round(max_SPN_score / 50)),
                                          title = paste(donor_graph_title, ": ", "XDP"),
                                          xlab = "SPN score",
                                          fig_filename = NULL)
  
  Control <- SPN_score_output[SPN_score_output$Condition == "Control", ]
  b <- plot_overlapping_density_histogram(df = Control, 
                                          hist_col = total_expression,
                                          fill_col = fillcol,
                                          colors = color,
                                          breaks = seq(min_SPN_score, max_SPN_score, round(max_SPN_score / 50)),
                                          title = paste(donor_graph_title, ": ", "Control"),
                                          xlab = "SPN score",
                                          fig_filename = NULL)
  
  print("Condition plot done")
  
  SPN <- SPN_score_output[SPN_score_output$subcluster == "SPN", ]
  c <- plot_overlapping_density_histogram(df = SPN, 
                                          hist_col = total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue"),
                                          breaks = seq(min_SPN_score, max_SPN_score, round(max_SPN_score / 50)),
                                          title = "XDP vs Control: SPN",
                                          xlab = "SPN score",
                                          fig_filename = NULL)
  
  notSPN <- SPN_score_output[SPN_score_output$subcluster == "non-SPN", ]
  d <- plot_overlapping_density_histogram(df = notSPN, 
                                          hist_col = total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue"),
                                          breaks = seq(min_SPN_score, max_SPN_score, round(max_SPN_score / 50)),
                                          title = "XDP vs Control: non-SPN",
                                          xlab = "SPN score",
                                          fig_filename = NULL)
  
  print(a)
  print(b)
  print(c)
  print(d)
  
  print("graphs done")
  
  # Calculate the threshold
  threshold <- quantile(SPN_score_output[[total_expression]][SPN_score_output[["subcluster"]] == "SPN" & SPN_score_output[["Condition"]] == "XDP"], 0.1, na.rm = TRUE)
  print(threshold)
  
  # Subset the data
  SPN_score_output_identity_loss_SPN <- SPN_score_output[SPN_score_output[[total_expression]] < threshold & SPN_score_output[["subcluster"]] == "SPN", ]
  
  print(SPN_score_output_identity_loss_SPN)
  print(table(SPN_score_output_identity_loss_SPN$donor_id))
  
  identity_loss_cells <- unique(SPN_score_output_identity_loss_SPN$cell_id)
  
  SCtransformcounts@meta.data$SPN_identity <- "Other"
  SCtransformcounts$SPN_identity[identity_loss_cells] <- "Losing_Identity"
  SCtransformcounts@meta.data
  
  # Visualize on UMAP
  pic <- DimPlot(SCtransformcounts, reduction = "umap", group.by = "SPN_identity", split.by = "Condition", cols = c("red", "grey"))
  print(pic)
  ggsave("SPN_SCORE_Output/SPN_score_10pct_TEST.png", plot = pic, width = 20, height = 8, units = "in", dpi = 300)
  
  spn_scores <- setNames(SPN_score_output[[total_expression]], SPN_score_output$cell_id)
  
  SCtransformcounts <- AddMetaData(SCtransformcounts, metadata = spn_scores, col.name = SPN_score_col_name)
  
  pic2 <- FeaturePlot(SCtransformcounts, features = SPN_score_col_name, split.by = "Condition")
  print(pic2)
  ggsave("SPN_SCORE_Output/SPN_UMAP_TEST.png", plot = pic2, width = 20, height = 8, units = "in", dpi = 300)
  
  return(SCtransformcounts)
}

```



```{r}
  XDP <- SPN_score_output[SPN_score_output$Condition == "XDP", ]
  a <- plot_overlapping_density_histogram(df = XDP, 
                                          hist_col = total_expression,
                                          fill_col = fillcol,
                                          colors = color,
                                          breaks = seq(min_SPN_score, max_SPN_score, round(max_SPN_score / 50)),
                                          title = paste(donor_graph_title, ": ", "XDP"),
                                          xlab = "SPN score",
                                          fig_filename = NULL)
```


```{r}
cell_class_score = function(gene_df, SCtransform_counts, logfc_val){

significant_genes = unique(gene_df$gene)

exp = FetchData(SCtransform_counts, vars = significant_genes)

rownames(gene_df) = gene_df$gene
gene_df$gene = NULL

# Assuming gene_df and exp are your dataframes
logfc_df <- gene_df
counts_df <- exp

print(logfc_df)
print(counts_df)

# Check if all column names in counts_df are in the row names of logfc_df
if (!all(colnames(counts_df) %in% rownames(logfc_df))) {
  stop("Not all genes in counts_df are present in logfc_df")
}

# Reorder logfc_df to match the columns in counts_df
logfc_ordered <- logfc_df[colnames(counts_df), , drop = FALSE]
logfc_ordered

logfc = logfc_ordered[[logfc_val]]

# Check for NA values in logfc_ordered
if (any(is.na(logfc))) {
  stop("There are NA values in the logFC values for the genes")
}


# Ensure logfc_ordered$logfc is a numeric vector
logfc_vector <- as.numeric(logfc)
logfc_vector


#THE ACTUAL
result_df <- sweep(counts_df, 2, logfc_vector, FUN = "*")

# Print the result
print(result_df)

metadata <- SCtransform_counts@meta.data
# Assume that metadata has a column 'donor' that contains donor information
# If not, modify this part according to your metadata structure
if(!"donor_id" %in% colnames(metadata)) {
  stop("Metadata does not contain 'donor' information. Please check your metadata structure.")
}

# Create unique identifiers for cell column to avoid conflicts
expr_data <- result_df %>%
  rownames_to_column(var = "cell_id")

metadata <- metadata %>%
  rownames_to_column(var = "cell_id")

# Combine expression data with donor information
expr_data_long <- expr_data %>%
  pivot_longer(cols = -cell_id, names_to = "gene", values_to = "expression") %>%
  left_join(metadata %>% select(cell_id, donor_id, Condition, cell_class), by = "cell_id")
# Assuming your data frame is named expr_data_long
print(expr_data_long)
# Count the number of occurrences for each gene per donor

summarized_expr_data <- expr_data_long %>%
  group_by(cell_id, donor_id, Condition, cell_class) %>%
  summarize(total_expression = sum(expression), .groups = 'drop')
print(summarized_expr_data)

spn_scores = summarized_expr_data$total_expression
mean_spn <- mean(spn_scores, na.rm = TRUE)
sd_spn <- sd(spn_scores, na.rm = TRUE)
# Compute the z-score for each SPN score
summarized_expr_data$z_score  <- (spn_scores - mean_spn) / sd_spn

return(summarized_expr_data)
}
```

```{r}
cell_type_score_graphs <- function(SPN_score_output, 
                             donor_order = donors, 
                             total_expression = "total_expression", 
                             fillcol = "cell_class", 
                             color = color1, 
                             donor_graph_title, 
                             SCtransformcounts, 
                             SPN_score_col_name) {
  
  # Ensure total_expression is a string
  total_expression <- as.character(total_expression)
  
  # Calculate min, max, and median
  min_SPN_score <- min(SPN_score_output[[total_expression]], na.rm = TRUE)
  max_SPN_score <- max(SPN_score_output[[total_expression]], na.rm = TRUE)
  median_SPN_score <- median(SPN_score_output[[total_expression]], na.rm = TRUE)
  
  print("min, max, median scores")
  print(min_SPN_score)
  print(max_SPN_score)
  print(median_SPN_score)
  
  options(repr.plot.width = 24, repr.plot.height = 16)
  plots <- list()
  
  for (donor in donor_order) {
    test <- SPN_score_output[SPN_score_output$donor_id == donor, ]
    plots[[donor]] <- plot_overlapping_density_histogram(df = test,
                                                         hist_col = total_expression,
                                                         fill_col = fillcol,
                                                         colors = color,
                                                         breaks = seq(min_SPN_score, max_SPN_score, round(max_SPN_score / 50)),
                                                         title = paste(donor_graph_title, ": ", donor),
                                                         xlab = "SPN Score",
                                                         fig_filename = NULL)
  }
  
  layout_matrix <- rbind(
    c(1, 2, 3, 4, 5),
    c(6, 7, 8, 9, 10),
    c(11, 12, 13, NA, NA),
    c(14, 15, 16, 17, NA)
  )
  
  # Arrange the plots according to the custom layout
  grid_plots <- grid.arrange(grobs = plots, layout_matrix = layout_matrix)
  
  # Save the arranged plots to a PNG file
  ggsave(filename = "SPN_SCORE_Output/celltypeUSETEST.png", plot = grid_plots, width = 30, height = 16)
  
  print("donor plot done")
  
  XDP <- SPN_score_output[SPN_score_output$Condition == "XDP", ]
  a <- plot_overlapping_density_histogram(df = XDP, 
                                          hist_col = total_expression,
                                          fill_col = fillcol,
                                          colors = color,
                                          breaks = seq(min_SPN_score, max_SPN_score, round(max_SPN_score / 50)),
                                          title = paste(donor_graph_title, ": ", "XDP"),
                                          xlab = "SPN score",
                                          fig_filename = NULL)
  
  Control <- SPN_score_output[SPN_score_output$Condition == "Control", ]
  b <- plot_overlapping_density_histogram(df = Control, 
                                          hist_col = total_expression,
                                          fill_col = fillcol,
                                          colors = color,
                                          breaks = seq(min_SPN_score, max_SPN_score, round(max_SPN_score / 50)),
                                          title = paste(donor_graph_title, ": ", "Control"),
                                          xlab = "SPN score",
                                          fig_filename = NULL)
  
  print("Condition plot done")
  
  # SPN <- SPN_score_output[SPN_score_output$subcluster == "SPN", ]
  # c <- plot_overlapping_density_histogram(df = SPN, 
  #                                         hist_col = total_expression,
  #                                         fill_col = "Condition",
  #                                         colors = c("XDP" = "red", "Control" = "blue"),
  #                                         breaks = seq(min_SPN_score, max_SPN_score, round(max_SPN_score / 50)),
  #                                         title = "XDP vs Control: SPN",
  #                                         xlab = "SPN score",
  #                                         fig_filename = NULL)
  # 
  # notSPN <- SPN_score_output[SPN_score_output$subcluster == "non-SPN", ]
  # d <- plot_overlapping_density_histogram(df = notSPN, 
  #                                         hist_col = total_expression,
  #                                         fill_col = "Condition",
  #                                         colors = c("XDP" = "red", "Control" = "blue"),
  #                                         breaks = seq(min_SPN_score, max_SPN_score, round(max_SPN_score / 50)),
  #                                         title = "XDP vs Control: non-SPN",
  #                                         xlab = "SPN score",
  #                                         fig_filename = NULL)
  
  # print(a)
  # print(b)
  # print(c)
  # print(d)
  # 
  # print("graphs done")
  
  # Calculate the threshold
  threshold <- quantile(SPN_score_output[[total_expression]][SPN_score_output[["cell_type"]] == "SPN" & SPN_score_output[["Condition"]] == "XDP"], 0.1, na.rm = TRUE)
  print(threshold)
  
  # Subset the data
  SPN_score_output_identity_loss_SPN <- SPN_score_output[SPN_score_output[[total_expression]] < threshold & SPN_score_output[["subcluster"]] == "SPN", ]
  
  print(SPN_score_output_identity_loss_SPN)
  print(table(SPN_score_output_identity_loss_SPN$donor_id))
  
  identity_loss_cells <- unique(SPN_score_output_identity_loss_SPN$cell_id)
  
  SCtransformcounts@meta.data$SPN_identity <- "Other"
  SCtransformcounts$SPN_identity[identity_loss_cells] <- "Losing_Identity"
  SCtransformcounts@meta.data
  
  # Visualize on UMAP
  pic <- DimPlot(SCtransformcounts, reduction = "umap", group.by = "SPN_identity", split.by = "Condition", cols = c("red", "grey"))
  print(pic)
  ggsave("SPN_SCORE_Output/celltype_10pct_TEST.png", plot = pic, width = 20, height = 8, units = "in", dpi = 300)
  
  spn_scores <- setNames(SPN_score_output[[total_expression]], SPN_score_output$cell_id)
  
  SCtransformcounts <- AddMetaData(SCtransformcounts, metadata = spn_scores, col.name = SPN_score_col_name)
  
  pic2 <- FeaturePlot(SCtransformcounts, features = SPN_score_col_name, split.by = "Condition")
  print(pic2)
  ggsave("SPN_SCORE_Output/celltype_UMAP_TEST.png", plot = pic2, width = 20, height = 8, units = "in", dpi = 300)
  
  return(SCtransformcounts)
}

```


#From SPN_scores
```{r}
caudate_neurons = qread("~/SOBJ_USE_THESE/caudate_neuron080124.qs")
putamen_neurons= qread("~/SOBJ_USE_THESE/putamen_neuron080124.qs")

caudate_neurons
putamen_neurons

caudate_neurons@meta.data
putamen_neurons@meta.data
```

```{r}
caudate_neurons_transformed= qread("~/SOBJ_USE_THESE/caudate_neurons_transformed.qs")
putamen_neurons_transformed= qread("~/SOBJ_USE_THESE/putamen_neurons_transformed.qs")

caudate_neurons_transformed
putamen_neurons_transformed
caudate_neurons_transformed@meta.data
putamen_neurons_transformed@meta.data
```

```{r}
merged_xdp = qread("~/SOBJ_USE_THESE/merged_xdp_use_this.qs")
merged_xdp
merged_xdp@meta.data

```
```{r}
caudate = qread("~/SOBJ_USE_THESE/caudate_sobj_080124.qs")
putamen= qread("~/SOBJ_USE_THESE/putamen_sobj_080124.qs")
caudate@meta.data
putamen@meta.data
```

```{r}
DimPlot(caudate, group.by = "cell_class")
DimPlot(caudate, group.by = "sub_class")
DimPlot(caudate, group.by = "neuron_sub_class")
DimPlot(caudate, group.by = "neuron_subclusters")

```
#D1 vs D2 proportions- which is more degenerate? Do for caudate, putamen, merged

```{r}
caudate_SPNs = as.data.frame(table(caudate$D1_D2, caudate$donor_id))
putamen_SPNs = as.data.frame(table(putamen$D1_D2, putamen$donor_id))

caudate_SPNs$subclass = caudate_SPNs$Var1
caudate_SPNs$donor_id = caudate_SPNs$Var2
caudate_SPNs$cells = caudate_SPNs$Freq
caudate_SPNs$Var1 = NULL
caudate_SPNs$Var2= NULL
caudate_SPNs$Freq= NULL

putamen_SPNs$subclass = putamen_SPNs$Var1
putamen_SPNs$donor_id = putamen_SPNs$Var2
putamen_SPNs$cells = putamen_SPNs$Freq
putamen_SPNs$Var1 = NULL
putamen_SPNs$Var2= NULL
putamen_SPNs$Freq= NULL

caudate_SPNs
putamen_SPNs
```

```{r}
caudate_total = as.data.frame(table(caudate$donor_id))
caudate_total

caudate_fraction = merge(caudate_SPNs, caudate_total, by.x = "donor_id", by.y= "Var1")
caudate_fraction$total_cells = caudate_fraction$Freq
caudate_fraction$Freq = NULL
caudate_fraction

caudate_fraction$fraction = caudate_fraction$cells/caudate_fraction$total_cells
caudate_fraction
```
```{r}
putamen_total = as.data.frame(table(putamen$donor_id))
putamen_total

putamen_fraction = merge(putamen_SPNs, putamen_total, by.x = "donor_id", by.y= "Var1")
putamen_fraction$total_cells = putamen_fraction$Freq
putamen_fraction$Freq = NULL
putamen_fraction

putamen_fraction$fraction = putamen_fraction$cells/putamen_fraction$total_cells
putamen_fraction
```
```{r}
caudate_fraction$region = "caudate"
putamen_fraction$region = "putamen"
```

```{r}
caudate_fraction
putamen_fraction
```


```{r}
caudate_D1 = subset(caudate_fraction, subset = subclass == "D1") 
caudate_D2 = subset(caudate_fraction, subset = subclass == "D2")
caudate_D1_D2 = rbind(caudate_D1, caudate_D2)
caudate_D1_D2
```

```{r}
CAP_order = c("SCF_21-037CM2", "SCF-22-054CM", "SCF-22-058CF", "SCF-23-068CM", "SCF-19-014", 
  "PCMC-16-012", "SCF-18-003", "SCF-18-006", "SCF-19-018", "SCF-20-023", 
  "PCMC-16-011", "SCF-21-030", "SCF-20-025", "SCF-19-009", "SCF_20-024", 
  "SCF-18-004", "SCF_22-043")
CAP_order

caudate_D1$donor_id = factor(caudate_D1$donor_id, levels = CAP_order)
caudate_D1

caudate_D2$donor_id = factor(caudate_D2$donor_id, levels = CAP_order)
caudate_D2


```
```{r}
# Combine the data for easier plotting
merged_fraction <- data.frame(fraction_D1 = caudate_D1$fraction, fraction_D2 = caudate_D2$fraction,
                            donor_id = caudate_D1$donor_id)

merged_fraction$Condition = ifelse(grepl("SCF_21-037CM2|SCF-23-068CM|SCF-22-058CF|SCF-22-054CM", merged_fraction$donor_id), "Control", "XDP")
merged_fraction
```

```{r}
merged_fraction
```

```{r}
min(merged_fraction$fraction_D1)
max(merged_fraction$fraction_D1)

min(merged_fraction$fraction_D2)
max(merged_fraction$fraction_D2)
```


```{r}
# Fit a linear model
lm_fit <- lm(fraction_D1 ~ fraction_D2, data = merged_fraction)

# Extract the slope (coefficient) and R-squared value
slope <- coef(lm_fit)[2]
r_squared <- summary(lm_fit)$r.squared
p_value <- summary(lm_fit)$coefficients[2, 4] 

ggplot(merged_fraction, aes(x = fraction_D1, y = fraction_D2, color = donor_id))+
  geom_point(size = 3) +    
  geom_smooth(method = "lm", se = FALSE,       
              color = "red", fill = "lightpink", linetype = "dashed") +
  xlim(0,0.15) + ylim(0, 0.15) +
  labs(
    title = "Caudate D1 vs D2 fraction",
    x = "D1 fraction",
    y = "D2 fraction", color = "Donors (ordered by CAP score)"
  ) +
 annotate("text", x = Inf, y = Inf, label = sprintf("Slope: %.2f", slope), 
           hjust = 1.1, vjust = 2, size = 5, color = "black") +
  annotate("text", x = Inf, y = Inf, label = sprintf("R^2: %.2f", r_squared), 
           hjust = 1.1, vjust = 4, size = 5, color = "black") +   
  annotate("text", x = Inf, y = Inf, label = sprintf("P-value: %0.3f", p_value), 
           hjust = 1.1, vjust = 6, size = 5, color = "black")
```


#putamen D1 vs D2
```{r}
putamen_fraction
```


```{r}
CAP_order = c("SCF_21-037CM2", "SCF-22-054CM", "SCF-22-058CF", "SCF-23-068CM", "SCF-19-014", 
  "PCMC-16-012", "SCF-18-003", "SCF-18-006", "SCF-19-018", "SCF-20-023", 
  "PCMC-16-011", "SCF-21-030", "SCF-20-025", "SCF-19-009", "SCF_20-024", 
  "SCF-18-004", "SCF_22-043")
CAP_order

putamen_D1$donor_id = factor(putamen_D1$donor_id, levels = CAP_order)
putamen_D1

putamen_D2$donor_id = factor(putamen_D2$donor_id, levels = CAP_order)
putamen_D2


```

```{r}
# Combine the data for easier plotting
merged_fraction <- data.frame(fraction_D1 = putamen_D1$fraction, fraction_D2 = putamen_D2$fraction,
                            donor_id = putamen_D1$donor_id)

merged_fraction$Condition = ifelse(grepl("SCF_21-037CM2|SCF-23-068CM|SCF-22-058CF|SCF-22-054CM", merged_fraction$donor_id), "Control", "XDP")
merged_fraction
```

```{r}
min(merged_fraction$fraction_D1)
max(merged_fraction$fraction_D1)

min(merged_fraction$fraction_D2)
max(merged_fraction$fraction_D2)
```


```{r}
# Fit a linear model
lm_fit <- lm(fraction_D1 ~ fraction_D2, data = merged_fraction)

# Extract the slope (coefficient) and R-squared value
slope <- coef(lm_fit)[2]
r_squared <- summary(lm_fit)$r.squared
p_value <- summary(lm_fit)$coefficients[2, 4] 

ggplot(merged_fraction, aes(x = fraction_D1, y = fraction_D2, color = donor_id))+
  geom_point(size = 3) +    
  geom_smooth(method = "lm", se = FALSE,       
              color = "red", fill = "lightpink", linetype = "dashed") +
  xlim(0,0.25) + ylim(0, 0.25) +
  labs(
    title = "Putamen D1 vs D2 fraction",
    x = "D1 fraction",
    y = "D2 fraction", color = "Donors (ordered by CAP score)"
  ) +
 annotate("text", x = Inf, y = Inf, label = sprintf("Slope: %.2f", slope), 
           hjust = 1.1, vjust = 2, size = 5, color = "black") +
  annotate("text", x = Inf, y = Inf, label = sprintf("R^2: %.2f", r_squared), 
           hjust = 1.1, vjust = 4, size = 5, color = "black") +   
  annotate("text", x = Inf, y = Inf, label = sprintf("P-value: %0.3f", p_value), 
           hjust = 1.1, vjust = 6, size = 5, color = "black")
```

#caudate + putamen D1 vs D2
```{r}
caudate_D1$caudate_D1_cells = caudate_D1$cells
caudate_D1$cells = NULL
caudate_D2$caudate_D2_cells = caudate_D2$cells
caudate_D2$cells = NULL
putamen_D1$putamen_D1_cells = putamen_D1$cells
putamen_D1$cells = NULL
putamen_D2$putamen_D2_cells = putamen_D2$cells
putamen_D2$cells = NULL

caudate_D1
caudate_D2
putamen_D1
putamen_D2
```
```{r}
merged_D1 = data.frame(donor_id = caudate_D1$donor_id, caudate_D1_cell = caudate_D1$caudate_D1_cells, putamen_D1_cell = putamen_D1$putamen_D1_cells, caudate_cells = caudate_D1$total_cells, putamen_cells = putamen_D1$total_cells)

merged_D1$total_D1 = merged_D1$caudate_D1_cell + merged_D1$putamen_D1_cell
merged_D1$total_cells = merged_D1$caudate_cells + merged_D1$putamen_cells
merged_D1$D1_fraction = merged_D1$total_D1/merged_D1$total_cells
merged_D1
```
```{r}
merged_D2 = data.frame(donor_id = caudate_D2$donor_id, caudate_D2_cell = caudate_D2$caudate_D2_cells, putamen_D2_cell = putamen_D2$putamen_D2_cells, caudate_cells = caudate_D2$total_cells, putamen_cells = putamen_D2$total_cells)

merged_D2$total_D2 = merged_D2$caudate_D2_cell + merged_D2$putamen_D2_cell
merged_D2$total_cells = merged_D2$caudate_cells + merged_D2$putamen_cells
merged_D2$D2_fraction = merged_D2$total_D2/merged_D2$total_cells
merged_D2
```

```{r}
merged_D1_D2 = data.frame(donor_id = merged_D1$donor_id, D1_fraction = merged_D1$D1_fraction, D2_fraction = merged_D2$D2_fraction)
merged_D1_D2$Condition = ifelse(grepl("SCF_21-037CM2|SCF-23-068CM|SCF-22-058CF|SCF-22-054CM", merged_D1_D2$donor_id), "Control", "XDP")
merged_D1_D2
```

```{r}
min(merged_D1_D2$D1_fraction)
max(merged_D1_D2$D1_fraction)

min(merged_D1_D2$D2_fraction)
max(merged_D1_D2$D2_fraction)
```


```{r}
# Fit a linear model
lm_fit <- lm(D1_fraction ~ D2_fraction, data = merged_D1_D2)

# Extract the slope (coefficient) and R-squared value
slope <- coef(lm_fit)[2]
r_squared <- summary(lm_fit)$r.squared
p_value <- summary(lm_fit)$coefficients[2, 4] 

ggplot(merged_D1_D2, aes(x = D1_fraction, y = D2_fraction, color = donor_id))+
  geom_point(size = 3) +    
  geom_smooth(method = "lm", se = FALSE,       
              color = "red", fill = "lightpink", linetype = "dashed") +
  xlim(0,0.2) + ylim(0, 0.2) +
  labs(
    title = "CaH + Put: D1 vs D2 fraction",
    x = "D1 fraction",
    y = "D2 fraction", color = "Donors (ordered by CAP score)"
  ) +
 annotate("text", x = Inf, y = Inf, label = sprintf("Slope: %.2f", slope), 
           hjust = 1.1, vjust = 2, size = 5, color = "black") +
  annotate("text", x = Inf, y = Inf, label = sprintf("R^2: %.2f", r_squared), 
           hjust = 1.1, vjust = 4, size = 5, color = "black") +   
  annotate("text", x = Inf, y = Inf, label = sprintf("P-value: %0.3f", p_value), 
           hjust = 1.1, vjust = 6, size = 5, color = "black")
```
#caudate vs putamen

```{r}
caudate_D1
caudate_D2
putamen_D1
putamen_D2
```

```{r}
merged_D1 = data.frame(donor_id = caudate_D1$donor_id, caudate_D1_fraction = caudate_D1$fraction, putamen_D1_fraction = putamen_D1$fraction)

merged_D1$Condition = ifelse(grepl("SCF_21-037CM2|SCF-23-068CM|SCF-22-058CF|SCF-22-054CM", merged_D1$donor_id), "Control", "XDP")

merged_D1

merged_D2 = data.frame(donor_id = caudate_D2$donor_id, caudate_D2_fraction = caudate_D2$fraction, putamen_D2_fraction = putamen_D2$fraction)

merged_D2$Condition = ifelse(grepl("SCF_21-037CM2|SCF-23-068CM|SCF-22-058CF|SCF-22-054CM", merged_D2$donor_id), "Control", "XDP")

merged_D2
```

```{r}
min(merged_D1_D2$D1_fraction)
max(merged_D1_D2$D1_fraction)

min(merged_D1_D2$D2_fraction)
max(merged_D1_D2$D2_fraction)
```


```{r}
# Fit a linear model
lm_fit <- lm(caudate_D1_fraction ~ putamen_D1_fraction, data = merged_D1)

# Extract the slope (coefficient) and R-squared value
slope <- coef(lm_fit)[2]
r_squared <- summary(lm_fit)$r.squared
p_value <- summary(lm_fit)$coefficients[2, 4] 

ggplot(merged_D1, aes(x = caudate_D1_fraction, y = putamen_D1_fraction, color = donor_id))+
  geom_point(size = 3) +    
  geom_smooth(method = "lm", se = FALSE,       
              color = "red", fill = "lightpink", linetype = "dashed") +
  xlim(0,0.2) + ylim(0, 0.2) +
  labs(
    title = "CaH D1 vs Put D1 fraction",
    x = "Caudate D1 fraction",
    y = "Putamen D1 fraction", color = "Donors (ordered by CAP score)"
  ) +
 annotate("text", x = Inf, y = Inf, label = sprintf("Slope: %.2f", slope), 
           hjust = 1.1, vjust = 2, size = 5, color = "black") +
  annotate("text", x = Inf, y = Inf, label = sprintf("R^2: %.2f", r_squared), 
           hjust = 1.1, vjust = 4, size = 5, color = "black") +   
  annotate("text", x = Inf, y = Inf, label = sprintf("P-value: %0.3f", p_value), 
           hjust = 1.1, vjust = 6, size = 5, color = "black")
```



```{r}
# Fit a linear model
lm_fit <- lm(caudate_D2_fraction ~ putamen_D2_fraction, data = merged_D2)

# Extract the slope (coefficient) and R-squared value
slope <- coef(lm_fit)[2]
r_squared <- summary(lm_fit)$r.squared
p_value <- summary(lm_fit)$coefficients[2, 4] 

ggplot(merged_D2, aes(x = caudate_D2_fraction, y = putamen_D2_fraction, color = donor_id))+
  geom_point(size = 3) +    
  geom_smooth(method = "lm", se = FALSE,       
              color = "red", fill = "lightpink", linetype = "dashed") +
  xlim(0,0.22) + ylim(0, 0.22) +
  labs(
    title = "CaH D2 vs Put D2 fraction",
    x = "Caudate D2 fraction",
    y = "Putamen D2 fraction", color = "Donors (ordered by CAP score)"
  ) +
 annotate("text", x = Inf, y = Inf, label = sprintf("Slope: %.2f", slope), 
           hjust = 1.1, vjust = 2, size = 5, color = "black") +
  annotate("text", x = Inf, y = Inf, label = sprintf("R^2: %.2f", r_squared), 
           hjust = 1.1, vjust = 4, size = 5, color = "black") +   
  annotate("text", x = Inf, y = Inf, label = sprintf("P-value: %0.3f", p_value), 
           hjust = 1.1, vjust = 6, size = 5, color = "black")
```



















































#DE csvs
```{r}
CaH_ALL_SPN_DE = read.csv("~/GSEA/de/SPN_DE/XDP DE - Caudate Neurons - 20240603 - All SPN.csv")
CaH_ALL_IN_DE = read.csv("~/GSEA/de/SPN_DE/XDP DE - Caudate Neurons - 20240603 - All IN.csv")
CaH_eSPN_DE = read.csv("~/cah_espn.csv")

Put_ALL_SPN_DE = read.csv("~/GSEA/de/SPN_DE/XDP DE - Putamen Neurons - 20240603 - All SPN.csv")
Put_ALL_IN_DE = read.csv("~/GSEA/de/SPN_DE/XDP DE - Putamen Neurons - 20240603 - All IN.csv")
Put_eSPN_DE = read.csv("~/GSEA/de/SPN_DE/XDP DE - Putamen Neurons - 20240603 - All eSPN.csv")

CaH_ALL_SPN_DE
CaH_ALL_IN_DE
CaH_eSPN_DE
Put_ALL_SPN_DE
Put_ALL_IN_DE
Put_eSPN_DE

#significant DE only
CaH_ALL_SPN_DE_sig = CaH_ALL_SPN_DE[CaH_ALL_SPN_DE$adj.P.Val < 0.05,]
CaH_ALL_IN_DE_sig = CaH_ALL_IN_DE[CaH_ALL_IN_DE$adj.P.Val < 0.05,]
CaH_eSPN_DE_sig = CaH_eSPN_DE[CaH_eSPN_DE$adj.P.Val < 0.05,]
Put_ALL_SPN_DE_sig = Put_ALL_SPN_DE[Put_ALL_SPN_DE$adj.P.Val < 0.05,]
Put_ALL_IN_DE_sig = Put_ALL_IN_DE[Put_ALL_IN_DE$adj.P.Val < 0.05,]
Put_eSPN_DE_sig = Put_eSPN_DE[Put_eSPN_DE$adj.P.Val < 0.05,]

CaH_ALL_SPN_DE_sig
CaH_ALL_IN_DE_sig
CaH_eSPN_DE_sig 
Put_ALL_SPN_DE_sig
Put_ALL_IN_DE_sig
Put_eSPN_DE_sig
```



#From Additional_SPN_scoring
#if you want to plot quantiles or jitter plot look at this file

#SPN-ness score
#Findallmarkers on controls: SPN vs non-SPNs 
```{r}
Idents(caudate_neurons) = "sub_class"
DimPlot(caudate_neurons, label = TRUE)
```

```{r}
caudate_controls = subset(caudate_neurons, subset = Condition == "Control")
caudate_controls
Idents(caudate_controls) = "sub_class"
DimPlot(caudate_controls, label = TRUE)
```

```{r}
Idents(caudate_controls) = caudate_controls$sub_class
caudate_controls_markers = FindAllMarkers(caudate_controls)
                                          #, only.pos = TRUE,  min.pct = 0.2, logfc.threshold = 1.25)
caudate_controls_markers
```


#PUTAMEN Findallmarkers on controls: SPN vs non-SPNs 
```{r}
Idents(putamen_neurons) = "sub_class"
DimPlot(putamen_neurons, label = TRUE)
```

```{r}
putamen_controls = subset(putamen_neurons, subset = Condition == "Control")
putamen_controls
Idents(putamen_controls) = "sub_class"
DimPlot(putamen_controls, label = TRUE)
```
```{r}
Idents(putamen_controls) = putamen_controls$sub_class
putamen_controls_markers = FindAllMarkers(putamen_controls)
                                          #, only.pos = TRUE,  min.pct = 0.2, logfc.threshold = 1.25)
putamen_controls_markers
```


#FROM SPN_Jul_15

```{r}
BICAN_3P_V8_CaH = qread("BICAN_3P_V8_CaH.qs")
#BICAN_5P_V8_CaH = qread("BICAN_5P_V8_CaH.qs")
```


```{r}
caudate_neurons_transformed@meta.data$subcluster = caudate_neurons_transformed@meta.data$sub_class
caudate_neurons_transformed$subcluster[caudate_neurons_transformed$subcluster == "interneuron"] = "non-SPN"
caudate_neurons_transformed$subcluster[caudate_neurons_transformed$subcluster == "eSPN"] = "non-SPN"
caudate_neurons_transformed$subcluster[caudate_neurons_transformed$subcluster == "cholinergic"] = "non-SPN"

caudate_neurons_transformed@meta.data

SPN_cah_transformed= subset(caudate_neurons_transformed, subset = sub_class == "SPN")
non_SPN_cah_transformed= subset(caudate_neurons_transformed, subset = sub_class != "SPN")
SPN_cah_transformed
non_SPN_cah_transformed

```

```{r}

```


#From SPN_Score_Jul22
```{r}
library(qs)
library(Seurat)
library(ggplot2)
library(dplyr)
library(tidyr)
```

```{r}
BICAN_D1_D2_vs_non_markers =  qread("~/SPN_Scores_markers/BICAN_D1_D2_vs_non_markers")
BICAN_patch_matrix_vs_non_markers =  qread("~/SPN_Scores_markers/BICAN_patch_matrix_vs_non_markers")
BICAN_SPN_vs_non_markers= qread("~/SPN_Scores_markers/BICAN_SPN_vs_non_markers.qs")
BICAN_SPN_classes_vs_non_markers =  qread("~/SPN_Scores_markers/BICAN_SPN_classes_vs_non_markers.qs")

BICAN_SPN_vs_non_markers #SPN vs nonSPN
```

```{r}
final_BICAN_SPN_vs_non_markers = subset(BICAN_SPN_vs_non_markers, subset = p_val_adj < 0.05 & cluster == "SPN")
final_BICAN_SPN_vs_non_markers$pct_subtract = final_BICAN_SPN_vs_non_markers$pct.1 - final_BICAN_SPN_vs_non_markers$pct.2
final_BICAN_SPN_vs_non_markers$weighted_logFC = final_BICAN_SPN_vs_non_markers$avg_log2FC * final_BICAN_SPN_vs_non_markers$pct_subtract
final_BICAN_SPN_vs_non_markers
```

```{r}
final_BICAN_SPN_vs_non_markers[final_BICAN_SPN_vs_non_markers$gene == "PPP1R1B",]
```

```{r}
hist(final_BICAN_SPN_vs_non_markers$pct_subtract)
hist(final_BICAN_SPN_vs_non_markers$weighted_logFC)
hist(final_BICAN_SPN_vs_non_markers$avg_log2FC)
```

```{r}
#thinking about additional filtering
# test_final_BICAN_SPN_vs_non_markers = subset(final_BICAN_SPN_vs_non_markers, subset = pct_subtract > 0.5)
# test_final_BICAN_SPN_vs_non_markers
```


```{r}
caudate_neurons
putamen_neurons
```


#SPN-ness score



```{r}
BICAN_3P_V8_CaH_neurons_filtered =  qread("SPN_Scores/BICAN_3P_V8_CaH_neurons_filtered.qs")
```

```{r}
BICAN_3P_V8_CaH_neurons_filtered@meta.data

Idents(BICAN_3P_V8_CaH_neurons_filtered) <- "subcluster"
DimPlot(BICAN_3P_V8_CaH_neurons_filtered, label = TRUE)

Idents(BICAN_3P_V8_CaH_neurons_filtered) <- "sub_class"
DimPlot(BICAN_3P_V8_CaH_neurons_filtered, label = TRUE)

Idents(BICAN_3P_V8_CaH_neurons_filtered) <- "SPN_class"
DimPlot(BICAN_3P_V8_CaH_neurons_filtered, label = TRUE)

Idents(BICAN_3P_V8_CaH_neurons_filtered) <- "D1_D2"
DimPlot(BICAN_3P_V8_CaH_neurons_filtered, label = TRUE)

Idents(BICAN_3P_V8_CaH_neurons_filtered) <- "patch_matrix"
DimPlot(BICAN_3P_V8_CaH_neurons_filtered, label = TRUE)
```

```{r}
BICAN_D1_D2_vs_non_markers =  qread("SPN_Scores/BICAN_D1_D2_vs_non_markers")
BICAN_patch_matrix_vs_non_markers =  qread("SPN_Scores/BICAN_patch_matrix_vs_non_markers")
BICAN_SPN_vs_non_markers= qread("SPN_Scores/BICAN_SPN_vs_non_markers.qs")
BICAN_SPN_classes_vs_non_markers =  qread("SPN_Scores/BICAN_SPN_classes_vs_non_markers.qs")


BICAN_SPN_vs_non_markers #SPN vs nonSPN
BICAN_SPN_classes_vs_non_markers #D1 matrix, D1 patch, D2 matrix, D2 patch vs nonSPN
BICAN_D1_D2_vs_non_markers #D1, D2 vs non SPNS
BICAN_patch_matrix_vs_non_markers# patch, matrix vs nonSPNs
```

```{r}
BICAN_SPN_vs_non_markers_filtered = subset(BICAN_SPN_vs_non_markers, subset = pct.1 >0.7 & pct.2 <0.2 & cluster != "non-SPN")

#I am not getting enough genes here, which is why i decided to do them separately
BICAN_SPN_classes_vs_non_markers_filtered= subset(BICAN_SPN_classes_vs_non_markers, subset = pct.1 >0.7 & pct.2 <0.2 & cluster != "non-SPN")
BICAN_D1_D2_vs_non_markers_filtered = subset(BICAN_D1_D2_vs_non_markers, subset = pct.1 >0.7 & pct.2 <0.2 & cluster != "non-SPN")
BICAN_patch_matrix_vs_non_markers_filtered= subset(BICAN_patch_matrix_vs_non_markers, subset = pct.1 >0.7 & pct.2 <0.2 & cluster != "non-SPN")

BICAN_SPN_vs_non_markers_filtered
BICAN_SPN_classes_vs_non_markers_filtered
BICAN_D1_D2_vs_non_markers_filtered
BICAN_patch_matrix_vs_non_markers_filtered
```

```{r}
D1_matrix_markers= qread("SPN_Scores/D1_matrix_markers.qs")
D1_patch_markers= qread("SPN_Scores/D1_patch_markers.qs")
D2_matrix_markers= qread("SPN_Scores/D2_matrix_markers.qs")
D2_patch_markers= qread("SPN_Scores/D2_patch_markers.qs") 

D1_markers= qread("SPN_Scores/D1_markers.qs")
D2_markers =qread("SPN_Scores/D2_markers.qs")
patch_markers= qread("SPN_Scores/patch_markers.qs")
matrix_markers= qread("SPN_Scores/matrix_markers.qs")

D1_matrix_markers
D1_patch_markers
D2_matrix_markers
D2_patch_markers

D1_markers
D2_markers
patch_markers
matrix_markers
```

```{r}
D1_matrix_markers_filtered = subset(D1_matrix_markers, subset = pct.1 >0.7 & pct.2 <0.2)
D1_patch_markers_filtered= subset(D1_patch_markers, subset = pct.1 >0.7 & pct.2 <0.2)
D2_matrix_markers_filtered= subset(D2_matrix_markers, subset = pct.1 >0.7 & pct.2 <0.2)
D2_patch_markers_filtered= subset(D2_patch_markers, subset = pct.1 >0.7 & pct.2 <0.2)

D1_markers_filtered= subset(D1_markers, subset = pct.1 >0.7 & pct.2 <0.2)
D2_markers_filtered= subset(D2_markers, subset = pct.1 >0.7 & pct.2 <0.2)
patch_markers_filtered= subset(patch_markers, subset = pct.1 >0.7 & pct.2 <0.2)
matrix_markers_filtered= subset(matrix_markers, subset = pct.1 >0.7 & pct.2 <0.2)

D1_matrix_markers_filtered
D1_patch_markers_filtered
D2_matrix_markers_filtered
D2_patch_markers_filtered

D1_markers_filtered
D2_markers_filtered
patch_markers_filtered
matrix_markers_filtered
```





#FROM SPN_JUL26_continue
```{r}
CaH_summary_expr_data = SPN_score(BICAN_SPN_vs_non_markers_filtered, caudate_neurons_transformed,logfc_val = "avg_log2FC")
```

```{r}
donors = c("PCMC-16-011", "PCMC-16-012", "SCF-18-003", "SCF-18-004", "SCF-18-006","SCF-19-009", "SCF-19-014", "SCF-19-018",  "SCF-20-023",  "SCF_20-024", "SCF-20-025", "SCF-21-030", "SCF_22-043", "SCF_21-037CM2","SCF-22-054CM","SCF-22-058CF","SCF-23-068CM")
```

```{r}
CaH_summary_expr_data = SPN_score(BICAN_SPN_vs_non_markers_filtered, caudate_neurons_transformed,logfc_val = "avg_log2FC")
```

```{r}
color1 = c("SPN" = "red", "non-SPN"= "blue") #for subcluster: SPN vs non-SPNS
color2 = c("red", "blue")
color3 = c("SPN"="red", "eSPN"="yellow", "other"="green", "IN" = "blue") #for subclass
```

```{r}
caudate_neurons_transformed@meta.data
SPN_score_graphs(CaH_summary_expr_data, donor_order = donors, fillcol = "subcluster", color = color1, donor_graph_title = "CaH SPNs vs non-SPNs", caudate_neurons_transformed, "BICAN_SPN_score_52genes")
caudate_neurons_transformed@meta.data
```

```{r}
SPN_score_graphs(CaH_summary_expr_data, donor_order = donors, fillcol = "subcluster", color = color1, donor_graph_title = "CaH SPNs vs non-SPNs", caudate_neurons_transformed, "BICAN_SPN_score_52genes")

```


```{r}
merged_xdp = qread("SPN_Scores/merged_xdp_use_this.qs")
merged_xdp@meta.data
```




```{r}
merged_xdp@meta.data$subcluster = merged_xdp$neuron_type
merged_xdp$subcluster[merged_xdp$subcluster == "IN"] = "non-SPN"
merged_xdp$subcluster[merged_xdp$subcluster == "other"] = "non-SPN"
merged_xdp$subcluster[merged_xdp$subcluster == "eSPN"] = "non-SPN"

merged_xdp@meta.data$sub_class = merged_xdp$neuron_type
```



```{r}
merged_xdp@meta.data
#10%: 50.29607
merged_XDP_summary_expr_data = SPN_score(BICAN_SPN_vs_non_markers_filtered, merged_xdp,logfc_val = "avg_log2FC")

merged_xdp= SPN_score_graphs(merged_XDP_summary_expr_data, donor_order = donors, fillcol = "subcluster", color = color1, donor_graph_title = "SPNs vs non-SPNs", merged_xdp, "BICAN_SPN_Score_52genes")

merged_xdp= SPN_score_graphs(merged_XDP_summary_expr_data, donor_order = donors, fillcol = "sub_class", color = color3, donor_graph_title = "SPNs vs non-SPNs", merged_xdp, "BICAN_SPN_Score_52genes")

merged_xdp@meta.data
```


```{r}
final_BICAN_SPN_vs_non_markers = subset(BICAN_SPN_vs_non_markers, subset = p_val_adj < 0.05 & cluster == "SPN")
final_BICAN_SPN_vs_non_markers$pct_subtract = final_BICAN_SPN_vs_non_markers$pct.1 - final_BICAN_SPN_vs_non_markers$pct.2
final_BICAN_SPN_vs_non_markers$weighted_logFC = final_BICAN_SPN_vs_non_markers$avg_log2FC * final_BICAN_SPN_vs_non_markers$pct_subtract
final_BICAN_SPN_vs_non_markers
```


```{r}
merged_xdp@meta.data
#10%: 300.81
merged_XDP_BICAN_pct = SPN_score(final_BICAN_SPN_vs_non_markers, merged_xdp,logfc_val = "weighted_logFC")

merged_xdp= SPN_score_graphs(merged_XDP_BICAN_pct, donor_order = donors, fillcol = "subcluster", color = color1, donor_graph_title = "SPNs vs non-SPNs", merged_xdp, "BICAN_SPN_Score_pct")

SPN_score_graphs(merged_XDP_BICAN_pct, donor_order = donors, fillcol = "sub_class", color = color3, donor_graph_title = "SPNs vs non-SPNs", merged_xdp, "BICAN_SPN_Score_pct")

merged_xdp@meta.data
```

```{r}
table(BICAN_SPN_classes_vs_non_markers$cluster)
```


```{r}
final_BICAN_SPN_classes_vs_non_markers = subset(BICAN_SPN_classes_vs_non_markers, subset = cluster != "non-SPN")
final_BICAN_SPN_classes_vs_non_markers
table(final_BICAN_SPN_classes_vs_non_markers$cluster)
```



```{r}
final_BICAN_SPN_classes_vs_non_markers = subset(final_BICAN_SPN_classes_vs_non_markers, subset = p_val_adj < 0.05)
final_BICAN_SPN_classes_vs_non_markers_unique <- final_BICAN_SPN_classes_vs_non_markers %>%
  distinct(gene, .keep_all = TRUE)
final_BICAN_SPN_classes_vs_non_markers_unique

table(final_BICAN_SPN_classes_vs_non_markers_unique$cluster) #107 is now lowest
```

```{r}
final_BICAN_SPN_classes_vs_non_markers_unique
```


```{r}
final_final_BICAN_SPN_classes_vs_non_markers <- final_BICAN_SPN_classes_vs_non_markers_unique %>%
  group_by(cluster) %>%
  arrange(p_val_adj) %>%
  slice_head(n = 107) %>%
  ungroup()
final_final_BICAN_SPN_classes_vs_non_markers = as.data.frame(final_final_BICAN_SPN_classes_vs_non_markers)
final_final_BICAN_SPN_classes_vs_non_markers
# View the result
rownames(final_final_BICAN_SPN_classes_vs_non_markers)= final_final_BICAN_SPN_classes_vs_non_markers$gene
final_final_BICAN_SPN_classes_vs_non_markers
```



```{r}
final_final_BICAN_SPN_classes_vs_non_markers$pct_subtract = final_final_BICAN_SPN_classes_vs_non_markers$pct.1 - final_final_BICAN_SPN_classes_vs_non_markers$pct.2
final_final_BICAN_SPN_classes_vs_non_markers$weighted_logFC = final_final_BICAN_SPN_classes_vs_non_markers$avg_log2FC * final_final_BICAN_SPN_classes_vs_non_markers$pct_subtract
final_final_BICAN_SPN_classes_vs_non_markers
```




```{r}
merged_xdp@meta.data

merged_XDP_BICAN_pct_SPNclasses = SPN_score(final_final_BICAN_SPN_classes_vs_non_markers, merged_xdp,logfc_val = "weighted_logFC")

merged_xdp= SPN_score_graphs(merged_XDP_BICAN_pct_SPNclasses, donor_order = donors, fillcol = "subcluster", color = color1, donor_graph_title = "SPNs vs non-SPNs", merged_xdp, "BICAN_SPNclasses_Score_pct")

SPN_score_graphs(merged_XDP_BICAN_pct, donor_order = donors, fillcol = "sub_class", color = color3, donor_graph_title = "SPNs vs non-SPNs", merged_xdp, "BICAN_SPNclasses_Score_pct")

merged_xdp@meta.data
```

```{r}
final_BICAN_SPN_classes_vs_non_markers$pct_subtract = final_BICAN_SPN_classes_vs_non_markers$pct.1 - final_BICAN_SPN_classes_vs_non_markers$pct.2
final_BICAN_SPN_classes_vs_non_markers$weighted_logFC = final_BICAN_SPN_classes_vs_non_markers$avg_log2FC * final_BICAN_SPN_classes_vs_non_markers$pct_subtract
final_BICAN_SPN_classes_vs_non_markers
```

```{r}
merged_xdp@meta.data

merged_XDP_BICAN_pct_SPNclasses = SPN_score(final_BICAN_SPN_classes_vs_non_markers, merged_xdp,logfc_val = "weighted_logFC")

merged_xdp= SPN_score_graphs(merged_XDP_BICAN_pct_SPNclasses, donor_order = donors, fillcol = "subcluster", color = color1, donor_graph_title = "SPNs vs non-SPNs", merged_xdp, "BICAN_SPNclasses_Score_pcttest")

#SPN_score_graphs(merged_XDP_BICAN_pct, donor_order = donors, fillcol = "sub_class", color = color3, donor_graph_title = "SPNs vs non-SPNs", merged_xdp, "BICAN_SPNclasses_Score_pcttest")

merged_xdp@meta.data
```












```{r}
DimPlot(merged_xdp, group.by = "RNA_snn_res.0.2")
DimPlot(merged_xdp, group.by = "RNA_snn_res.0.3")
DimPlot(merged_xdp, group.by = "region")
```
```{r}
FeaturePlot(merged_xdp, features =c("CASZ1","CHAT"))
FeaturePlot(merged_xdp, features =c("DRD1", "DRD2"))
FeaturePlot(merged_xdp, features =c("PPP1R1B", "pct_mito"))
FeaturePlot(merged_xdp, features =c("SST", "VIP"))
FeaturePlot(merged_xdp, features =c("GAD1", "GAD2"))
FeaturePlot(merged_xdp, features = c("EPHA4", "SEMA3E"))
FeaturePlot(merged_xdp, features =c("PVALB", "CALB2"))
FeaturePlot(merged_xdp, features =c("SLC17A7", "SLC17A6"))

```





