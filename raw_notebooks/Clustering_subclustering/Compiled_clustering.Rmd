---
title: "R Notebook"
output: html_notebook
---
```{r}
library(Seurat)
library(Matrix)
library(rhdf5)
library(dplyr)
library(qs)
library(ggplot2)
```

```{r}
merged_caudate = qread("Cellbender_seurat/redo2_merged_caudate.qs")
merged_putamen = qread("Cellbender_seurat/redo2_merged_putamen.qs")

merged_caudate
merged_putamen
```

```{r}
filtered_merged_caudate <- subset(merged_caudate, subset = pct_mito < 10 & pct_intronic >= 0.25)
filtered_merged_putamen <- subset(merged_putamen, subset = pct_mito < 10 & pct_intronic >= 0.25)
```

```{r}
filtered_merged_caudate
filtered_merged_putamen
```

#HVG calculation helper function
```{r}
getSeuratVarFeatureIntersectByCol = function(
   seurat_obj,
   subset_col,
   original_nfeatures,
   n_subsets_to_cover=NULL
){
  
   hvgs = list()


   unique_ids = unique(seurat_obj@meta.data[[subset_col]])


   if (is.null(n_subsets_to_cover)){
       n_subsets_to_cover = floor(length(unique_ids)/2)
   }


   i=1
   for (id in unique_ids) {
       print(paste("Subset", id, "--", i, "of", length(unique_ids)))
       i = i + 1
      
       seurat_subset = seurat_obj[, seurat_obj[[subset_col]] == id]
      
       if (ncol(seurat_subset) < 2){next}
      
       suppressWarnings({
           seurat_subset = FindVariableFeatures(
               seurat_subset, nfeatures=original_nfeatures, verbose = FALSE)
       })
      
       hvgs[[id]] = getSeuratVarFeatures(seurat_subset)
      
   }


   common_hvgs = getCommonStrings(hvgs, n_subsets_to_cover)
   print(paste("Number of HVGs in common across", n_subsets_to_cover, "--", length(common_hvgs)))


   return(common_hvgs)
}

```


```{r}
getSeuratVarFeatures = function(sobj){
    # the magical incantation that returns the slot of the attribute of the slot that actually holds the list of variable feature -_-
    return(sobj@assays$RNA@var.features)
}
```

```{r}
getCommonStrings <- function(list_of_lists, n) {
  # Create an empty list to store string occurrences
  string_occurrences <- list()

  # Iterate over each sublist
  for (sublist in list_of_lists) {
    # For each string in the sublist, increment its count in string_occurrences
    for (string in unique(sublist)) {
      if (!is.null(string_occurrences[[string]])) {
        string_occurrences[[string]] <- string_occurrences[[string]] + 1
      } else {
        string_occurrences[[string]] <- 1
      }
    }
  }

  # Filter the strings that occur at least n times
  common_strings <- names(string_occurrences)[string_occurrences >= n]

  return(common_strings)
}
```


```{r}
filtered_merged_caudate@meta.data
```


#Actual Clustering Code- caudate
```{r}
# Counts of super lowly expressed genes are essentially random
# Also, we don't really care about housekeeping genes that have almost the same expression in every cell
# Before clustering, we want to find "highly variable genes" (hvgs) that tend to be both highly expressed and vary a lot from cell to cell.
# we do this by finding hvgs in each participant individually, and collating the genes
# that are highly variable in at least half of donors.


# this code should take 3-10 minutes
hvgs = getSeuratVarFeatureIntersectByCol(filtered_merged_caudate, subset_col="donor_id", original_nfeatures=2500)


n_dims_use=20


# now cluster
# the "%>%" lines are a little piece of syntax from the dyplr library,
# short for "apply the following transformation to the object"
# doing this line-by-line allows us to apply a sequence of transformations
filtered_merged_caudate = (filtered_merged_caudate
   %>% NormalizeData() # log normalizes raw counts
   %>% ScaleData(features=hvgs, split.by="donor_id") # within each cell, for each gene scale the data (i.e. subtract the donor's mean and divide by the donor's standard deviation of that gene)
   %>% RunPCA(features=hvgs, npcs=n_dims_use) # Reduce the dimensions to the n_dims_use dimensions that best explain the data https://en.wikipedia.org/wiki/Principal_component_analysis
   %>% FindNeighbors(dims = 1:n_dims_use) # Finds every cells closest neighbors in the PCA space
   %>% FindClusters(resolution = 0.2) # finds clusters at a variety of resolutions
   %>% FindClusters(resolution = 0.3) # after clustering, the cluster labels are accessible via filtered_merged_caudate$RNA_snn_res.{resolution}
   %>% FindClusters(resolution = 0.4) # e.g.: filtered_merged_caudate$RNA_snn_res.0.4 here
   %>% FindClusters(resolution = 0.5)
   %>% FindClusters(resolution = 0.6)
   %>% FindClusters(resolution = 0.7)
   %>% FindClusters(resolution = 0.8)
   %>% FindClusters(resolution = 0.9)
   %>% FindClusters(resolution = 1)
   %>% RunUMAP(dims = 1:n_dims_use) # projects the PCA onto 2 dimensions, such that both "global structure" and "local structure" are optimally preserved
)


# Now we can plot the data and just see what it looks like


setwh = function(w, h){
   # set the width of the ensuing figures to w, height to h
   options(repr.plot.width = w, repr.plot.height = h)
}




DimPlot(filtered_merged_caudate, group.by = "library", label=T) # are there library batch effects?
DimPlot(filtered_merged_caudate, group.by = "donor_id", label=T) # are there donor batch effects?
DimPlot(filtered_merged_caudate, group.by = "Condition") # change col name to whatever your case control metadata column is
DimPlot(filtered_merged_caudate, group.by = "RNA_snn_res.0.5", label=T) # make a few of these for different resolutions


#qsave(filtered_merged_caudate, "somewhere/cozy")

```

```{r}
DimPlot(filtered_merged_caudate, group.by = "library") # are there library batch effects?
DimPlot(filtered_merged_caudate, group.by = "donor_id") # are there donor batch effects?
DimPlot(filtered_merged_caudate, group.by = "Condition") # change col name to whatever your case control metadata column is
DimPlot(filtered_merged_caudate, group.by = "RNA_snn_res.0.5", label=T) # make a few of these for different resolutions


qsave(filtered_merged_caudate, "Cellbender_seurat/filtered_merged_caudate_clustered.qs")
```
#clustering for putamen
```{r}
# Counts of super lowly expressed genes are essentially random
# Also, we don't really care about housekeeping genes that have almost the same expression in every cell
# Before clustering, we want to find "highly variable genes" (hvgs) that tend to be both highly expressed and vary a lot from cell to cell.
# we do this by finding hvgs in each participant individually, and collating the genes
# that are highly variable in at least half of donors.


# this code should take 3-10 minutes
hvgs = getSeuratVarFeatureIntersectByCol(filtered_merged_putamen, subset_col="donor_id", original_nfeatures=2500)


n_dims_use=20


# now cluster
# the "%>%" lines are a little piece of syntax from the dyplr library,
# short for "apply the following transformation to the object"
# doing this line-by-line allows us to apply a sequence of transformations
filtered_merged_putamen = (filtered_merged_putamen
   %>% NormalizeData() # log normalizes raw counts
   %>% ScaleData(features=hvgs, split.by="donor_id") # within each cell, for each gene scale the data (i.e. subtract the donor's mean and divide by the donor's standard deviation of that gene)
   %>% RunPCA(features=hvgs, npcs=n_dims_use) # Reduce the dimensions to the n_dims_use dimensions that best explain the data https://en.wikipedia.org/wiki/Principal_component_analysis
   %>% FindNeighbors(dims = 1:n_dims_use) # Finds every cells closest neighbors in the PCA space
   %>% FindClusters(resolution = 0.2) # finds clusters at a variety of resolutions
   %>% FindClusters(resolution = 0.3) # after clustering, the cluster labels are accessible via filtered_merged_putamen$RNA_snn_res.{resolution}
   %>% FindClusters(resolution = 0.4) # e.g.: filtered_merged_putamen$RNA_snn_res.0.4 here
   %>% FindClusters(resolution = 0.5)
   %>% FindClusters(resolution = 0.6)
   %>% FindClusters(resolution = 0.7)
   %>% FindClusters(resolution = 0.8)
   %>% FindClusters(resolution = 0.9)
   %>% FindClusters(resolution = 1)
   %>% RunUMAP(dims = 1:n_dims_use) # projects the PCA onto 2 dimensions, such that both "global structure" and "local structure" are optimally preserved
)


# Now we can plot the data and just see what it looks like


setwh = function(w, h){
   # set the width of the ensuing figures to w, height to h
   options(repr.plot.width = w, repr.plot.height = h)
}




DimPlot(filtered_merged_putamen, group.by = "library", label=T) # are there library batch effects?
DimPlot(filtered_merged_putamen, group.by = "donor_id", label=T) # are there donor batch effects?
DimPlot(filtered_merged_putamen, group.by = "Condition") # change col name to whatever your case control metadata column is
DimPlot(filtered_merged_putamen, group.by = "RNA_snn_res.0.3", label=T) # make a few of these for different resolutions

DimPlot(filtered_merged_putamen, group.by = "library") # are there library batch effects?
DimPlot(filtered_merged_putamen, group.by = "donor_id") # are there donor batch effects?

qsave(filtered_merged_putamen, "Cellbender_seurat/filtered_merged_putamen_clustered.qs")
```



```{r}
DimPlot(filtered_merged_caudate, group.by = "RNA_snn_res.0.2", label=T)
DimPlot(filtered_merged_putamen, group.by = "RNA_snn_res.0.2", label=T)
```

```{r}
FeaturePlot(filtered_merged_caudate, features = c("TAF1"))
FeaturePlot(filtered_merged_putamen, features = c("TAF1"))
```

```{r}
feature_caudate_plots = FeaturePlot(filtered_merged_caudate, features = c("SYT1", "AQP4", "C1QA", "FLT1", "OLIG1", "OLIG2", "CD96", "ADGB"))

ggsave(filename = "graphs_to_export/featureplot_caudate.png", plot= feature_caudate_plots)
```


```{r}
Idents(filtered_merged_caudate) = filtered_merged_caudate$RNA_snn_res.0.2
markers = FindAllMarkers(filtered_merged_caudate, only.pos = TRUE, min.pct = 0.2, logfc.threshold = 1)
```


```{r}
normalizeScalePcaClusterUmap = function(
   sobj,
   subset_col="donor_id",
   n_hvgs_orig=2500,
   n_dims_use=20,
   resolutions=c(0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)){
   # this function takes a Seurat object, normalizes the data, scales the data, runs PCA, finds neighbors,
   # clusters at a variety of resolutions, and runs UMAP
   # it then returns the Seurat object
  
   hvgs = getSeuratVarFeatureIntersectByCol(sobj, subset_col=subset_col, original_nfeatures=n_hvgs_orig)
   sobj = (sobj
       %>% NormalizeData()
       %>% ScaleData(features=hvgs, split.by=subset_col)
       %>% RunPCA(features=hvgs, npcs=n_dims_use)
       %>% FindNeighbors(dims = 1:n_dims_use)
   )
   for(res in resolutions){
       sobj = sobj %>% FindClusters(resolution = res)
   }
    sobj = sobj %>% RunUMAP(dims = 1:n_dims_use)
   return(sobj)
}
```


```{r}
printMarkersByCluster = function(marker_df, marker_tsv="Cellbender_seurat/all_markers.tsv", cluster=NULL){
   broad_markers = read.table(marker_tsv, header = TRUE, sep = "\t")
   broad_markers$Gene = toupper(broad_markers$Gene)


   broad_markers['broad_class'] = NA
   broad_markers$broad_class[grepl('microglia', tolower(broad_markers$pattern))] = 'microglia'
   broad_markers$broad_class[grepl('neuron', tolower(broad_markers$pattern))] = 'neuron'
   broad_markers$broad_class[grepl('astrocyte', tolower(broad_markers$pattern))] = 'astrocyte'
   broad_markers$broad_class[grepl('oligodendrocyte', tolower(broad_markers$pattern))] = 'oligo'
   broad_markers$broad_class[grepl('endothelial', tolower(broad_markers$pattern))] = 'endo'
   broad_markers$broad_class[grepl('mural', tolower(broad_markers$pattern))] = 'endo'
   broad_markers$broad_class[grepl('fibro', tolower(broad_markers$pattern))] = 'fibroblast'
   broad_markers$broad_class[grepl('ependymal', tolower(broad_markers$pattern))] = 'ependymal' 
   broad_markers$broad_class[grepl('opc', tolower(broad_markers$pattern))] = 'opc'
   broad_markers$broad_class[grepl('polydendro', tolower(broad_markers$pattern))] = 'opc'
   broad_markers$broad_class[grepl('b_cell', tolower(broad_markers$pattern))] = 'immune'
   broad_markers$broad_class[grepl('t_cell', tolower(broad_markers$pattern))] = 'immune'
   broad_markers$broad_class[grepl('neutro', tolower(broad_markers$pattern))] = 'immune'
   broad_markers$broad_class[grepl('nk_cell', tolower(broad_markers$pattern))] = 'immune'
   broad_markers = broad_markers[!is.na(broad_markers$broad_class), c('Gene', 'broad_class')]


   broad_markers_ordered = broad_markers[order(broad_markers$broad_class),]


   # Merge broad_markers_ordered with markers
   broad_markers_ordered = merge(
       broad_markers_ordered, marker_df, by.x = "Gene", by.y="gene", all.x = TRUE)


   # Order by broad_class and cluster
   broad_markers_ordered = broad_markers_ordered[
       order(broad_markers_ordered$broad_class,
       broad_markers_ordered$Gene, broad_markers_ordered$cluster),]


   if (!is.null(cluster)){
       broad_markers_ordered = broad_markers_ordered[broad_markers_ordered$cluster == cluster,]
       broad_markers_ordered = broad_markers_ordered[complete.cases(broad_markers_ordered),]
   }
   broad_markers_ordered$pct.1 = round(broad_markers_ordered$pct.1, 2)
   broad_markers_ordered$pct.2 = round(broad_markers_ordered$pct.2, 2)
   broad_markers_ordered$avg_log2FC = round(broad_markers_ordered$avg_log2FC, 2)
   print(broad_markers_ordered[,
       c("Gene", "broad_class", "cluster", "avg_log2FC", "pct.1", "pct.2")], row.names=FALSE)
}
```


```{r}
#doublecheck ******
num_clusters = length(unique(Idents(filtered_merged_caudate))) - 1

for (i in 0:num_clusters){
   printMarkersByCluster(markers, cluster=i)
}


```

```{r}
assignCellClasses = function(
   obj,
   classes,
   cluster_col="seurat_clusters",
   class_col="cell_class") {
   obj@meta.data[[class_col]] = NA  # Assign NA to the entire column in meta.data


   for (i in 1:length(classes)) {
       # Find cells that match the current cluster number
       cells = which(as.numeric(obj@meta.data[[cluster_col]]) == i)
     
       # Assign the class label to the cells in the cluster
       obj@meta.data[cells, class_col] = classes[[i]]
   }
  
   # Return the modified object
   return(obj)
}
```

```{r}
#classes = c("Neuron/oligo", "Neuron/oligo", "astrocyte", "unknown", "microglia", "oligo", "astrocyte", "neuron", "neuron", "astrocyte", "opc", "neuron", "oligo", "endo", "microglia/oligo", "ependymal", "neuron", "neuron", "neuron", "immune")

classes = c("oligo", "oligo", "astrocyte", "oligo", "microglia", "oligo", "astrocyte", "neuron", "neuron", "astrocyte", "opc", "neuron", "oligo", "endo", "oligo", "ependymal", "oligo", "neuron", "neuron", "immune")


filtered_merged_caudate = assignCellClasses(filtered_merged_caudate, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "cell_class")

```

```{r}
normalizeScalePcaClusterUmap(filtered_merged_caudate) # what is this
```


```{r}
Idents(filtered_merged_caudate) <- "cell_class"
DimPlot(filtered_merged_caudate, label = TRUE)
```





```{r}
Idents(filtered_merged_putamen) = filtered_merged_putamen$RNA_snn_res.0.2
markers = FindAllMarkers(filtered_merged_putamen, only.pos = TRUE, min.pct = 0.2, logfc.threshold = 1)
```

```{r}
#doublecheck ******
num_clusters = length(unique(Idents(filtered_merged_putamen))) - 1

for (i in 0:num_clusters){
   printMarkersByCluster(markers, cluster=i)
}

```

```{r}
#classes = c("oligo?", "neuron", "astrocyte", "neuron", "neuron/oligo", "microglia", "neuron", "oligo", "opc", "oligo", "neuron", "neuron", "astrocyte", "neuron", "neuron", "neuron/oligo", "endo", "neuron", "neuron", "neuron", "oligo", "neuron")

#second one is neuron but looks like it would cluster as an oligo?
classes = c("oligo", "oligo", "astrocyte", "neuron", "oligo", "microglia", "neuron", "oligo", "opc", "oligo", "neuron", "neuron", "astrocyte", "neuron", "neuron", "oligo", "endo", "neuron", "neuron", "neuron", "oligo", "neuron")

filtered_merged_putamen = assignCellClasses(filtered_merged_putamen, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "cell_class")

Idents(filtered_merged_putamen) <- "cell_class"
DimPlot(filtered_merged_putamen, label = TRUE)
```


```{r}
Idents(filtered_merged_caudate) = filtered_merged_caudate$RNA_snn_res.0.5
markers = FindAllMarkers(filtered_merged_caudate, only.pos = TRUE, min.pct = 0.2, logfc.threshold = 1.25)
```

```{r}
num_clusters = length(unique(Idents(filtered_merged_caudate))) - 1

for (i in 0:num_clusters){
   printMarkersByCluster(markers, cluster=i)
}
```





```{r}
filtered_merged_caudate = qread("Cellbender_seurat/filtered_merged_caudate_clustered.qs")
filtered_merged_putamen = qread("Cellbender_seurat/filtered_merged_putamen_clustered.qs")

Idents(filtered_merged_putamen) = filtered_merged_putamen$RNA_snn_res.0.5
markers = FindAllMarkers(filtered_merged_putamen, only.pos = TRUE, min.pct = 0.2, logfc.threshold = 1.25)
```
```{r}
#doublecheck ******
num_clusters = length(unique(Idents(filtered_merged_putamen))) - 1

for (i in 0:num_clusters){
   printMarkersByCluster(markers, cluster=i)
}

```
```{r}
classes = c("0", "astrocyte", "2", "3", "neuron", "neuron", "microglia", "NO", "9", "opc", "neuron", "neuron", "astrocyte", "14", "neuron", "16", "astrocyte", "neuron", "oligo", "endo", "neuron", "neuron", "23", "neuron", "neuron", "neuron", "oligo", "28", "neuron", "neuron")
  

filtered_merged_putamen = assignCellClasses(filtered_merged_putamen, classes=classes, cluster_col="RNA_snn_res.0.5", class_col = "cell_class")

Idents(filtered_merged_putamen) <- "cell_class"
DimPlot(filtered_merged_putamen, label = TRUE)
```

```{r}
Idents(filtered_merged_putamen) = filtered_merged_putamen$RNA_snn_res.0.3
markers = FindAllMarkers(filtered_merged_putamen, only.pos = TRUE, min.pct = 0.2, logfc.threshold = 1.25)
```




```{r}
feature_putamen_plots = FeaturePlot(filtered_merged_putamen, features = c("SYT1", "AQP4", "C1QA", "FLT1", "OLIG1", "OLIG2", "CD96", "ADGB"))

ggsave(filename = "graphs_to_export/featureplot_putamen.png", plot= feature_putamen_plots)
```


```{r}
#data(filtered_merged_caudate)
classes = c("oligo", "oligo", "astrocyte", "oligo", "microglia", "oligo", "astrocyte", "neuron", "neuron", "astrocyte", "opc", "neuron", "oligo", "endo", "oligo", "ependymal", "neuron", "neuron", "neuron", "immune")

filtered_merged_caudate = assignCellClasses(filtered_merged_caudate, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "cell_class")

Idents(filtered_merged_caudate) <- "cell_class"
cd_genes <- c("TAF1")
Dotplot_caudate = DotPlot(object = filtered_merged_caudate, features = cd_genes)
Dotplot_caudate  <- Dotplot_caudate  + theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Display the plot
print(Dotplot_caudate)

#ggsave(filename = "graphs_to_export/dotplot_caudate.png", plot= Dotplot_caudate )
```

```{r}
filtered_merged_caudate= qread("Cellbender_seurat/filtered_merged_putamen_clustered.qs")
filtered_merged_putamen =qread("Cellbender_seurat/filtered_merged_putamen_clustered.qs")
```


```{r}
classes = c("oligo", "oligo", "astrocyte", "neuron", "oligo", "microglia", "neuron", "oligo", "opc", "oligo", "neuron", "neuron", "astrocyte", "neuron", "neuron", "oligo", "endo", "neuron", "neuron", "neuron", "oligo", "neuron")

filtered_merged_putamen = assignCellClasses(filtered_merged_putamen, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "cell_class")

Idents(filtered_merged_putamen) <- "cell_class"
cd_genes <- c("SYT1", "AQP4", "C1QA", "FLT1", "OLIG1", "OLIG2", "CD96", "ADGB")
Dotplot_putamen = DotPlot(object = filtered_merged_putamen, features = cd_genes)
Dotplot_putamen  <- Dotplot_putamen  + theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Display the plot
print(Dotplot_putamen)
```


```{r}
classes = c("oligo", "oligo", "astrocyte", "neuron", "oligo", "microglia", "neuron", "oligo", "opc", "oligo", "neuron", "neuron", "astrocyte", "neuron", "neuron", "oligo", "endo", "neuron", "neuron", "neuron", "oligo", "neuron")

filtered_merged_putamen = assignCellClasses(filtered_merged_putamen, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "cell_class")

Idents(filtered_merged_putamen) <- "cell_class"
cd_genes <- c("TAF1")
Dotplot_putamen = DotPlot(object = filtered_merged_putamen, features = cd_genes)
Dotplot_putamen  <- Dotplot_putamen  + theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Display the plot
print(Dotplot_putamen)

```
```{r}
classes = c("oligo", "oligo", "astrocyte", "oligo", "microglia", "oligo", "astrocyte", "neuron", "neuron", "astrocyte", "opc", "neuron", "oligo", "endo", "oligo", "ependymal", "oligo", "neuron", "neuron", "immune")

filtered_merged_caudate = assignCellClasses(filtered_merged_caudate, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "cell_class")

Idents(filtered_merged_caudate) <- "cell_class"
cd_genes <- c("TAF1")
Dotplot_caudate = DotPlot(object = filtered_merged_caudate, features = cd_genes)
Dotplot_caudate  <- Dotplot_caudate  + theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Display the plot
print(Dotplot_caudate)
```

```{r}

```



---
title: "R Notebook"
output: html_notebook
---

```{r}
library(Seurat)
library(Matrix)
library(rhdf5)
library(dplyr)
library(qs)
library(ggplot2)
```

```{r}
filtered_merged_caudate = qread("Cellbender_seurat/filtered_merged_caudate_clustered.qs")
filtered_merged_putamen = qread("Cellbender_seurat/filtered_merged_putamen_clustered.qs")

filtered_merged_caudate
filtered_merged_putamen
```

```{r}
table(filtered_merged_caudate@meta.data$RNA_snn_res.0.5)
```

```{r}
DimPlot(filtered_merged_caudate, group.by = "RNA_snn_res.0.5")
DimPlot(filtered_merged_putamen, group.by = "RNA_snn_res.0.5")
```

```{r}
assignCellClasses = function(
   obj,
   classes,
   cluster_col="seurat_clusters",
   class_col="cell_class") {
   obj@meta.data[[class_col]] = NA  # Assign NA to the entire column in meta.data


   for (i in 1:length(classes)) {
       # Find cells that match the current cluster number
       cells = which(as.numeric(obj@meta.data[[cluster_col]]) == i)
     
       # Assign the class label to the cells in the cluster
       obj@meta.data[cells, class_col] = classes[[i]]
   }
  
   # Return the modified object
   return(obj)
}

```

```{r}

#classes = c("oligo?", "oligo?", "oligo?", "microglia", "oligo?", "oligo?", "astrocyte", "astrocyte", "astrocyte", "astrocyte", "neuron1", "opc", "oligo", "neuron2", "Fneuron3", "neuron4", "oligo?", "oligo?", "endothelial", "ependymal", "oligo", "neuronGAD5", "neuronGAD6", "astrocyte", "immune", "oligo?")

classes = c("oligo", "oligo", "oligo", "microglia", "oligo", "oligo", "astrocyte", "astrocyte", "astrocyte", "astrocyte", "SPN1", "opc", "oligo", "SPN2", "SPN3", "interneuron1 or D1 SPN?", "oligo", "oligo", "endothelial", "ependymal", "oligo", "interneuron2", "interneuron3", "astrocyte", "immune", "oligo")

#neuron6-interneuorn?
#neuorn1-3- SPN?
#4-5- interneuorn?

filtered_merged_caudate = assignCellClasses(filtered_merged_caudate, classes=classes, cluster_col="RNA_snn_res.0.5", class_col = "cell_class")

Idents(filtered_merged_caudate) <- "cell_class"
DimPlot(filtered_merged_caudate, label = TRUE)
```

```{r}
FeaturePlot(filtered_merged_caudate, features = c("LAMP5", "PVALB"))
FeaturePlot(filtered_merged_caudate, features = c("VIP", "LAMP5"))
FeaturePlot(filtered_merged_caudate, features = c("GAD1", "GAD2"))
FeaturePlot(filtered_merged_caudate, features = c("DRD1", "DRD2"))
FeaturePlot(filtered_merged_caudate, features = c("SST", "CALB2"))

FeaturePlot(filtered_merged_caudate, features = c("CUX2", "SATB2"))
FeaturePlot(filtered_merged_caudate, features = c("SLC17A7", "SLC17A6"))
```

```{r}
FeaturePlot(filtered_merged_caudate, features =c("EPHA4", "SEMA3E"))
FeaturePlot(filtered_merged_caudate, features =c("CASZ1"))

```



```{r}
#FeaturePlot(filtered_merged_caudate, features = c("SYT1", "AQP4", "C1QA", "FLT1", "OLIG1", "OLIG2", "CD96", "ADGB", "GAD1", "GAD2", "MOBP", "DRD1", "DRD2"))

FeaturePlot(filtered_merged_caudate, features = c("GAD1", "GAD2", "MOBP", "DRD1", "DRD2"))
```

```{r}
table(Idents(filtered_merged_caudate))
```


```{r}
unsure_clusters = c("oligo")
unsure_subset = subset(filtered_merged_caudate, idents = unsure_clusters)

oligo_poly_opc_markers = c("MBP", "MOG", "PLP", "CSPG4", "OLIG2")

VlnPlot(unsure_subset, features = oligo_poly_opc_markers, group.by = idents)


```


```{r}
table(filtered_merged_caudate$cell_class, filtered_merged_caudate$donor_id)
```

#resolution too high?
```{r}
#classes = c("m/n/o1", "astrocyte", "neuron1", "m/n/o2", "m/n/o3", "neuron2", "neuron3", "microglia", "oligo", "oligo", "opc", "neuron4", "neuron5", "astrocyte", "m/n/o4", "neuron6", "m/n/o5", "astrocyte", "neuron7", "oligo", "endo", "neuron8", "m/n/o6", "m/n/o7", "neuron9", "neuron10", "neuron11","oligo", "neuron12", "immune","neuron13")

classes = c("oligo", "astrocyte", "SPN", "oligo", "oligo", "oligo", "SPN", "microglia", "oligo", "oligo", "opc", "SPN", "SPN", "astrocyte", "oligo", "SPN", "oligo", "astrocyte", "SPN", "oligo", "endo", "glutamatergic", "oligo", "oligo", "interneuron", "SPN", "cortical","oligo", "SPN", "immune","SPN")
  

#neuron 1/5/10/12/13? = SPN/DRD2
#neuron 3/4/6/7 = SPN/DRD1
#neuron 9 - Interneuron/GAD1
#neuron 8 - glut
#neuron11- cortical projection
filtered_merged_putamen = assignCellClasses(filtered_merged_putamen, classes=classes, cluster_col="RNA_snn_res.0.5", class_col = "cell_class")

Idents(filtered_merged_putamen) <- "cell_class"
DimPlot(filtered_merged_putamen, label = TRUE)
```
```{r}
FeaturePlot(filtered_merged_putamen, features = c("SYT1", "RBFOX3", "GAD2", "SLC17A6")) #neuron
FeaturePlot(filtered_merged_putamen, features = c("AQP4", "GINS3", "GFAP")) #astrocytes
FeaturePlot(filtered_merged_putamen, features = c("C1Q4", "C1QB", "CX3CR1", "P2RY12")) #microglia
FeaturePlot(filtered_merged_putamen, features = c("FLT1", "DCN", "RGS5")) #endo
FeaturePlot(filtered_merged_putamen, features = c("OLIG1", "MOG", "MOBP")) #oligo
FeaturePlot(filtered_merged_putamen, features = c("OLIG2", "VCAN")) #opc
```

```{r}
FeaturePlot(filtered_merged_putamen, features = c("LAMP5", "PVALB"))
FeaturePlot(filtered_merged_putamen, features = c("VIP", "LAMP5"))
FeaturePlot(filtered_merged_putamen, features = c("GAD1", "GAD2"))
FeaturePlot(filtered_merged_putamen, features = c("DRD1", "DRD2"))
FeaturePlot(filtered_merged_putamen, features = c("SST", "CALB2"))

FeaturePlot(filtered_merged_putamen, features = c("CUX2", "SATB2"))
FeaturePlot(filtered_merged_putamen, features = c("SLC17A7", "SLC17A6"))
```

```{r}
DimPlot(filtered_merged_putamen,group.by = "RNA_snn_res.0.2")
DimPlot(filtered_merged_putamen,group.by = "RNA_snn_res.0.3")
DimPlot(filtered_merged_putamen,group.by = "RNA_snn_res.0.4")
DimPlot(filtered_merged_putamen,group.by = "RNA_snn_res.0.5")
```



```{r}
Idents(filtered_merged_putamen) = filtered_merged_putamen$RNA_snn_res.0.3
markers = FindAllMarkers(filtered_merged_putamen, only.pos = TRUE, min.pct = 0.2, logfc.threshold = 1.25)

num_clusters = length(unique(Idents(filtered_merged_putamen))) - 1

for (i in 0:num_clusters){
   printMarkersByCluster(markers, cluster=i)
}
```


```{r}
#classes = c("oligo", "oligo", "astrocyte", "neuron1", "neuron2","neuron3", "microglia", "neuron4", "oligo", "opc", "neuron5", "neuron6", "astrocyte", "neuron7", "oligo", "oligo", "oligo", "astrocyte", "neuron8", "endo", "neuron9", "oligo", "neuron10", "neuron11", "neuron12", "oligo", "neuron13", "astrocyte")

classes = c("oligo", "oligo", "astrocyte", "SPN", "oligo","oligo", "microglia", "SPN", "oligo", "opc", "SPN", "SPN", "astrocyte", "SPN", "oligo", "oligo", "oligo", "astrocyte", "interneuron", "endo", "glutamatergic", "oligo", "interneuron", "SPN", "interneuron", "oligo", "SPN", "astrocyte")

#neuron2-3: actually oligo?
#neuron10: interneuon
#neuron9: glutamtergic
#neuron1/6/11: SPN/DRD2
#neuorn4/5/13/7- SPN/DRD1
#neuron8/12- interneuron?

filtered_merged_putamen = assignCellClasses(filtered_merged_putamen, classes=classes, cluster_col="RNA_snn_res.0.3", class_col = "cell_class")

Idents(filtered_merged_putamen) <- "cell_class"
DimPlot(filtered_merged_putamen, label = TRUE)
```
```{r}
FeaturePlot(filtered_merged_putamen, features = c("DRD1", "TAC1", "PDYN"))
FeaturePlot(filtered_merged_putamen, features = c("DRD2", "PENK", "ADCY5"))
FeaturePlot(filtered_merged_putamen, features = c("GAD1", "GAD2"))
FeaturePlot(filtered_merged_putamen, features = c("PVALB", "VIP"))
FeaturePlot(filtered_merged_putamen, features = c("SST", "CALB2"))
FeaturePlot(filtered_merged_putamen, features = c("SLC17A7", "SLC17A6", "CAMK2A"))

```
```{r}
table(Idents(filtered_merged_putamen))
```
```{r}
qsave(filtered_merged_caudate, "Cellbender_seurat/clustered_caudate.qs")
qsave(filtered_merged_putamen, "Cellbender_seurat/clustered_putamen.qs")
```


```{r}
filtered_merged_caudate = qread("Cellbender_seurat/clustered_caudate.qs")
filtered_merged_putamen = qread("Cellbender_seurat/clustered_putamen.qs")

filtered_merged_putamen
filtered_merged_caudate
```


```{r}
table(filtered_merged_caudate@meta.data$cell_class, filtered_merged_caudate@meta.data$donor_id)
```

```{r}
filtered_merged_caudate@meta.data
```


```{r}
median_umis_per_celltype = filtered_merged_caudate@meta.data %>%
  group_by(donor_id, cell_class) %>%
  summarize(median_umi = median(nUmi, na.rm = TRUE), .groups = 'drop')

median_umis_per_celltype 


median_umis_per_celltype = as.data.frame(median_umis_per_celltype)
median_umis_per_celltype

caudate_SPN_mumi = median_umis_per_celltype %>% filter(median_umis_per_celltype$cell_class == "SPN")
caudate_SPN_mumi
```



```{r}
median_umis_per_celltype2 = filtered_merged_putamen@meta.data %>%
  group_by(donor_id, cell_class) %>%
  summarize(median_umi = median(nUmi, na.rm = TRUE), .groups = 'drop')

median_umis_per_celltype2 = as.data.frame(median_umis_per_celltype2)
median_umis_per_celltype2 

putamen_SPN_mumi = median_umis_per_celltype2 %>% filter(median_umis_per_celltype2$cell_class == "SPN")
putamen_SPN_mumi

```

```{r}
SPN_mUMIs = merge(caudate_SPN_mumi, putamen_SPN_mumi, by = "donor_id")
SPN_mUMIs
                  
```
```{r}
SPN_mUMIs$caudate_mumis = SPN_mUMIs$median_umi.x
SPN_mUMIs$median_umi.x = NULL
SPN_mUMIs$putamen_mumis = SPN_mUMIs$median_umi.y
SPN_mUMIs$median_umi.y = NULL

SPN_mUMIs
```

```{r}
SPN_mUMIs$cell_class.y = NULL
SPN_mUMIs
```

```{r}
donor_metadata = read.csv("Cellbender_seurat/Donor_metadata.csv")
donor_metadata
```

```{r}
newmetadata = merge(SPN_mUMIs, donor_metadata, by.x = "donor_id", by.y = "Donor.ID")
newmetadata
```



```{r}
cortest <- cor.test(SPN_mUMIs$caudate_mumis, SPN_mUMIs$putamen_mumis, method = "spearman", exact = FALSE )
cortest
cor <- cortest$estimate
pvalue <- cortest$p.value
subtitle <- paste("Spearman correlation: ", sprintf("%0.3f", cor), " R^2: ", sprintf("%0.3f", cor^2), " p-value: ", sprintf("%0.4f", pvalue))

ggplot(data = SPN_mUMIs, aes(x =SPN_mUMIs$caudate_mumis, y = SPN_mUMIs$putamen_mumis,  color = SPN_mUMIs$donor_id)) + 
  geom_point() +  labs(x="CaH mUMIs" , y= "Put mUMIs") + geom_smooth(method = "lm", se = FALSE, color = "black") + ggtitle("Caudate vs Putamen mUMIs", subtitle = subtitle) + scale_color_discrete(name = "Donor ID")
```


```{r}
spearman_plot = function(data,x,y,id,xlabel, ylabel, title, legendname){
  

cortest <- cor.test(x, y, method = "spearman", exact = FALSE )
cortest
cor <- cortest$estimate
pvalue <- cortest$p.value
subtitle <- paste("Spearman correlation: ", sprintf("%0.3f", cor), " R^2: ", sprintf("%0.3f", cor^2), " p-value: ", sprintf("%0.4f", pvalue))

ggplot(data = data, aes(x =x, y = y,  color = id)) + 
  geom_point() +  labs(x=xlabel , y= ylabel) + geom_smooth(method = "lm", se = FALSE, color = "black") + ggtitle(title, subtitle = subtitle) + scale_color_discrete(name = legendname)

}
```


```{r}
spearman_plot(SPN_mUMIs, SPN_mUMIs$caudate_mumis, SPN_mUMIs$putamen_mumis, SPN_mUMIs$donor_id, "CaH SPN mUMIs", "Put SPN mUMIs", "CaH vs Put SPN mUMIS", "Donors")
```


```{r}
spearman_plot(newmetadata, newmetadata$RQS, newmetadata$caudate_mumis, newmetadata$donor_id, "RQS", "CaH SPN mUMIs", "CaH SPN mUMIS vs RQS", "Donors")
spearman_plot(newmetadata, newmetadata$DV200,newmetadata$caudate_mumis,  newmetadata$donor_id, "DV200",  "CaH SPN mUMIs", "CaH SPN mUMIS vs DV200", "Donors")
spearman_plot(newmetadata,  newmetadata$MQS_numerical, newmetadata$caudate_mumis,  newmetadata$donor_id, "Purkinje MQS", "CaH SPN mUMIs", "CaH SPN mUMIS vs MQS", "Donors")

spearman_plot(newmetadata,  newmetadata$RQS,newmetadata$putamen_mumis, newmetadata$donor_id, "RQS","Put SPN mUMIs", "Put SPN mUMIS vs RQS", "Donors")
spearman_plot(newmetadata, newmetadata$DV200,newmetadata$putamen_mumis, newmetadata$donor_id,  "DV200","Put SPN mUMIs", "Put SPN mUMIS vs DV200", "Donors")
spearman_plot(newmetadata, newmetadata$MQS_numerical,newmetadata$putamen_mumis, newmetadata$donor_id, "Purkinje MQS", "Put SPN mUMIs", "Put SPN mUMIS vs MQS", "Donors")
```

```{r}

```




---
title: "R Notebook"
output: html_notebook
---

```{r}
library(Seurat)
library(Matrix)
library(rhdf5)
library(dplyr)
library(qs)
library(ggplot2)
```

```{r}
filtered_merged_caudate = qread("Cellbender_seurat/filtered_merged_caudate_clustered.qs")
filtered_merged_putamen = qread("Cellbender_seurat/filtered_merged_putamen_clustered.qs")

filtered_merged_caudate
filtered_merged_putamen
```

```{r}
assignCellClasses = function(
   obj,
   classes,
   cluster_col="seurat_clusters",
   class_col="cell_class") {
   obj@meta.data[[class_col]] = NA  # Assign NA to the entire column in meta.data


   for (i in 1:length(classes)) {
       # Find cells that match the current cluster number
       cells = which(as.numeric(obj@meta.data[[cluster_col]]) == i)
     
       # Assign the class label to the cells in the cluster
       obj@meta.data[cells, class_col] = classes[[i]]
   }
  
   # Return the modified object
   return(obj)
}
```


```{r}
classes = c("oligo", "oligo", "astrocyte", "oligo", "microglia", "oligo", "astrocyte", "neuron", "neuron", "astrocyte", "opc", "neuron", "oligo", "endo", "oligo", "ependymal", "oligo", "neuron", "neuron", "immune")


filtered_merged_caudate = assignCellClasses(filtered_merged_caudate, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "cell_class")

Idents(filtered_merged_caudate) <- "cell_class"
DimPlot(filtered_merged_caudate, label = TRUE)
```
```{r}
cells_per_donor = as.data.frame(table(filtered_merged_caudate@meta.data$donor_id))
cells_per_donor

cell_class_df = as.data.frame(table(filtered_merged_caudate@meta.data$cell_class, filtered_merged_caudate@meta.data$donor_id))


cell_class_df = merge(cell_class_df, cells_per_donor, by.x="Var2", by.y = "Var1")
cell_class_df

cell_class_df$cell_proportions = cell_class_df$Freq.x/cell_class_df$Freq.y
cell_class_df
```

```{r}
ggplot(cell_class_df, aes(x = Var2, y = cell_proportions, fill = Var1)) +
  geom_bar(stat = "identity", postion= "stack") + xlab("Donors from Caudate Village") + ylab("Number of cells by cell type") + labs(fill = "Cell type")+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
cell_class_df
```


```{r}
cell_class_df$condtion = ifelse(grepl("SCF_21-037CM2|SCF-23-068CM|SCF-22-058CF|SCF-22-054CM", cell_class_df$Var2), "control", "XDP")
cell_class_df
```


```{r}
ggplot(cell_class_df, aes(x = Var2, y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") + xlab("Donors from Caudate Village") + ylab("Number of cells by cell type") + labs(fill = "Cell type")+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
#+
 # geom_text(data = cell_class_df, aes(x = Var1, y = cell_class_df, label = cell_class_df), 
#            vjust = -0.3, color = "black", size = 3, inherit.aes = FALSE) +
 
```





```{r}
x_order = c("SCF_21-037CM2","SCF-23-068CM","SCF-22-054CM", "SCF-22-058CF", "SCF-20-025", "SCF-18-003",  "SCF_22-043", "SCF_20-024", "SCF-18-004", "SCF-18-006", "SCF-20-023", "SCF-21-030", "PCMC-16-012", "SCF-19-009", "SCF-19-014", "PCMC-16-011", "SCF-19-018")

cell_class_df$Var2 = factor(cell_class_df$Var2, levels = x_order)


ggplot(cell_class_df, aes(x = Var2, y = Freq.x, fill = Var1)) +
  geom_bar(stat = "identity") + xlab("Donors from Caudate Village") + ylab("Number of cells by cell type") + labs(fill = "Cell type")+ geom_vline(xintercept =  4.5, linetype = "dashed", color = "black")+ theme(axis.text.x = element_text(angle = 45, hjust = 1))

```



```{r}
ggplot(cell_class_df, aes(x = Var2, y = cell_proportions, fill = Var1)) +
  geom_bar(stat = "identity", postion= "stack") + xlab("Donors from Caudate Village") + ylab("Number of cells by cell type") + labs(fill = "Cell type")+ geom_vline(xintercept =  4.5, linetype = "dashed", color = "black")+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



```{r}
cells_per_donor = as.data.frame(table(filtered_merged_putamen@meta.data$donor_id))
cells_per_donor

cell_class_df = as.data.frame(table(filtered_merged_putamen@meta.data$cell_class, filtered_merged_putamen@meta.data$donor_id))


cell_class_df = merge(cell_class_df, cells_per_donor, by.x="Var2", by.y = "Var1")
cell_class_df

cell_class_df$cell_proportions = cell_class_df$Freq.x/cell_class_df$Freq.y
cell_class_df


cell_class_df$condtion = ifelse(grepl("SCF_21-037CM2|SCF-23-068CM|SCF-22-058CF|SCF-22-054CM", cell_class_df$Var2), "control", "XDP")
cell_class_df
```


```{r}
x_order = c("SCF_21-037CM2","SCF-23-068CM","SCF-22-054CM", "SCF-22-058CF",  "SCF-20-025","SCF_22-043","SCF-20-023","SCF-18-003",   "SCF_20-024", "SCF-18-006", "SCF-19-009","SCF-21-030","SCF-19-014", "SCF-18-004", "SCF-19-018","PCMC-16-011","PCMC-16-012")

cell_class_df$Var2 = factor(cell_class_df$Var2, levels = x_order)


ggplot(cell_class_df, aes(x = Var2, y = Freq.x, fill = Var1)) +
  geom_bar(stat = "identity") + xlab("Donors from Putamen Village") + ylab("Number of cells by cell type") + labs(fill = "Cell type")+ geom_vline(xintercept =  4.5, linetype = "dashed", color = "black")+ theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(cell_class_df, aes(x = Var2, y = cell_proportions, fill = Var1)) +
  geom_bar(stat = "identity", postion= "stack") + xlab("Donors from Putamen Village") + ylab("Number of cells by cell type") + labs(fill = "Cell type")+ geom_vline(xintercept =  4.5, linetype = "dashed", color = "black")+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
```





```{r}
head(filtered_merged_caudate@meta.data)
```

```{r}
table_for_correlation = as.data.frame(table(filtered_merged_caudate$donor_id))
table_for_correlation$total_cells = table_for_correlation$Freq
table_for_correlation$Freq = NULL
table_for_correlation

```

```{r}
table_for_correlation = merge(table_for_correlation, median_umis_per_donor$mUMI)
```

```{r}
table_for_correlation
```



```{r}
median_umis_per_donor <-filtered_merged_caudate@meta.data %>%
  group_by(donor_id, cell_class) %>%
  summarize(mUMI = median(nUmi, na.rm = TRUE))

median_umis_per_donor
```









---
title: "R Notebook"
output: html_notebook
---

```{r}
library(Seurat)
library(Matrix)
library(rhdf5)
library(dplyr)
library(qs)
library(ggplot2)
```

```{r}
filtered_merged_caudate = qread("Cellbender_seurat/filtered_merged_caudate_clustered.qs")
filtered_merged_putamen = qread("Cellbender_seurat/filtered_merged_putamen_clustered.qs")
filtered_merged_caudate
filtered_merged_putamen
```

```{r}
head(filtered_merged_caudate)
head(caudate_sobj)
```


```{r}
caudate_sobj = qread("Cellbender_seurat/Bennet_caudate_clean.qs")
putamen_sobj = qread("Cellbender_seurat/Bennet_putamen_clean.qs")

caudate_sobj
putamen_sobj
```
```{r}
DimPlot(putamen_sobj, group.by = "Condition")
```


```{r}
DimPlot(caudate_sobj, group.by = "RNA_snn_res.0.5")
```




#subset just neurons --> get 5581 neurons
```{r}
caudate_neurons = subset(caudate_sobj, subset = cell_class == "neuron")
caudate_neurons
head(caudate_neurons)
```
```{r}
DimPlot(caudate_neurons, group.by = "library")
DimPlot(caudate_neurons, group.by = "donor_id")
DimPlot(caudate_neurons, group.by = "Condition")

DimPlot(caudate_neurons, group.by = "RNA_snn_res.0.2")
DimPlot(caudate_neurons, group.by = "RNA_snn_res.0.3")
DimPlot(caudate_neurons, group.by = "RNA_snn_res.0.4")
DimPlot(caudate_neurons, group.by = "RNA_snn_res.0.5")
```
#Putamen has 12518 neurons
```{r}
putamen_neurons = subset(putamen_sobj, subset = cell_class == "neuron")
putamen_neurons
head(putamen_neurons)

DimPlot(putamen_neurons, group.by = "library")
DimPlot(putamen_neurons, group.by = "donor_id")
DimPlot(putamen_neurons, group.by = "Condition")

DimPlot(putamen_neurons, group.by = "RNA_snn_res.0.2")
DimPlot(putamen_neurons, group.by = "RNA_snn_res.0.3")
DimPlot(putamen_neurons, group.by = "RNA_snn_res.0.4")
DimPlot(putamen_neurons, group.by = "RNA_snn_res.0.5")
```


```{r}
library(harmony)
putamen_neurons = normalizeScalePcaClusterUmap(putamen_neurons)
putamen_neurons = (putamen_neurons
    %>% RunHarmony(
        group.by = "donor_id")
    %>% FindNeighbors(reduction='harmony', dims=1:20)
    %>% FindClusters(res=0.2)
    %>% FindClusters(res=0.3)
    %>% FindClusters(res=0.4)
    %>% FindClusters(res=0.5)
    %>% RunUMAP(reduction="harmony", dims=1:20)
) 
```


```{r}
qsave(putamen_neurons, "Cellbender_seurat/putamen_neurons.qs")
```

```{r}
DimPlot(putamen_neurons, group.by = "library")
DimPlot(putamen_neurons, group.by = "donor_id")
DimPlot(putamen_neurons, group.by = "Condition")

DimPlot(putamen_neurons, group.by = "RNA_snn_res.0.2")
DimPlot(putamen_neurons, group.by = "RNA_snn_res.0.3")
DimPlot(putamen_neurons, group.by = "RNA_snn_res.0.4")
DimPlot(putamen_neurons, group.by = "RNA_snn_res.0.5")
```

```{r}
Idents(putamen_neurons) = putamen_neurons$RNA_snn_res.0.2
markers = FindAllMarkers(putamen_neurons, only.pos = TRUE, min.pct = 0.2, logfc.threshold = 0.5)

num_clusters = length(unique(Idents(putamen_neurons))) - 1

for (i in 0:num_clusters){
   printMarkersByCluster(markers, cluster=i)
}
```


```{r}
classes = c("D2 SPN_1", "D1 SPN_1", "eSPN", "glutamatergic", "D1 SPN_2", "interneuron_1", "interneuron_2", "interneuron_3", "D2 SPN_2", "D1 SPN_3?", "interneuron_4", "interneuron_5", "cholinergic", "interneuron_6")

#classes = c("SPN", "SPN", "SPN", "glutamatergic", "SPN", "interneuron", "interneuron", "interneuron", "SPN", "SPN", "interneuron", "interneuron", "cholinergic", "interneuron")

putamen_neurons= assignCellClasses(putamen_neurons, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "cell_class")

Idents(putamen_neurons) <- "cell_class"

DimPlot(putamen_neurons, label= TRUE)
```
```{r}
FeaturePlot(putamen_neurons, features = c("DRD1", "DRD2"))
FeaturePlot(putamen_neurons, features = c("EPHA4", "SEMA3E"))
FeaturePlot(putamen_neurons, features =c("CASZ1"))
FeaturePlot(putamen_neurons, features =c("CHAT"))
FeaturePlot(putamen_neurons, features =c("C1QA"))
FeaturePlot(putamen_neurons, features = c("PPP1R1B", "MT-CO1"))
```
```{r}
FeaturePlot(putamen_neurons, features = c("GAD1", "GAD2"))
FeaturePlot(putamen_neurons, features = c("VIP", "CALB2"))
FeaturePlot(putamen_neurons, features = c("SLC17A7", "SLC17A6"))

```


```{r}
table(putamen_neurons$donor_id)

```


```{r}
donor_list = unique(putamen_neurons$donor_id)
neurons_per_donor = as.data.frame(table(putamen_neurons$donor_id))

classes = c("D2 SPN_1", "D1 SPN_1", "eSPN", "glutamatergic", "D1 SPN_2", "interneuron_1", "interneuron_2", "interneuron_3", "D2 SPN_2", "D1 SPN_3?", "interneuron_4", "interneuron_5", "cholinergic", "interneuron_6")

putamen_neurons= assignCellClasses(putamen_neurons, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "cell_class")
Idents(putamen_neurons) <- "cell_class"


for (donor in donor_list) {
  single_donor_neurons = subset(putamen_neurons, subset = donor_id == donor)
  neuron_count = neurons_per_donor$Freq[neurons_per_donor$Var1 == donor]
  print(DimPlot(single_donor_neurons,  label = TRUE)+ ggtitle(paste(donor, "Number of neurons: ", neuron_count)))
}

```










```{r}
normalizeScalePcaClusterUmap = function(
    sobj,
    subset_col="donor_id",
    n_hvgs_orig=2500,
    n_dims_use=20,
    resolutions=c(0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)){
    # this function takes a Seurat object, normalizes the data, scales the data, runs PCA, finds neighbors, clusters, and runs UMAP
    # it then returns the Seurat object
    hvgs = getSeuratVarFeatureIntersectByCol(sobj, subset_col=subset_col, original_nfeatures=n_hvgs_orig)
    sobj = (sobj
        %>% NormalizeData() # log normalizes raw counts
        %>% ScaleData(features=hvgs, split.by=subset_col) # within each cell, for each gene scale the data (i.e. subtract the donor's mean and divide by the donor's standard deviation of that gene)
        %>% RunPCA(features=hvgs, npcs=n_dims_use) # Reduce the dimensions to the n_dims_use dimensions that best explain the data https://en.wikipedia.org/wiki/Principal_component_analysis
        %>% FindNeighbors(dims = 1:n_dims_use) # Finds every cells closest neighbors in the PCA space
    )
    for(res in resolutions){
        sobj = sobj %>% FindClusters(resolution = res) # finds clusters at a variety of resolutions
    }
    sobj = sobj %>% RunUMAP(dims = 1:n_dims_use) # projects the PCA onto 2 dimensions, such that both "global structure" and "local structure" are optimally preserved
    return(sobj)
}

getSeuratVarFeatureIntersectByCol = function(
   seurat_obj,
   subset_col,
   original_nfeatures,
   n_subsets_to_cover=NULL
){
  
   hvgs = list()


   unique_ids = unique(seurat_obj@meta.data[[subset_col]])


   if (is.null(n_subsets_to_cover)){
       n_subsets_to_cover = floor(length(unique_ids)/2)
   }


   i=1
   for (id in unique_ids) {
       print(paste("Subset", id, "--", i, "of", length(unique_ids)))
       i = i + 1
      
       seurat_subset = seurat_obj[, seurat_obj[[subset_col]] == id]
      
       if (ncol(seurat_subset) < 2){next}
      
       suppressWarnings({
           seurat_subset = FindVariableFeatures(
               seurat_subset, nfeatures=original_nfeatures, verbose = FALSE)
       })
      
       hvgs[[id]] = getSeuratVarFeatures(seurat_subset)
      
   }


   common_hvgs = getCommonStrings(hvgs, n_subsets_to_cover)
   print(paste("Number of HVGs in common across", n_subsets_to_cover, "--", length(common_hvgs)))


   return(common_hvgs)
}

getSeuratVarFeatures = function(sobj){
    # the magical incantation that returns the slot of the attribute of the slot that actually holds the list of variable feature -_-
    return(sobj@assays$RNA@var.features)
}

getCommonStrings <- function(list_of_lists, n) {
  # Create an empty list to store string occurrences
  string_occurrences <- list()

  # Iterate over each sublist
  for (sublist in list_of_lists) {
    # For each string in the sublist, increment its count in string_occurrences
    for (string in unique(sublist)) {
      if (!is.null(string_occurrences[[string]])) {
        string_occurrences[[string]] <- string_occurrences[[string]] + 1
      } else {
        string_occurrences[[string]] <- 1
      }
    }
  }

  # Filter the strings that occur at least n times
  common_strings <- names(string_occurrences)[string_occurrences >= n]

  return(common_strings)
}
```


```{r}
library(harmony)
caudate_neurons = normalizeScalePcaClusterUmap(caudate_neurons)
caudate_neurons = (caudate_neurons
    %>% RunHarmony(
        group.by = "donor_id")
    %>% FindNeighbors(reduction='harmony', dims=1:20)
    %>% FindClusters(res=0.2)
    %>% FindClusters(res=0.3)
    %>% FindClusters(res=0.4)
    %>% FindClusters(res=0.5)
    %>% RunUMAP(reduction="harmony", dims=1:20)
) 
```



```{r}
head(putamen_neurons)
```


```{r}
library(qs)
qsave(caudate_neurons, "Cellbender_seurat/caudate_neurons.qs")
```

```{r}
DimPlot(caudate_neurons, group.by = "RNA_snn_res.0.2")
DimPlot(caudate_neurons, group.by = "RNA_snn_res.0.3")
DimPlot(caudate_neurons, group.by = "RNA_snn_res.0.4")
DimPlot(caudate_neurons, group.by = "RNA_snn_res.0.5")

DimPlot(caudate_neurons, group.by = "library")
DimPlot(caudate_neurons, group.by = "donor_id")
DimPlot(caudate_neurons, group.by = "Condition")
```

```{r}
FeaturePlot(caudate_neurons, features = c("DRD1", "DRD2"))
FeaturePlot(caudate_neurons, features = c("EPHA4", "SEMA3E"))
```



```{r}
caudate_neurons_preintergrated = subset(caudate_sobj, subset = cell_class == "neuron")
caudate_neurons_preintergrated
head(caudate_neurons_preintergrated)
```


```{r}
DimPlot(caudate_neurons_preintergrated, group.by = "RNA_snn_res.0.2")
DimPlot(caudate_neurons_preintergrated, group.by = "RNA_snn_res.0.3")
DimPlot(caudate_neurons_preintergrated, group.by = "RNA_snn_res.0.4")
DimPlot(caudate_neurons_preintergrated, group.by = "RNA_snn_res.0.5")

DimPlot(caudate_neurons_preintergrated, group.by = "library")
DimPlot(caudate_neurons_preintergrated, group.by = "donor_id")
DimPlot(caudate_neurons_preintergrated, group.by = "Condition")
```

```{r}
FeaturePlot(caudate_neurons_preintergrated, features = c("DRD1", "DRD2"))
FeaturePlot(caudate_neurons_preintergrated, features = c("EPHA4", "SEMA3E"))

```

#for tmr: Do the rest of the featureplots for pct mito, log10numi, GAPDH, UBB, TUBB2A
#make forloop to do umaps for every donor + maybe even for just neuronal level too 
#try running Findallmarkers here? 


```{r}
head(caudate_neurons_preintergrated)
```

```{r}
caudate_neurons_preintergrated@meta.data$log10nUMI = log10(caudate_neurons_preintergrated@meta.data$nUmi)
caudate_neurons@meta.data$log10nUMI = log10(caudate_neurons@meta.data$nUmi)

head(caudate_neurons)
head(caudate_neurons_preintergrated)
```




```{r}
FeaturePlot(caudate_neurons_preintergrated, features = c("pct_mito"))
FeaturePlot(caudate_neurons_preintergrated, features = c("log10nUMI"))
FeaturePlot(caudate_neurons_preintergrated, features = c("GAPDH", "UBB", "TUBB2A"))

FeaturePlot(caudate_neurons, features = c("pct_mito"))
FeaturePlot(caudate_neurons, features = c("log10nUMI"))
FeaturePlot(caudate_neurons, features = c("GAPDH", "UBB", "TUBB2A"))
```

```{r}
DimPlot(caudate_neurons_preintergrated, label = TRUE)
```

```{r}
#FeaturePlot(caudate_neurons, features =c("RBFOX3", "C1QA", "CX3CR1", "CB69"))
#FeaturePlot(caudate_neurons, features =c("EPHA4", "SEMA3E", "CASZ1", "CHAT"))
#FeaturePlot(caudate_neurons, features =c("MBP"))
FeaturePlot(caudate_neurons, features =c("CASZ1"))
FeaturePlot(caudate_neurons, features =c("CHAT"))
FeaturePlot(caudate_neurons, features =c("C1QA"))
```


```{r}
FeaturePlot(caudate_neurons, features =c("C1QA", "C1QB"))
FeaturePlot(caudate_neurons, features =c("CX3CR1", "P2RY12"))
FeaturePlot(caudate_neurons, features =c("PPP1R1B"))

```


#Find all markers on the intergrated neuron cah
```{r}
#only.pos = False

Idents(caudate_neurons) = caudate_neurons$RNA_snn_res.0.2
markers = FindAllMarkers(caudate_neurons, only.pos = TRUE, min.pct = 0.2, logfc.threshold = 1.25)

num_clusters = length(unique(Idents(caudate_neurons))) - 1

for (i in 0:num_clusters){
   printMarkersByCluster(markers, cluster=i)
}
```

```{r}
#classes = c("0?", "1?", "2?", "3?", "GAD1-2,STY1", "GAD1", "GAD1/SYT1", "microglia???", "SST/SYNPR", "LAMP5", "10?", "SLC17A8, SYT1,GAD1", "GAD1/ambig", "GAD1/MOBP")


#classes = c("SPN", "SPN", "SPN", "SPN", "interneuron", "interneuron", "interneuron", "SPN", "interneuron", "SPN", "SPN", "cholinergic", "interneuron", "interneuron")

classes = c("D1 SPN_1", "D2_SPN_1", "D1 SPN_2?", "eSPN", "interneuron_1", "interneuron_2", "interneuron_3", "SPN?", "interneuron_4", "D1 SPN_3", "D2 SPN_2", "cholinergic", "interneuron_6", "interneuron_7")

caudate_neurons= assignCellClasses(caudate_neurons, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "cell_class")

Idents(caudate_neurons) <- "cell_class"

DimPlot(caudate_neurons, label= TRUE)
```

```{r}
FeaturePlot(caudate_neurons, features = c("pct_mito"))
FeaturePlot(caudate_neurons, features = c("PPP1R1B", "MT-CO1"))
FeaturePlot(caudate_neurons, features = c("DRD1", "DRD2"))
```

```{r}
FeaturePlot(caudate_neurons, features = c("PPP1R1B"))
FeaturePlot(caudate_neurons, features = c("SST"))
```



```{r}
"EPHA4", "SEMA3E", "CASZ1", "CHAT", "ACHE"

```



#make forloop to do umaps for every donor + maybe even for just neuronal level too 
#try running Findallmarkers here? 




```{r}
donor_list = unique(caudate_neurons$donor_id)
neurons_per_donor = as.data.frame(table(caudate_neurons$donor_id))

#classes = c(" ")

caudate_neurons= assignCellClasses(caudate_neurons, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "cell_class")
Idents(caudate_neurons) <- "cell_class"


for (donor in donor_list) {
  single_donor_neurons = subset(caudate_neurons, subset = donor_id == donor)
  neuron_count = neurons_per_donor$Freq[neurons_per_donor$Var1 == donor]
  print(DimPlot(single_donor_neurons,  label = TRUE)+ ggtitle(paste(donor, "Number of neurons: ", neuron_count)))
}

```
```{r}
head(filtered_merged_caudate)
```





```{r}
donor_list = unique(filtered_merged_caudate_sub$donor_id)
cells_per_donor = as.data.frame(table(filtered_merged_caudate_sub$donor_id, filtered_merged_caudate_sub$cell_class))

classes = c("oligo", "oligo", "oligo", "microglia", "oligo", "oligo", "astrocyte", "astrocyte", "astrocyte", "astrocyte", "SPN", "opc", "oligo", "SPN", "SPN", "interneuron", "oligo", "oligo", "endothelial", "ependymal", "oligo", "interneuron", "interneuron", "astrocyte", "immune", "oligo")

filtered_merged_caudate_sub= assignCellClasses(filtered_merged_caudate_sub, classes=classes, cluster_col="RNA_snn_res.0.5", class_col = "cell_class")
Idents(filtered_merged_caudate_sub) <- "cell_class"


for (donor in donor_list) {
  single_donor_cells = subset(filtered_merged_caudate_sub, subset = donor_id == donor)
  cell_count = cells_per_donor$Freq[cells_per_donor$Var1 == donor]
  print(DimPlot(single_donor_cells,  label = TRUE)+ ggtitle(paste(donor, "Number of cells: ", cell_count)))
}
```

```{r}
cells_per_donor
```


#putamen
```{r}
donor_list = unique(putamen_sobj$donor_id)
cells_per_donor = as.data.frame(table(putamen_sobj$donor_id))

classes = c("oligo", "oligo", "astrocyte", "neuron", "oligo", "microglia", "neuron", "oligo", "opc", "oligo", "neuron", "neuron", "astrocyte", "neuron", "neuron", "oligo", "endo", "neuron", "neuron", "neuron", "oligo", "neuron")

putamen_sobj= assignCellClasses(putamen_sobj, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "cell_class")
Idents(putamen_sobj) <- "cell_class"


for (donor in donor_list) {
  single_donor_cells = subset(putamen_sobj, subset = donor_id == donor)
  cell_count = cells_per_donor$Freq[cells_per_donor$Var1 == donor]
  print(DimPlot(single_donor_cells,  label = TRUE)+ ggtitle(paste(donor, "Number of cells: ", cell_count)))
}
```

```{r}
head
```


```{r}
DimPlot(putamen_sobj, group.by = "donor_id")

```

















#from chatgpt, ask later about removing doublets
```{r}
FeaturePlot(filtered_merged_caudate, c("MOBP"))
```
```{r}
# Define marker genes
oligo_genes <- c("OLIG2", "MBP", "MOG")
microglia_genes <- c("CX3CR1", "P2RY12", "TMEM119")
astrocyte_genes <- c("GFAP", "S100B", "ALDH1L1")

# Load your Seurat object
# seurat_obj <- readRDS("path_to_your_seurat_object.rds")

# Add module scores
filtered_merged_caudate <- AddModuleScore(filtered_merged_caudate, features = list(oligo_genes), name = "Oligo_Score")
filtered_merged_caudate <- AddModuleScore(filtered_merged_caudate, features = list(microglia_genes), name = "Microglia_Score")
filtered_merged_caudate <- AddModuleScore(filtered_merged_caudate, features = list(astrocyte_genes), name = "Astrocyte_Score")

# Identify potential doublets
filtered_merged_caudate@meta.data <- filtered_merged_caudate@meta.data %>%
  mutate(Doublet_Score = Oligo_Score1 + Microglia_Score1 + Astrocyte_Score1)

# Define a threshold for doublet score
doublet_threshold <- quantile(filtered_merged_caudate@meta.data$Doublet_Score, 0.99)

# Filter out doublets
filtered_merged_caudate_filtered <- subset(filtered_merged_caudate, subset = Doublet_Score < doublet_threshold)

# Optionally, visualize the scores
FeaturePlot(filtered_merged_caudate, features = c("Oligo_Score1", "Microglia_Score1", "Astrocyte_Score1"))

# Save the filtered Seurat object
# saveRDS(seurat_obj_filtered, "path_to_filtered_seurat_object.rds")

```

