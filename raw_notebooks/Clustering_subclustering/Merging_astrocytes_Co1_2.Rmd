---
title: "R Notebook"
output: html_notebook
---

```{r}
library(Seurat)
library(qs)
library(tidyverse)
library(ggplot2)
```

```{r}
sct_cleaned_CaH_Put_Cohort2 = qread("cleaned_CaH_Put_Cohort2_sct_ucell_031725.qs")
sct_cleaned_CaH_Put_Cohort2
sct_cleaned_CaH_Put_Cohort2@meta.data
```

```{r}
DefaultAssay(sct_cleaned_CaH_Put_Cohort2) = "RNA"
xdp_co2_astro = subset(sct_cleaned_CaH_Put_Cohort2, subset = final_cell_class_merged == "astrocyte")
xdp_co2_astro
```


```{r}
# this code should take 3-10 minutes
library(sctransform)
xdp_co2_astro = SCTransform(xdp_co2_astro, vars.to.regress = "pct_mito", verbose = FALSE)
DefaultAssay(xdp_co2_astro) = "SCT"

hvgs = getSeuratVarFeatureIntersectByCol(xdp_co2_astro, subset_col="donor_id", original_nfeatures=2500)
n_dims_use=20
xdp_co2_astro = (xdp_co2_astro
   %>% NormalizeData() # log normalizes raw counts
   %>% ScaleData(features=hvgs, split.by="donor_id") # within each cell, for each gene scale the data (i.e. subtract the donor's mean and divide by the donor's standard deviation of that gene)
   %>% RunPCA(features=hvgs, npcs=n_dims_use) # Reduce the dimensions to the n_dims_use dimensions that best explain the data https://en.wikipedia.org/wiki/Principal_component_analysis
   %>% FindNeighbors(dims = 1:n_dims_use) # Finds every cells closest neighbors in the PCA space
   %>% FindClusters(resolution = 0.2) # finds clusters at a variety of resolutions
   %>% FindClusters(resolution = 0.3) # after clustering, the cluster labels are accessible via filtered_merged_caudate$RNA_snn_res.{resolution}
   %>% FindClusters(resolution = 0.4) # e.g.: filtered_merged_caudate$RNA_snn_res.0.4 here
   %>% FindClusters(resolution = 0.5)
   %>% FindClusters(resolution = 0.6)
   %>% FindClusters(resolution = 0.7)
   %>% FindClusters(resolution = 0.8)
   %>% FindClusters(resolution = 0.9)
   %>% FindClusters(resolution = 1)
   %>% RunUMAP(dims = 1:n_dims_use) # projects the PCA onto 2 dimensions, such that both "global structure" and "local structure" are optimally preserved
)

setwh = function(w, h){
   # set the width of the ensuing figures to w, height to h
   options(repr.plot.width = w, repr.plot.height = h)
}

DimPlot(xdp_co2_astro, group.by = "donor_id") 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.2", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.3", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.4", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.5", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.6", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.7", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.8", label=T)
DimPlot(xdp_co2_astro, group.by = "final_cell_class", label=T)
DimPlot(xdp_co2_astro, group.by = "neuron_cell_class", label=T)
```


```{r}
library(harmony)
xdp_co2_astro = (xdp_co2_astro
    %>% RunHarmony(
        group.by = "donor_id")
    %>% FindNeighbors(reduction='harmony', dims=1:20)
    %>% FindClusters(res=0.05)
    %>% FindClusters(res=0.1)
    %>% FindClusters(res=0.2)
    %>% FindClusters(res=0.3)
    %>% FindClusters(res=0.4)
    %>% FindClusters(res=0.5)
    %>% FindClusters(res=0.6)
    %>% FindClusters(res=0.7)
    %>% FindClusters(res=0.8)    
    %>% RunUMAP(reduction="harmony", dims=1:20)
)
xdp_co2_astro
xdp_co2_astro@meta.data
DimPlot(xdp_co2_astro, group.by = "donor_id") 
DimPlot(xdp_co2_astro, group.by = "region")
DimPlot(xdp_co2_astro, group.by = "Condition")
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.05", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.1", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.2", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.3", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.4", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.5", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.6", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.7", label=T) 
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.8", label=T)
DimPlot(xdp_co2_astro, group.by = "final_cell_class", label=T)
```

```{r}
FeaturePlot(xdp_co2_astro, features = c("SYT1", "AQP4", "C1QA","FLT1"),raster=FALSE)
FeaturePlot(xdp_co2_astro, features = c("OLIG1", "OLIG2", "MOG" ,"CD96"),raster=FALSE) 
FeaturePlot(xdp_co2_astro, features = c("MBP", "MOBP", "TF", "ST18"),raster=FALSE)
FeaturePlot(xdp_co2_astro, features = c("RBFOX3", "CX3CR1", "GFAP" ,"AQP4"),raster=FALSE) 
FeaturePlot(xdp_co2_astro, features = c("GAD1", "GAD2", "SLC17A7" ,"SLC17A6"),raster=FALSE) 
FeaturePlot(xdp_co2_astro, features = c("pct_mito", "pct_intronic", "nUmi"),raster=FALSE) 
```

```{r}
Idents(xdp_co2_astro) = xdp_co2_astro$SCT_snn_res.0.2
xdp_co2_astro = subset(xdp_co2_astro, subset = SCT_snn_res.0.2 != "7")

xdp_co2_astro@meta.data$final_neuron_cell_class_harmony = "astrocyte"

DimPlot(xdp_co2_astro, group.by = "donor_id") 
DimPlot(xdp_co2_astro, group.by = "region")
DimPlot(xdp_co2_astro, group.by = "Condition")
DimPlot(xdp_co2_astro, group.by = "SCT_snn_res.0.2", label=T)
DimPlot(xdp_co2_astro, group.by = "final_neuron_cell_class_harmony", label=T)
```
```{r}
qsave(xdp_co2_astro, "XDP_CaH_Put_Cohort2_subclustered_astro_032425.qs")
```


```{r}
xdp_co2_astro = qread("XDP_CaH_Put_Cohort2_subclustered_astro_032025.qs")
xdp_co2_astro@meta.data
```

```{r}
xdp_co1 = qread("/broad/macosko/kimkathl/temp_disco/more_temp_1205/xdp_cah_put_sct_new.qs")
xdp_co1
xdp_co1@meta.data
```

```{r}
DefaultAssay(xdp_co1) = "RNA"
xdp_co1_astro = subset(xdp_co1, subset = final_cell_class == "astrocyte")
xdp_co1_astro
```

```{r}
# this code should take 3-10 minutes
library(sctransform)
options(future.globals.maxSize = 400 * 1024^3)  
xdp_co1_astro = SCTransform(xdp_co1_astro, vars.to.regress = "pct_mito", verbose = FALSE)
DefaultAssay(xdp_co1_astro) = "SCT"
xdp_co1_astro
```


```{r}
hvgs = getSeuratVarFeatureIntersectByCol(xdp_co1_astro, subset_col="donor_id", original_nfeatures=2500)
n_dims_use=20
xdp_co1_astro = (xdp_co1_astro
   %>% NormalizeData() # log normalizes raw counts
   %>% ScaleData(features=hvgs, split.by="donor_id") # within each cell, for each gene scale the data (i.e. subtract the donor's mean and divide by the donor's standard deviation of that gene)
   %>% RunPCA(features=hvgs, npcs=n_dims_use) # Reduce the dimensions to the n_dims_use dimensions that best explain the data https://en.wikipedia.org/wiki/Principal_component_analysis
   %>% FindNeighbors(dims = 1:n_dims_use) # Finds every cells closest neighbors in the PCA space
   %>% FindClusters(resolution = 0.2) # finds clusters at a variety of resolutions
   %>% FindClusters(resolution = 0.3) # after clustering, the cluster labels are accessible via filtered_merged_caudate$RNA_snn_res.{resolution}
   %>% FindClusters(resolution = 0.4) # e.g.: filtered_merged_caudate$RNA_snn_res.0.4 here
   %>% FindClusters(resolution = 0.5)
   %>% FindClusters(resolution = 0.6)
   %>% FindClusters(resolution = 0.7)
   %>% FindClusters(resolution = 0.8)
   %>% FindClusters(resolution = 0.9)
   %>% FindClusters(resolution = 1)
   %>% RunUMAP(dims = 1:n_dims_use) # projects the PCA onto 2 dimensions, such that both "global structure" and "local structure" are optimally preserved
)

setwh = function(w, h){
   # set the width of the ensuing figures to w, height to h
   options(repr.plot.width = w, repr.plot.height = h)
}

DimPlot(xdp_co1_astro, group.by = "donor_id") 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.2", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.3", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.4", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.5", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.6", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.7", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.8", label=T)
DimPlot(xdp_co1_astro, group.by = "final_cell_class", label=T)
DimPlot(xdp_co1_astro, group.by = "neuron_classes", label=T)
```

```{r}
library(harmony)
xdp_co1_astro = (xdp_co1_astro
    %>% RunHarmony(
        group.by = "donor_id")
    %>% FindNeighbors(reduction='harmony', dims=1:20)
    %>% FindClusters(res=0.05)
    %>% FindClusters(res=0.1)
    %>% FindClusters(res=0.2)
    %>% FindClusters(res=0.3)
    %>% FindClusters(res=0.4)
    %>% FindClusters(res=0.5)
    %>% FindClusters(res=0.6)
    %>% FindClusters(res=0.7)
    %>% FindClusters(res=0.8)    
    %>% RunUMAP(reduction="harmony", dims=1:20)
)
xdp_co1_astro
xdp_co1_astro@meta.data
```


```{r}
DimPlot(xdp_co1_astro, group.by = "donor_id") 
DimPlot(xdp_co1_astro, group.by = "Region")
DimPlot(xdp_co1_astro, group.by = "Condition")
DimPlot(xdp_co1_astro, group.by = "final_cell_class", label=T)
DimPlot(xdp_co1_astro, group.by = "neuron_classes", label=T)
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.05", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.1", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.2", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.3", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.4", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.5", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.6", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.7", label=T) 
DimPlot(xdp_co1_astro, group.by = "SCT_snn_res.0.8", label=T)

```
```{r}
FeaturePlot(xdp_co1_astro, features = c("SYT1", "AQP4", "C1QA","FLT1"),raster=FALSE)
FeaturePlot(xdp_co1_astro, features = c("OLIG1", "OLIG2", "MOG" ,"CD96"),raster=FALSE) 
FeaturePlot(xdp_co1_astro, features = c("MBP", "MOBP", "TF", "ST18"),raster=FALSE)
FeaturePlot(xdp_co1_astro, features = c("RBFOX3", "CX3CR1", "GFAP" ,"AQP4"),raster=FALSE) 
FeaturePlot(xdp_co1_astro, features = c("GAD1", "GAD2", "SLC17A7" ,"SLC17A6"),raster=FALSE) 
FeaturePlot(xdp_co1_astro, features = c("pct_mito", "pct_intronic", "nUmi"),raster=FALSE) 
```

```{r}
xdp_co1_astro@meta.data$final_neuron_cell_class_harmony = "astrocyte"

DimPlot(xdp_co1_astro, group.by = "donor_id") 
DimPlot(xdp_co1_astro, group.by = "Region")
DimPlot(xdp_co1_astro, group.by = "Condition")
DimPlot(xdp_co1_astro, group.by = "neuron_classes", label=T)
DimPlot(xdp_co1_astro, group.by = "final_neuron_cell_class_harmony", label=T)
```


```{r}
Idents(xdp_co1_astro) = "final_neuron_cell_class_harmony"
```


```{r}
qsave(xdp_co1_astro, "XDP_CaH_Put_Cohort1_subclustered_astro_032425.qs")
```


```{r}
DefaultAssay(xdp_co1_astro) = "RNA"
DefaultAssay(xdp_co2_astro) = "RNA"

xdp_co1_astro@meta.data
xdp_co2_astro@meta.data

Idents(xdp_co1_astro) = "final_neuron_cell_class_harmony"
Idents(xdp_co2_astro) = "final_neuron_cell_class_harmony"
```

```{r}
xdp_co1_astro@meta.data$ROI_astrocyte = NULL
xdp_co1_astro@meta.data$ROI_endo = NULL
xdp_co1_astro@meta.data$ROI_oligo = NULL
xdp_co1_astro@meta.data$ROI_opc = NULL
xdp_co1_astro@meta.data$ROI_neuron = NULL
xdp_co1_astro@meta.data$ROI_micro_roi_genes = NULL
xdp_co1_astro@meta.data$ROI_upreg_astrocyte = NULL
xdp_co1_astro@meta.data$ROI_upreg_endo = NULL
xdp_co1_astro@meta.data$ROI_upreg_oligo = NULL
xdp_co1_astro@meta.data$ROI_upreg_opc = NULL
xdp_co1_astro@meta.data$ROI_upreg_neuron = NULL
xdp_co1_astro@meta.data$ROI_upreg_mg = NULL
xdp_co1_astro@meta.data$ROI_downreg_astrocyte = NULL
xdp_co1_astro@meta.data$ROI_downreg_oligo = NULL
xdp_co1_astro@meta.data$ROI_downreg_neuron = NULL
xdp_co1_astro@meta.data$ROI_downreg_mg = NULL
xdp_co1_astro@meta.data$ROI_upreg_SPN_matrix = NULL
xdp_co1_astro@meta.data$ROI_downreg_SPN_matrix = NULL
xdp_co1_astro@meta.data$ROI_mg = NULL
xdp_co1_astro@meta.data$ROI_upreg_new_astrocyte = NULL
xdp_co1_astro@meta.data$ROI_upreg_new_endo = NULL
xdp_co1_astro@meta.data$ROI_upreg_new_oligo = NULL
xdp_co1_astro@meta.data$ROI_upreg_new_opc = NULL
xdp_co1_astro@meta.data$ROI_upreg_new_neuron = NULL
xdp_co1_astro@meta.data$ROI_upreg_new_mg = NULL
xdp_co1_astro@meta.data$ROI_downreg_new_astrocyte = NULL
xdp_co1_astro@meta.data$ROI_downreg_new_oligo = NULL
xdp_co1_astro@meta.data$ROI_downreg_new_neuron = NULL
xdp_co1_astro@meta.data$ROI_downreg_new_mg = NULL


xdp_co1_astro@meta.data$Scoreinflammatory = NULL
xdp_co1_astro@meta.data$Scoreinterferon_gamma = NULL
xdp_co1_astro@meta.data$ScoreMHC1_antigen = NULL
xdp_co1_astro@meta.data$ScoreMHC2_antigen = NULL
xdp_co1_astro@meta.data$Scorebase_excision = NULL
xdp_co1_astro@meta.data$Scoremismatch_repair = NULL
xdp_co1_astro@meta.data$HLA_A = NULL
xdp_co1_astro@meta.data$HLA_combined = NULL
```


```{r}
colnames(xdp_co1_astro@meta.data)
colnames(xdp_co2_astro@meta.data)
```

```{r}
xdp_co2_astro@meta.data$C_minus_scores = NULL
xdp_co2_astro@meta.data$C_plus_scores = NULL
```

```{r}
xdp_co2_astro@meta.data$Region = xdp_co2_astro$region
```

```{r}
xdp_co1_astro@meta.data$Cohort = "Cohort_1"
xdp_co2_astro@meta.data$Cohort = "Cohort_2"
```


```{r}
sobj_list = list(xdp_co1_astro,
xdp_co2_astro)

counts_list <- lapply(sobj_list, function(sobj) GetAssayData(sobj, slot = "counts"))
merged_counts <- do.call(cbind, counts_list)
metadata_list <- lapply(sobj_list, function(sobj) sobj@meta.data)
```


```{r}
# Get all unique column names from both metadata dataframes
all_cols <- unique(unlist(lapply(metadata_list, colnames)))
all_cols
# Ensure each metadata dataframe has all columns, filling missing ones with NA
metadata_list <- lapply(metadata_list, function(df) {
  df[, setdiff(all_cols, colnames(df))] <- NA
  df <- df[, all_cols]  # Reorder columns to match
  return(df)
})

# Now merge metadata
merged_metadata <- do.call(rbind, metadata_list)
merged_metadata
```


```{r}

merged_metadata <- do.call(rbind, metadata_list)
merged_metadata

stopifnot(all(rownames(merged_metadata) == colnames(merged_counts)))

# Create Seurat object
XDP_astro_Cohorts_1_2 <- CreateSeuratObject(counts = merged_counts, meta.data = merged_metadata)
XDP_astro_Cohorts_1_2
```


```{r}
table(XDP_astro_Cohorts_1_2@meta.data$donor_id)
```
```{r}
XDP_astro_Cohorts_1_2@meta.data
```
```{r}
table(XDP_astro_Cohorts_1_2@meta.data$library, XDP_astro_Cohorts_1_2@meta.data$Sex)
```

```{r}
XDP_astro_Cohorts_1_2$Region[XDP_astro_Cohorts_1_2$Region == "caudate"] = "Caudate" 
XDP_astro_Cohorts_1_2$Region[XDP_astro_Cohorts_1_2$Region == "putamen"] = "Putamen" 

XDP_astro_Cohorts_1_2@meta.data$library_cohort = paste0(XDP_astro_Cohorts_1_2$library, "_", XDP_astro_Cohorts_1_2$Cohort)

XDP_astro_Cohorts_1_2@meta.data$Sex <- ifelse(is.na(XDP_astro_Cohorts_1_2@meta.data$Sex), XDP_astro_Cohorts_1_2@meta.data$sex, XDP_astro_Cohorts_1_2@meta.data$Sex)
XDP_astro_Cohorts_1_2@meta.data$sex <- NULL

```

```{r}
XDP_astro_Cohorts_1_2

library(sctransform)
options(future.globals.maxSize = 400 * 1024^3)  
XDP_astro_Cohorts_1_2 = SCTransform(XDP_astro_Cohorts_1_2, vars.to.regress = "pct_mito", verbose = FALSE)
DefaultAssay(XDP_astro_Cohorts_1_2) = "SCT"
XDP_astro_Cohorts_1_2
```


```{r}
# this code should take 3-10 minutes
hvgs = getSeuratVarFeatureIntersectByCol(XDP_astro_Cohorts_1_2, subset_col="donor_id", original_nfeatures=2500)
n_dims_use=20
XDP_astro_Cohorts_1_2 = (XDP_astro_Cohorts_1_2
   %>% NormalizeData() # log normalizes raw counts
   %>% ScaleData(features=hvgs, split.by="donor_id") # within each cell, for each gene scale the data (i.e. subtract the donor's mean and divide by the donor's standard deviation of that gene)
   %>% RunPCA(features=hvgs, npcs=n_dims_use) # Reduce the dimensions to the n_dims_use dimensions that best explain the data https://en.wikipedia.org/wiki/Principal_component_analysis
   %>% FindNeighbors(dims = 1:n_dims_use) # Finds every cells closest neighbors in the PCA space
   %>% FindClusters(resolution = 0.2) # finds clusters at a variety of resolutions
   %>% FindClusters(resolution = 0.3) # after clustering, the cluster labels are accessible via filtered_merged_caudate$RNA_snn_res.{resolution}
   %>% FindClusters(resolution = 0.4) # e.g.: filtered_merged_caudate$RNA_snn_res.0.4 here
   %>% FindClusters(resolution = 0.5)
   %>% FindClusters(resolution = 0.6)
   %>% FindClusters(resolution = 0.7)
   %>% FindClusters(resolution = 0.8)
   %>% FindClusters(resolution = 0.9)
   %>% FindClusters(resolution = 1)
   %>% RunUMAP(dims = 1:n_dims_use) # projects the PCA onto 2 dimensions, such that both "global structure" and "local structure" are optimally preserved
)

setwh = function(w, h){
   # set the width of the ensuing figures to w, height to h
   options(repr.plot.width = w, repr.plot.height = h)
}

DimPlot(XDP_astro_Cohorts_1_2, group.by = "donor_id") 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "Region")
DimPlot(XDP_astro_Cohorts_1_2, group.by = "Condition")
DimPlot(XDP_astro_Cohorts_1_2, group.by = "final_cell_class", label=T)
DimPlot(XDP_astro_Cohorts_1_2, group.by = "neuron_classes", label=T)
DimPlot(XDP_astro_Cohorts_1_2, group.by = "final_neuron_cell_class_harmony", label=T)
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.05", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.1", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.2", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.3", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.4", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.5", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.6", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.7", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.8", label=T)
```


```{r}
library(harmony)
XDP_astro_Cohorts_1_2 = (XDP_astro_Cohorts_1_2
    %>% RunHarmony(
        group.by = "donor_id")
    %>% FindNeighbors(reduction='harmony', dims=1:20)
    %>% FindClusters(res=0.05)
    %>% FindClusters(res=0.1)
    %>% FindClusters(res=0.2)
    %>% FindClusters(res=0.3)
    %>% FindClusters(res=0.4)
    %>% FindClusters(res=0.5)
    %>% FindClusters(res=0.6)
    %>% FindClusters(res=0.7)
    %>% FindClusters(res=0.8)    
    %>% RunUMAP(reduction="harmony", dims=1:20)
)
XDP_astro_Cohorts_1_2
XDP_astro_Cohorts_1_2@meta.data
DimPlot(XDP_astro_Cohorts_1_2, group.by = "donor_id") 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.05", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.1", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.2", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.3", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.4", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.5", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.6", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.7", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.8", label=T)
DimPlot(XDP_astro_Cohorts_1_2, group.by = "cell_class", label=T)
DimPlot(XDP_astro_Cohorts_1_2, group.by = "neuron_cell_class", label=T)
DimPlot(XDP_astro_Cohorts_1_2, group.by = "final_neuron_cell_class_harmony", label=T)
DimPlot(XDP_astro_Cohorts_1_2, group.by = "library")
DimPlot(XDP_astro_Cohorts_1_2, group.by = "Cohort")
DimPlot(XDP_astro_Cohorts_1_2, group.by = "library_cohort")
```
```{r}
DimPlot(XDP_astro_Cohorts_1_2, group.by = "Region")
```

```{r}
FeaturePlot(XDP_astro_Cohorts_1_2, features = c("SYT1", "AQP4", "C1QA","FLT1"),raster=FALSE)
FeaturePlot(XDP_astro_Cohorts_1_2, features = c("OLIG1", "OLIG2", "MOG" ,"CD96"),raster=FALSE) 
FeaturePlot(XDP_astro_Cohorts_1_2, features = c("MBP", "MOBP", "TF", "ST18"),raster=FALSE)
FeaturePlot(XDP_astro_Cohorts_1_2, features = c("RBFOX3", "CX3CR1", "GFAP" ,"AQP4"),raster=FALSE) 
FeaturePlot(XDP_astro_Cohorts_1_2, features = c("GAD1", "GAD2", "SLC17A7" ,"SLC17A6"),raster=FALSE) 
FeaturePlot(XDP_astro_Cohorts_1_2, features = c("pct_mito", "pct_intronic", "nUmi"),raster=FALSE) 
```
```{r}
XDP_astro_Cohorts_1_2@meta.data$final_neuron_cell_class_harmony_merged = XDP_astro_Cohorts_1_2@meta.data$final_neuron_cell_class_harmony

Idents(XDP_astro_Cohorts_1_2) = "final_neuron_cell_class_harmony_merged"
```


```{r}
DimPlot(XDP_astro_Cohorts_1_2, group.by = "donor_id") 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "Region")
DimPlot(XDP_astro_Cohorts_1_2, group.by = "Condition")
DimPlot(XDP_astro_Cohorts_1_2, group.by = "Cohort")
DimPlot(XDP_astro_Cohorts_1_2, group.by = "library", split.by = "Region")
DimPlot(XDP_astro_Cohorts_1_2, group.by = "final_neuron_cell_class_harmony_merged", label=T)
```
```{r}
XDP_astro_Cohorts_1_2@meta.data

table(XDP_astro_Cohorts_1_2$Gender)
```


```{r}
colnames(XDP_astro_Cohorts_1_2@meta.data)
```
```{r}
XDP_astro_Cohorts_1_2$Scoreantigen_processing = NULL
XDP_astro_Cohorts_1_2$Scoreinterferon_alpha = NULL
XDP_astro_Cohorts_1_2$neuron_classes = NULL
XDP_astro_Cohorts_1_2$antigen_processing_scores = NULL
XDP_astro_Cohorts_1_2$ScoreNFKB = NULL

```



```{r}
XDP_astro_Cohorts_1_2 <- AddModuleScore_UCell(XDP_astro_Cohorts_1_2, features = list(Score = NFKB_genes), name = 'NFKB')

XDP_astro_Cohorts_1_2@meta.data$Condition_Cohort = paste0(XDP_astro_Cohorts_1_2@meta.data$Condition, "_", XDP_astro_Cohorts_1_2@meta.data$Cohort)
```

```{r}
histograms_by_all_celltype(XDP_astro_Cohorts_1_2@meta.data, "ScoreNFKB", "ScoreNFKB", 25, 5)
```

```{r}
histograms_by_all_celltype_cohort(XDP_astro_Cohorts_1_2@meta.data, "ScoreNFKB", "ScoreNFKB", 30, 5)
```

```{r}
histograms_by_donor(XDP_astro_Cohorts_1_2@meta.data, "ScoreNFKB", "astrocyte" ,"ScoreNFKB", 30, 15)
```

```{r}
final_df = XDP_astro_Cohorts_1_2@meta.data
xlab = "ScoreNFKB"
min = min(final_df$ScoreNFKB)
max = max(final_df$ScoreNFKB)
step = (max-min)/100

limits = seq(min, max, step)
  
a = plot_overlapping_density_histogram(df = final_df, 
                                          hist_col = final_df$ScoreNFKB,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue","BICAN_V8" = "green", "pd" = "red", "ctr" = "blue", "XDP_18_006" = "orange"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: Astrocytes"),
                                          xlab = xlab,
                                          fig_filename = NULL)
  
  

# Display or save the final plot
ggsave("combined_plot.png", a, width = 7, height =5 )

```


```{r}
plot_overlapping_density_histogram(df = final_df, 
                                          hist_col = final_df$ScoreNFKB,
                                          fill_col = "Condition_Cohort",
                                           colors = c("XDP_Cohort_1" = "red", "Control_Cohort_1" = "blue","XDP_Cohort_2" = "orange", "Control_Cohort_2" = "green"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: Astrocytes"),
                                          xlab = xlab,
                                          fig_filename = NULL) 

plot_overlapping_density_histogram(df = final_df, 
                                          hist_col = final_df$ScoreNFKB,
                                          fill_col = "Condition_Cohort",
                                           colors = c("XDP_Cohort_1" = "red", "Control_Cohort_1" = "blue","XDP_Cohort_2" = "orange", "Control_Cohort_2" = "green"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: Astrocytes"),
                                          xlab = xlab,
                                          fig_filename = NULL) + facet_wrap(~ Cohort)

plot_overlapping_density_histogram(df = final_df, 
                                          hist_col = final_df$ScoreNFKB,
                                          fill_col = "Condition_Cohort",
                                           colors = c("XDP_Cohort_1" = "red", "Control_Cohort_1" = "blue","XDP_Cohort_2" = "orange", "Control_Cohort_2" = "green"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: Astrocytes"),
                                          xlab = xlab,
                                          fig_filename = NULL) + facet_wrap(~ Condition)

  

```


```{r}
histograms_by_donor <- function(final_df, score_col, celltype, xlab, width_size, height_size) {
  
  unique_donors <- unique(final_df$donor_id)

  # Identify controls and cases
  controls <- unique_donors[grepl("CM$|CF$|CM2$", unique_donors)]
  cases <- unique_donors[!grepl("CM$|CF$|CM2$", unique_donors)]

  # Alphabetically sort both groups
  controls <- sort(controls)
  cases <- sort(cases)

  # Combine ordered donor IDs (cases first, then controls)
  ordered_donors <- c(cases, controls)
  
  print(ordered_donors)

  plots <- list()

  # Subset dataframe for the specific cell type
  final_df_cellclass <- subset(final_df, final_neuron_cell_class_harmony_merged == celltype)

  # Determine global x-axis limits (bins)
  min_val <- min(final_df_cellclass[[score_col]], na.rm = TRUE)
  max_val <- max(final_df_cellclass[[score_col]], na.rm = TRUE)
  step <- (max_val - min_val) / 100
  limits <- seq(min_val, max_val, step)

  # **Determine global y-axis limit** by finding the maximum count across all donors
  max_peak_y <- 0  # Initialize
  
   for (donor in ordered_donors) {
    df_sub <- final_df_cellclass[final_df_cellclass$donor_id == donor, ]
    if (nrow(df_sub) > 0) {
      hist_data <- hist(df_sub[[score_col]], breaks = limits, plot = FALSE)
      max_peak_y <- max(max_peak_y, max(hist_data$density, na.rm = TRUE))  # Use density (peak) instead of total count
    }
  }
  
  # **Now generate histograms with consistent y-axis limits**
  for (donor in ordered_donors) {
    df_sub <- final_df_cellclass[final_df_cellclass$donor_id == donor, ]
    
    if (nrow(df_sub) == 0) {
      message(paste("No data for donor:", donor, "- skipping."))
      next
    }

    cell_count <- nrow(df_sub)
    
    a <- plot_overlapping_density_histogram(
      df = df_sub, 
      hist_col = df_sub[[score_col]],
      fill_col = "Condition_Cohort",
      colors = c("XDP_Cohort_1" = "red", "Control_Cohort_1" = "blue","XDP_Cohort_2" = "orange", "Control_Cohort_2" = "green"),
      breaks = limits,
      title = paste0(donor, ": ", celltype, " (Cells: ", cell_count, ")"),
      xlab = xlab,
      fig_filename = NULL
    )
    
    # Modify the y-axis limit directly using ggplot2
    a <- a + ggplot2::ylim(0, max_peak_y)  # Set consistent y-axis limit
    
    plots[[donor]] <- a
  }
  
  final_plot <- plot_grid(plotlist = plots, ncol = 5)
  
  print(final_plot)  
  ggsave("combined_plot.png", final_plot, width = width_size, height = height_size)
}

```

```{r}
XDP_astro_Cohorts_1_2@meta.data
XDP_astro_Cohorts_1_2 <- AddModuleScore_UCell(XDP_astro_Cohorts_1_2, features = list(Score = interferon_alpha), name = 'interferon_alpha')
```


```{r}
histograms_by_donor(XDP_astro_Cohorts_1_2@meta.data, "Scoreinterferon_alpha", "astrocyte" ,"Scoreinterferon_alpha", 30, 15)
```

```{r}
final_df = XDP_astro_Cohorts_1_2@meta.data
xlab = "Scoreinterferon_alpha"
min = min(final_df$Scoreinterferon_alpha)
max = max(final_df$Scoreinterferon_alpha)
step = (max-min)/100

limits = seq(min, max, step)
  
a = plot_overlapping_density_histogram(df = final_df, 
                                          hist_col = final_df$Scoreinterferon_alpha,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue","BICAN_V8" = "green", "pd" = "red", "ctr" = "blue", "XDP_18_006" = "orange"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: Astrocytes"),
                                          xlab = xlab,
                                          fig_filename = NULL)
  
  

# Display or save the final plot
ggsave("combined_plot.png", a, width = 7, height =5 )

```


```{r}
plot_overlapping_density_histogram(df = final_df, 
                                          hist_col = final_df$Scoreinterferon_alpha,
                                          fill_col = "Condition_Cohort",
                                           colors = c("XDP_Cohort_1" = "red", "Control_Cohort_1" = "blue","XDP_Cohort_2" = "orange", "Control_Cohort_2" = "green"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: Astrocytes"),
                                          xlab = xlab,
                                          fig_filename = NULL) 

plot_overlapping_density_histogram(df = final_df, 
                                          hist_col = final_df$Scoreinterferon_alpha,
                                          fill_col = "Condition_Cohort",
                                           colors = c("XDP_Cohort_1" = "red", "Control_Cohort_1" = "blue","XDP_Cohort_2" = "orange", "Control_Cohort_2" = "green"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: Astrocytes"),
                                          xlab = xlab,
                                          fig_filename = NULL) + facet_wrap(~ Cohort)

plot_overlapping_density_histogram(df = final_df, 
                                          hist_col = final_df$Scoreinterferon_alpha,
                                          fill_col = "Condition_Cohort",
                                           colors = c("XDP_Cohort_1" = "red", "Control_Cohort_1" = "blue","XDP_Cohort_2" = "orange", "Control_Cohort_2" = "green"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: Astrocytes"),
                                          xlab = xlab,
                                          fig_filename = NULL) + facet_wrap(~ Condition)

  

```


```{r}
qsave(XDP_astro_Cohorts_1_2, "XDP_astro_Cohorts_1_2_032425.qs")
```


#Testing out UCell

```{r}
DefaultAssay(sct_cleaned_CaH_Put_Cohort2) = "RNA"
temp_sobj_RNA = sct_cleaned_CaH_Put_Cohort2
temp_sobj_RNA <- AddModuleScore_UCell(temp_sobj_RNA, features = list(Score = NFKB_genes), name = 'NFKB_RNA')

temp_astro = subset(temp_sobj_RNA, subset = final_cell_class_merged == "astrocyte")
temp_astro =  AddModuleScore_UCell(temp_astro, features = list(Score = NFKB_genes), name = 'NFKB_RNA_astro_only')

# this code should take 3-10 minutes
library(sctransform)

temp_sobj_RNA = SCTransform(temp_sobj_RNA, vars.to.regress = "pct_mito", verbose = FALSE)
DefaultAssay(temp_sobj_RNA) = "SCT"

temp_sobj_RNA <- AddModuleScore_UCell(temp_sobj_RNA, features = list(Score = NFKB_genes), name = 'NFKB_SCT')

temp_astro_SCT = subset(temp_sobj_RNA, subset = final_cell_class_merged == "astrocyte")
temp_astro_SCT =  AddModuleScore_UCell(temp_astro_SCT, features = list(Score = NFKB_genes), name = 'NFKB_SCT_astro_only')
```
```{r}
temp_sobj_RNA@meta.data
temp_astro@meta.data
temp_astro_SCT@meta.data
```

```{r}
ggplot(temp_sobj_RNA@meta.data, aes(x = ScoreNFKB_RNA, y = ScoreNFKB_SCT, color = final_cell_class_merged)) + geom_point(size = 0.5, alpha = 0.5) + xlab("RNA assay NFKB Scores") + ylab("SCT assay NFKB Scores")

ggplot(temp_astro@meta.data, aes(x = ScoreNFKB_RNA, y = ScoreNFKB_RNA_astro_only, color = final_cell_class_merged)) + geom_point(size = 0.5, alpha = 0.5)+ xlab("NFKB Scores - all cell classes") + ylab("NFKB Scores - astrocytes subset")

ggplot(temp_astro_SCT@meta.data, aes(x = ScoreNFKB_SCT, y = ScoreNFKB_SCT_astro_only, color = final_cell_class_merged)) + geom_point(size = 0.5, alpha = 0.5)

ggplot(temp_sobj_RNA@meta.data, aes(x = ScoreNFKB, y = ScoreNFKB_SCT, color = final_cell_class_merged)) + geom_point(size = 0.5, alpha = 0.5) + xlab("Original NFKB Scores") + ylab("SCT NFKB Scores")

```
```{r}
temp_df = merge(final_df, temp_sobj_RNA@meta.data, by = "cell")
temp_df

ggplot(temp_sobj_RNA@meta.data, aes(x = ScoreNFKB, y = ScoreNFKB_SCT, color = final_cell_class_merged)) + geom_point(size = 0.5, alpha = 0.5)
```


#Subclustering astrocytes??
```{r}
DimPlot(XDP_astro_Cohorts_1_2, label = T)
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.05", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.1", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.2", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.3", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.4", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.5", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.6", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.7", label=T) 
DimPlot(XDP_astro_Cohorts_1_2, group.by = "SCT_snn_res.0.8", label=T)
```
```{r}
FeaturePlot(XDP_astro_Cohorts_1_2, features = c("VIM", "GFAP", "IGFBP5","DBI"),raster=FALSE)
FeaturePlot(XDP_astro_Cohorts_1_2, features = c("LIMA1", "MARCKS", "MARCKSL1", "RACK1"),raster=FALSE)
FeaturePlot(XDP_astro_Cohorts_1_2, features = c("GRIA2", "SLC7A10", "FGFR3" ,"VEGFA"),raster=FALSE) 
```

```{r}
marker_genes <- c("AQP4", "VIM", "GFAP", "IGFBP5","DBI","LIMA1", "MARCKS", "MARCKSL1", "RACK1", "GRIA2", "SLC7A10", "FGFR3" ,"VEGFA")

Dotplot = DotPlot(object = XDP_astro_Cohorts_1_2, features = marker_genes, group.by = "SCT_snn_res.0.3")
Dotplot  <- Dotplot  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ coord_flip() 
print(Dotplot)


marker_genes <- c("WIF1", "SLIT1", "TMEM132C", "PTCH1",  "TNC", "DCLK1", "ADAMTSL3","SLC24A4", "GRIK4", "DLGAP1")

Dotplot = DotPlot(object = XDP_astro_Cohorts_1_2, features = marker_genes, group.by = "SCT_snn_res.0.3")
Dotplot  <- Dotplot  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ coord_flip() 
print(Dotplot)
```
#Let's get markers from bican 
```{r}
FeaturePlot(XDP_astro_Cohorts_1_2, features = c("WIF1", "TNC", "LMO2"),raster=FALSE)
#Grey
#No LINC00499,MIAT,ENSG00000287544
FeaturePlot(XDP_astro_Cohorts_1_2, features = c("WIF1", "SLIT1", "TMEM132C", "PTCH1"), raster = F)
#White
#No ENSG00000287704
FeaturePlot(XDP_astro_Cohorts_1_2, features = c("ENSG00000287704", "TNC", "DCLK1", "ADAMTSL3"), raster = F)
FeaturePlot(XDP_astro_Cohorts_1_2, features = c("SLC24A4", "GRIK4", "DLGAP1"), raster = F)
```

```{r}
Idents(XDP_astro_Cohorts_1_2) = XDP_astro_Cohorts_1_2$RNA_snn_res.0.3

classes = c("GM_astrocytes", "WM_astrocytes", "WM_astrocytes", "WM_astrocytes", "WM_astrocytes", "WM_astrocytes", "WM_astrocytes", "WM_astrocytes", "WM_astrocytes")

XDP_astro_Cohorts_1_2= assignCellClasses(XDP_astro_Cohorts_1_2, classes=classes, cluster_col="RNA_snn_res.0.3", class_col = "GM_WM_astrocytes")

DimPlot(XDP_astro_Cohorts_1_2, group.by = "GM_WM_astrocytes" ,label = T, raster = FALSE)
```

```{r}
XDP_astro_Cohorts_1_2@meta.data
```


```{r}
cells_per_donor = as.data.frame(table(XDP_astro_Cohorts_1_2@meta.data$donor_id))
cells_per_donor

cell_class_df = as.data.frame(table(XDP_astro_Cohorts_1_2@meta.data$GM_WM_astrocytes, XDP_astro_Cohorts_1_2@meta.data$donor_id))


cell_class_df = merge(cell_class_df, cells_per_donor, by.x="Var2", by.y = "Var1")
cell_class_df

cell_class_df$cell_proportions = cell_class_df$Freq.x/cell_class_df$Freq.y
cell_class_df

cell_class_df$Cohort <- XDP_astro_Cohorts_1_2@meta.data$Cohort[match(cell_class_df$Var2, XDP_astro_Cohorts_1_2@meta.data$donor_id)]
cell_class_df

# Count the number of cells per donor
donor_counts <- table(XDP_astro_Cohorts_1_2@meta.data$donor_id)

# Convert to dataframe for sorting
donor_df <- as.data.frame(donor_counts)
colnames(donor_df) <- c("donor_id", "cell_count")

# Identify controls (CM, CF) - ensuring it only checks ENDING
controls <- donor_df[grepl("CM$|CF$|CM2$", donor_df$donor_id), ]
cases <- donor_df[!grepl("CM$|CF$|CM2$", donor_df$donor_id), ]

# Sort both groups by cell count in descending order
controls <- controls[order(-controls$cell_count), ]
cases <- cases[order(-cases$cell_count), ]

# Combine ordered donor IDs
ordered_donors <- c(controls$donor_id, cases$donor_id)

# Print or use the ordered donor IDs
print(ordered_donors)


            
cell_class_df$Var2 = factor(cell_class_df$Var2, levels = ordered_donors)
# Extract Cohort information
cell_class_df <- cell_class_df %>%
  arrange(Cohort, match(Var2, ordered_donors)) %>%
  mutate(Var2 = factor(Var2, levels = unique(Var2))) 


cell_class_df
ggplot(cell_class_df, aes(x = Var2, y = Freq.x, fill = Var1)) +
  geom_bar(stat = "identity") + xlab("Donors") + ylab("Number of cells by Astrocyte Subclasses") + labs(fill = "Astrocyte Subclass") +theme(axis.text.x = element_text(angle = 45, hjust = 1))  +facet_grid(~ Cohort, scales = "free_x", space = "free_x")

ggplot(cell_class_df, aes(x = Var2, y = cell_proportions, fill = Var1)) +
  geom_bar(stat = "identity", postion= "stack") + xlab("Donors") + ylab("Astrocyte Subclass Proportion") + labs(fill = "Astrocyte Subclass")+ theme(axis.text.x = element_text(angle = 45, hjust = 1))   + facet_grid(~ Cohort, scales = "free_x", space = "free_x")
```

```{r}
ggplot(cell_class_df, aes(x = Var2, y = Freq.x, fill = Var1)) +
  geom_bar(stat = "identity") + xlab("Donors") + ylab("Number of cells by Astrocyte Subclass") + labs(fill = "Astrocyte Subclass")+ geom_vline(xintercept =  12.5, linetype = "dashed", color = "black") +theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(cell_class_df, aes(x = Var2, y = cell_proportions, fill = Var1)) +
  geom_bar(stat = "identity", postion= "stack") + xlab("Donors") + ylab("Astrocyte Subclass Proportion") + labs(fill = "Astrocyte Subclass")+ geom_vline(xintercept =  12.5, linetype = "dashed", color = "black")+ theme(axis.text.x = element_text(angle = 45, hjust = 1))  

```

```{r}
library(lme4)
sobj = XDP_astro_Cohorts_1_2
sobj = subset(sobj, donor_id != "SCF_22_049CCF")
model_cols = c("donor_id", "GM_WM_astrocytes", "Condition", "Gender", "Age.at.Death") #include any other covariates of interest, replace cell_class with whatever column defines the cluster annotations
pd = sobj@meta.data[,model_cols]
pd = pd[complete.cases(pd),] # don't want any NAs
pd$case_control_factor = as.factor(pd$Condition)

masc_df = .sconline.MASCfn(
    dataset=pd,
    cluster=pd$GM_WM_astrocytes, # cluster annotations
    contrast="case_control_factor", # name of contrast annotations (what you want to run the test for)
    random_effects=c("donor_id"), # name of random effects annotations (not interested in these coefficients, but account for variability in probable sources ob batch effects, in this case donor
    fixed_effects = c("Age.at.Death", "Gender") # your covariates
)

masc_df

my_order <- unique(masc_df$cluster)
masc_df$cluster_name <- sub("cluster", "", masc_df$cluster) # for legibility
masc_df$log2_or = log2(masc_df$case_control_factorXDP.OR) # the names of the case_control_factor<whatever> columns will change from project to project depending on the unique values of your Condition column
masc_df$log2_or_ci_low = log2(masc_df$case_control_factorXDP.OR.95pct.ci.lower)
masc_df$log2_or_ci_high = log2(masc_df$case_control_factorXDP.OR.95pct.ci.upper)

# order the graph to put disease-enriched populations on top
masc_df = masc_df[order(-masc_df$log2_or), ] 
masc_df$cluster_name = factor(masc_df$cluster_name, levels = masc_df$cluster_name[order(masc_df$log2_or)])
masc_df


library(RColorBrewer)
library(ggplot2)

# Create the forest plot with ticks on error bars, axis lines with ticks, RdBu color map, and opaque white circles on top
a = ggplot(masc_df, aes(y = cluster_name, x = log2_or)) +
  ggtitle("Cohort 1 + 2 Astrocytes (no CCF)") +
  geom_vline(xintercept = 0, linetype = "dotted", color = "gray") +  # Add dotted vertical line at x=0
  geom_segment(aes(x = log2_or_ci_low, xend = log2_or_ci_high, y = cluster_name, yend = cluster_name, color = log2_or), size = 1) +  # Add horizontal error bars
  geom_point(size = 3, aes(color = log2_or), shape = 1) +  # Add points for effect sizes
  geom_point(size = 3, shape = 21, fill = "white") +  # Add opaque white circle on top of the error bar line
  scale_color_gradientn(colors = RColorBrewer::brewer.pal(10, "RdBu")) +  # Use RdBu color map
  theme_minimal() +  # Minimal theme
  labs(x = "log2(OR)", y = "Cell Classes") +  # Axis labels
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    legend.position = "none",
    plot.title = element_text(size=16),
    axis.line = element_line(color = "black"),  # Add axis lines
    axis.ticks = element_line(color = "black"),  # Add axis ticks
    axis.text = element_text(size = 14),  # Increase tick label font size
    axis.title = element_text(size = 15)  # Increase axis label font size
  )

ggsave(a, filename = "pic.png", width = 7, height = 8)
```


```{r}
qsave(XDP_astro_Cohorts_1_2, "WIP_XDP_astro_Cohorts_1_2_032025.qs")
```

```{r}
xlab = "ScoreNFKB"
plot_overlapping_density_histogram(df = final_df, 
                                          hist_col = final_df$ScoreNFKB,
                                          fill_col = "Condition_Cohort",
                                           colors = c("XDP_Cohort_1" = "red", "Control_Cohort_1" = "blue","XDP_Cohort_2" = "orange", "Control_Cohort_2" = "green"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: Astrocytes"),
                                          xlab = xlab,
                                          fig_filename = NULL) 

plot_overlapping_density_histogram(df = final_df, 
                                          hist_col = final_df$ScoreNFKB,
                                          fill_col = "Condition_Cohort",
                                           colors = c("XDP_Cohort_1" = "red", "Control_Cohort_1" = "blue","XDP_Cohort_2" = "orange", "Control_Cohort_2" = "green"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: Astrocytes"),
                                          xlab = xlab,
                                          fig_filename = NULL) + facet_wrap(~GM_WM_astrocytes)

plot_overlapping_density_histogram(df = final_df, 
                                          hist_col = final_df$ScoreNFKB,
                                          fill_col = "Condition",
                                           colors = c("XDP" = "red", "Control" = "blue"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: Astrocytes"),
                                          xlab = xlab,
                                          fig_filename = NULL) + facet_wrap(~ GM_WM_astrocytes)

plot_overlapping_density_histogram(df = final_df, 
                                          hist_col = final_df$ScoreNFKB,
                                          fill_col = "Cohort",
                                           colors = c("Cohort_1" = "red", "Cohort_2" = "blue"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: Astrocytes"),
                                          xlab = xlab,
                                          fig_filename = NULL) + facet_wrap(~GM_WM_astrocytes)
```


```{r}
plot_overlapping_density_histogram(df = final_df, 
                                          hist_col = final_df$ScoreNFKB,
                                          fill_col = "Condition_Cohort",
                                           colors = c("XDP_Cohort_1" = "red", "Control_Cohort_1" = "blue","XDP_Cohort_2" = "orange", "Control_Cohort_2" = "green"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: Astrocytes"),
                                          xlab = xlab,
                                          fig_filename = NULL) + facet_wrap(~ Condition)

  

```

```{r}
Idents(sct_cleaned_CaH_Put_Cohort2) = "final_cell_class_merged"
DimPlot(sct_cleaned_CaH_Put_Cohort2, label = T)
FeaturePlot(sct_cleaned_CaH_Put_Cohort2, features = c("WIF1", "TNC"))
```

```{r}
cell_class_df
```


```{r}
# Create a contingency table
astro_counts <- matrix(c(WM_count_dataset1, GM_count_dataset1,
                         WM_count_dataset2, GM_count_dataset2),
                       nrow = 2, byrow = TRUE)

# Perform Chi-square test
chisq.test(astro_counts)

```


```{r}
prop.test(c(WM_count_dataset1, WM_count_dataset2),
          c(total_astrocytes_dataset1, total_astrocytes_dataset2))

```

```{r}
astro_counts <- as.matrix(table(XDP_astro_Cohorts_1_2@meta.data$GM_WM_astrocytes, XDP_astro_Cohorts_1_2@meta.data$Cohort),
                       nrow = 2, byrow = TRUE)
chisq.test(astro_counts)
chisq_result <- chisq.test(astro_counts)
chisq_result$stdres  # Extract standardized residuals

```

```{r}
donor_counts <- table(XDP_astro_Cohorts_1_2@meta.data$GM_WM_astrocytes, 
                      XDP_astro_Cohorts_1_2@meta.data$donor_id)
print(donor_counts)

apply(donor_counts, 2, function(x) chisq.test(matrix(x, nrow = 2))$p.value)

control_vs_case_counts <- table(XDP_astro_Cohorts_1_2@meta.data$GM_WM_astrocytes, 
                                XDP_astro_Cohorts_1_2@meta.data$Condition) # Assuming Diagnosis is "Control"/"Case"

print(control_vs_case_counts)
chisq.test(control_vs_case_counts)
chisq.test(control_vs_case_counts)$stdres

```


```{r}
astro_data <- data.frame(
  donor_id = XDP_astro_Cohorts_1_2@meta.data$donor_id,
  cohort = XDP_astro_Cohorts_1_2@meta.data$Cohort,
  condition = XDP_astro_Cohorts_1_2@meta.data$Condition,
  astrocyte_type = XDP_astro_Cohorts_1_2@meta.data$GM_WM_astrocytes
)
astro_data
astro_data$astrocyte_type <- ifelse(astro_data$astrocyte_type == "WM_astrocytes", 1, 0)

# Logistic regression predicting WM astrocytes based on cohort and diagnosis
glm_model <- glm(astrocyte_type ~ cohort + condition, data = astro_data, family = binomial)
summary(glm_model)


```
```{r}
cells_per_donor = as.data.frame(table(XDP_astro_Cohorts_1_2@meta.data$Cohort))
cells_per_donor

cell_class_df = as.data.frame(table(XDP_astro_Cohorts_1_2@meta.data$GM_WM_astrocytes, XDP_astro_Cohorts_1_2@meta.data$Cohort))


cell_class_df = merge(cell_class_df, cells_per_donor, by.x="Var2", by.y = "Var1")
cell_class_df

cell_class_df$cell_proportions = cell_class_df$Freq.x/cell_class_df$Freq.y
cell_class_df

cell_class_df$Cohort <- XDP_astro_Cohorts_1_2@meta.data$Cohort[match(cell_class_df$Var2, XDP_astro_Cohorts_1_2@meta.data$Cohort)]
cell_class_df

# Count the number of cells per donor
donor_counts <- table(XDP_astro_Cohorts_1_2@meta.data$Cohort)

# Convert to dataframe for sorting
donor_df <- as.data.frame(donor_counts)
colnames(donor_df) <- c("Cohort", "cell_count")


cell_class_df
ggplot(cell_class_df, aes(x = Var2, y = Freq.x, fill = Var1)) +
  geom_bar(stat = "identity") + xlab("Cohort") + ylab("Number of cells by Astrocyte Subclasses") + labs(fill = "Astrocyte Subclass") +theme(axis.text.x = element_text(angle = 45, hjust = 1))  +facet_grid(~ Cohort, scales = "free_x", space = "free_x")

ggplot(cell_class_df, aes(x = Var2, y = cell_proportions, fill = Var1)) +
  geom_bar(stat = "identity", postion= "stack") + xlab("Cohort") + ylab("Astrocyte Subclass Proportion") + labs(fill = "Astrocyte Subclass")+ theme(axis.text.x = element_text(angle = 45, hjust = 1))   + facet_grid(~ Cohort, scales = "free_x", space = "free_x")
```

```{r}
FeaturePlot(XDP_astro_Cohorts_1_2, features = "ScoreNFKB")
```


```{r}
XDP_neurons_Cohorts_1_2@meta.data
sct_cleaned_CaH_Put_Cohort2@meta.data
```
```{r}
table(XDP_neurons_Cohorts_1_2$final_neuron_subclass_merged)
```

```{r}
XDP_neurons_Cohorts_1_2@meta.data$final_SPN_merged = XDP_neurons_Cohorts_1_2$final_neuron_subclass_merged
XDP_neurons_Cohorts_1_2$final_SPN_merged[XDP_neurons_Cohorts_1_2$final_SPN_merged == "eSPN"] = "non_SPN"
XDP_neurons_Cohorts_1_2$final_SPN_merged[XDP_neurons_Cohorts_1_2$final_SPN_merged == "SPN_matrix"] = "SPN"
XDP_neurons_Cohorts_1_2$final_SPN_merged[XDP_neurons_Cohorts_1_2$final_SPN_merged == "SPN_patch"] = "SPN"
XDP_neurons_Cohorts_1_2$final_SPN_merged[XDP_neurons_Cohorts_1_2$final_SPN_merged == "SPN_patch_2"] = "SPN"

median_nUmi = XDP_neurons_Cohorts_1_2@meta.data %>%
  filter(final_SPN_merged == "SPN") %>%
  group_by(donor_id, Cohort, Condition) %>%
  summarize(median_UMI = median(nUmi, na.rm = TRUE))
median_nUmi

a = ggplot(median_nUmi, aes(x = donor_id, y =median_UMI, color = Condition)) + geom_point() + theme(axis.text.x = element_text(angle = 45, hjust = 1))   + facet_grid(~ Cohort, scales = "free_x", space = "free_x") + ylab("Median SPN UMIs") + xlab("Donor")

ggsave(a, filename = "pic.png", width = 8, height = 4)
```


```{r}
unique(XDP_neurons_Cohorts_1_2$final_SPN_merged)
```
```{r}
xdp_co1
sct_cleaned_CaH_Put_Cohort2
```


```{r}
caudate_SPN = as.data.frame(table(XDP_neurons_Cohorts_1_2$donor_id, XDP_neurons_Cohorts_1_2$final_SPN_merged))
caudate_SPN = subset(caudate_SPN, subset = Var2 == "SPN")
caudate_SPN$CaH_SPN = caudate_SPN$Freq 
caudate_SPN$Freq = NULL

caudate_SPN$Condtion = XDP_neurons_Cohorts_1_2@meta.data$Condition[match(caudate_SPN$Var1, XDP_neurons_Cohorts_1_2@meta.data$donor_id)]
caudate_SPN

total_cells1 =as.data.frame(table(xdp_co1$donor_id))
total_cells1
total_cells2=as.data.frame(table(sct_cleaned_CaH_Put_Cohort2$donor_id))
total_cells2

total_cells = rbind(total_cells1,total_cells2)
total_cells
```


```{r}
merged_SPN_final = merge(caudate_SPN, total_cells, by = "Var1")
merged_SPN_final
merged_SPN_final$SPN_proportion = merged_SPN_final$CaH_SPN/merged_SPN_final$Freq
merged_SPN_final
```

```{r}
b= ggplot(data = merged_SPN_final, aes(x =SPN_proportion, y = Freq, color = Condtion)) + 
  geom_point(size = 4) +
  labs(x="SPN Fraction in All Cells (Cohort 1 and 2)" , y= "Total Cells")  + ggtitle("SPN Fraction in All Cells vs Total SPNs") + scale_color_discrete(name = "Condition")+ geom_text(aes(label = Var1), vjust = -1, hjust = 0.5) 

ggsave("SPN_fraction.png", plot= b, width = 20, height = 10)
```

```{r}
total_nuclei	mUMI_all_nuclei	total_SPN_nuclei	SPN_mUMI	SPN fraction of total nuclei	median_pct_intronic	median_pct_mito	median_number_of_genes
```



```{r}
#totalcells
cells_per_donor <- sct_cleaned_CaH_Put_Cohort2@meta.data %>% 
  group_by(donor_id) %>%
  summarize(n = n())
cells_per_donor

#median nUMI
median_nUmi = sct_cleaned_CaH_Put_Cohort2@meta.data %>%
  group_by(donor_id) %>%
  summarize(median_UMI = median(nUmi, na.rm = TRUE))
median_nUmi

SPN_cells_per_library <- XDP_neurons_Cohorts_1_2@meta.data %>% 
  filter(final_SPN_merged == "SPN") %>%
  group_by(donor_id) %>%
  summarize(n = n())
SPN_cells_per_library

SPN_median_nUmi = XDP_neurons_Cohorts_1_2@meta.data %>%
  filter(final_SPN_merged == "SPN") %>%
  group_by(donor_id, Cohort, Condition) %>%
  summarize(median_UMI = median(nUmi, na.rm = TRUE))
SPN_median_nUmi


#median/mean nGenes
median_nGenes = sct_cleaned_CaH_Put_Cohort2@meta.data %>%
  group_by(donor_id) %>%
  summarize(median_nGenes = median(nFeature_RNA, na.rm = TRUE))
median_nGenes


#median/mean pctintronic
median_pct_intronic = sct_cleaned_CaH_Put_Cohort2@meta.data %>%
  group_by(donor_id) %>%
  summarize(median_pct_intronic = median(pct_intronic, na.rm = TRUE))
median_pct_intronic

#median/mean pctmito
median_pct_mito = sct_cleaned_CaH_Put_Cohort2@meta.data %>%
  group_by(donor_id) %>%
  summarize(median_pct_mito = median(pct_mito, na.rm = TRUE))
median_pct_mito

# List of data frames to merge
df_list <- list(cells_per_donor, median_nUmi, median_nGenes, median_pct_intronic, median_pct_mito )

# Merge all data frames on the common column Donor.ID
merged_df <- reduce(df_list, function(x, y) merge(x, y, by = "donor_id"))

# Print the merged data frame
print(merged_df)

write.csv(merged_df, "merged_df.csv")
```

```{r}
df_list <- list(SPN_cells_per_library, SPN_median_nUmi)

# Merge all data frames on the common column Donor.ID
merged_df <- reduce(df_list, function(x, y) merge(x, y, by = "donor_id"))

# Print the merged data frame
print(merged_df)

write.csv(merged_df, "merged_df.csv")
```














#Neuron Ucells
```{r}
library(UCell)

NFKB_genes =  c("MARCKS", "IL23A", "NINJ1", "TNFSF9", "SIK1", "ATF3", "SERPINE1", "MYC", "HES1", "CCNL1", "CCN1", "EGR1", "EGR2", "JAG1", "EGR3", "ABCA1", "GADD45B", "GADD45A", "PLK2", "KLF10", 
           "EIF1", "EHD1", "FOSL2", "FOSL1", "GPR183", "PLPP3", "IFIT2", "ICAM1", "ZC3H12A", "IER2", 
           "IL12B", "JUNB", "IER5", "IER3", "STAT5A", "DUSP5", "EDN1", "JUN", "DUSP4", "DUSP1", 
           "DUSP2", "TSC22D1", "CCL20", "SPHK1", "LIF", "IL18", "TUBB2A", "RHOB", "VEGFA", "PTPRE", 
           "IL1A", "TLR2", "IL1B", "BHLHE40", "ID2", "CLCF1", "REL", "FJX1", "SGK1", "BTG3", "BTG2", 
           "BTG1", "SDC4", "LITAF", "AREG", "SOCS3", "PANX1", "RIPK2", "NFIL3", "SERPINB2", "GCH1", 
           "IFNGR2", "G0S2", "FOS", "SERPINB8", "F3", "SPSB1", "FOSB", "PER1", "F2RL1", "HBEGF", 
           "CD44", "TRIP10", "CDKN1A", "PTGER4", "PTGS2", "IFIH1", "NAMPT", "OLR1", "ICOSLG", 
           "PHLDA1", "ZBTB10", "TAP1", "PNRC1", "CXCL10", "CXCL11", "IL6ST", "CD69", "SQSTM1", 
           "RELA", "CSF2", "CD83", "CSF1", "PPP1R15A", "CD80", "TNC", "TNF", "TANK", "RELB", "ZFP36", 
           "CCND1", "RNF19B", "CCRL2", "DENND5A", "PHLDA2", "MAP3K8", "LDLR", "SLC16A6", "SMAD3", 
           "TGIF1", "MAP2K3", "DDX58", "TRAF1", "INHBA", "NFKB1", "NFKB2", "GEM", "NR4A3", "MAFF", 
           "RCAN1", "NR4A2", "EFNA1", "MXD1", "BIRC2", "YRDC", "BIRC3", "IL7R", "PFKFB3", "IRS2", 
           "SLC2A3", "PLAU", "SLC2A6", "SAT1", "ETS2", "NR4A1", "SNN", "PMEPA1", "TNFRSF9", "MSC", 
           "TIPARP", "LAMB3", "GFPT2", "CFLAR", "TNIP1", "IRF1", "NFKBIA", "BMP2", "IL6", "TNIP2", 
           "BCL6", "BCL3", "NFKBIE", "NFE2L2", "B4GALT1", "NFAT5", "TNFAIP8", "BCL2A1", "TNFAIP6", 
           "TNFAIP3", "CXCL2", "CXCL1", "TNFAIP2", "CXCL3", "CXCL6", "FUT4", "DRAM1", "DNAJB4", 
           "PDE4B", "PDLIM5", "MCL1", "KDM6B", "IL15RA", "PLAUR", "ATP2B1", "KLF4", "KLF2", "SOD2", 
           "KLF9", "KLF6", "ACKR3", "PTX3", "B4GALT5", "TRIB1", "CEBPB", "CEBPD", "PLEK", "KYNU", 
           "CCL5", "CCL4", "CCL2")

interferon_alpha = c("IL4R", "CD74", "SP110", "MX1", "RSAD2", "TAP1", "PSMB9", "CXCL10", "CXCL11", "IFI44L", "LAP3", "LPAR6", "IFI27", "TRAFD1", "TRIM14", "LY6E", "IFITM2", "IFITM3", "SAMD9", "CSF1", 
           "IFITM1", "UBE2L6", "SAMD9L", "RNF31", "HERC6", "LAMP3", "CCRL2", "MVB12A", "B2M", "CMTR1", 
           "GBP2", "GBP4", "EPSTI1", "BATF2", "HLA-C", "TENT5A", "TDRD7", "ISG15", "IFI44", "PARP14", 
           "MOV10", "ISG20", "PARP12", "PLSCR1", "PROCR", "SELL", "PSME2", "PSME1", "CNP", "LGALS3BP", 
           "IFI35", "IFIT2", "IFI30", "DDX60", "IFIT3", "NUB1", "HELZ2", "PNPT1", "IL15", "NCOA7", 
           "EIF2AK2", "NMI", "OAS1", "BST2", "IRF1", "ELF1", "IL7", "IRF2", "IRF9", "IRF7", "UBA7", 
           "GMPR", "ADAR", "CASP8", "TRIM5", "RIPK2", "CASP1", "STAT2", "WARS1", "PARP9", "PSMA3", 
           "TXNIP", "CMPK2", "CD47", "RTP4", "C1S", "OGFR", "TMEM140", "USP18", "OASL", "SLC25A28", 
           "IFIH1", "PSMB8", "DHX58", "TRIM25", "TRIM26", "TRIM21")

antigen_processing_genes = c("CTSB", "CD74", "HSP90AA1", "KLRC3", "HSPA6", "HSPA5", "HSPA1L", "KLRC4", "HSPA8", "HSPA2", "TAP2", "HSPA4", "TAP1", "TAPBP", "CD4", "RFX5", "IFNG", "HSPA1A", "HLA-DRA", "HLA-DQB1", "KLRD1", "CALR", "HSPA1B", "TNF", "KIR2DL1", "KIR2DL2", "KIR2DL3", "KIR2DL4", "CTSS", "CTSL", "B2M", "HLA-DOB", "KIR2DL5A", "CIITA", "HLA-DQA2", "HLA-DOA", "HLA-DQA1", "PDIA3", "HLA-DRB5", 
"KIR2DS1", "NFYB", "KIR2DS2", "NFYC", "KIR2DS3", "KIR2DS4", "KIR2DS5", "HLA-C", "RFXANK", 
"KIR3DL1", "CD8B2", "KIR3DL2", "HLA-A", "HLA-B", "KIR3DL3", "HLA-G", "HLA-E", "HLA-F", "CREB1", "CD8B", "RFXAP", "CD8A", "CANX", "LGMN", "PSME2", "PSME3", "HLA-DPB1", "PSME1", "HLA-DRB4", 
"HLA-DRB3", "HLA-DRB1", "HSP90AB1", "IFI30", "HLA-DMB", "HLA-DPA1", "KLRC1", "KLRC2", "NFYA","HLA-DMA")
C_minus = qread("temp_disco/more_temp_1205/final_c_minus_genes.qs")
C_plus = qread("temp_disco/more_temp_1205/final_c_plus_genes.qs")

XDP_astro_Cohorts_1_2 <- AddModuleScore_UCell(XDP_astro_Cohorts_1_2, features = list(Score = NFKB_genes), name = 'NFKB')

XDP_astro_Cohorts_1_2 <- AddModuleScore_UCell(XDP_astro_Cohorts_1_2, features = list(Score = interferon_alpha), name = 'interferon_alpha'
)

XDP_astro_Cohorts_1_2 <- AddModuleScore_UCell(XDP_astro_Cohorts_1_2,features = list(antigen_processing = antigen_processing_genes), name = '_scores')

XDP_astro_Cohorts_1_2 <- AddModuleScore_UCell(XDP_astro_Cohorts_1_2,features = list(C_minus = C_minus), name = '_scores')
XDP_astro_Cohorts_1_2 <- AddModuleScore_UCell(XDP_astro_Cohorts_1_2,features = list(C_plus = C_plus), name = '_scores')

qsave(XDP_astro_Cohorts_1_2, "XDP_astro_Cohorts_1_2_sct_ucell_032125.qs")
```
```{r}
# Count the number of cells per donor
donor_counts <- table(XDP_astro_Cohorts_1_2@meta.data$donor_id)

# Convert to dataframe for sorting
donor_df <- as.data.frame(donor_counts)
colnames(donor_df) <- c("donor_id", "cell_count")

# Identify controls (CM, CF) - ensuring it only checks ENDING
controls <- donor_df[grepl("CM$|CF$", donor_df$donor_id), ]
cases <- donor_df[!grepl("CM$|CF$", donor_df$donor_id), ]

# Sort both groups by cell count in descending order
controls <- controls[order(-controls$cell_count), ]
cases <- cases[order(-cases$cell_count), ]

# Combine ordered donor IDs
ordered_donors <- c(controls$donor_id, cases$donor_id)

# Print or use the ordered donor IDs
print(ordered_donors)


```


```{r}
cells_per_donor = as.data.frame(table(XDP_astro_Cohorts_1_2@meta.data$donor_id))
cells_per_donor

cell_class_df = as.data.frame(table(XDP_astro_Cohorts_1_2@meta.data$final_neuron_subclass_merged, XDP_astro_Cohorts_1_2@meta.data$donor_id))


cell_class_df = merge(cell_class_df, cells_per_donor, by.x="Var2", by.y = "Var1")
cell_class_df

cell_class_df$cell_proportions = cell_class_df$Freq.x/cell_class_df$Freq.y
cell_class_df


cell_class_df

# Count the number of cells per donor
donor_counts <- table(XDP_astro_Cohorts_1_2@meta.data$donor_id)

# Convert to dataframe for sorting
donor_df <- as.data.frame(donor_counts)
colnames(donor_df) <- c("donor_id", "cell_count")

# Identify controls (CM, CF) - ensuring it only checks ENDING
controls <- donor_df[grepl("CM$|CF$|CM2$", donor_df$donor_id), ]
cases <- donor_df[!grepl("CM$|CF$|CM2$", donor_df$donor_id), ]

# Sort both groups by cell count in descending order
controls <- controls[order(-controls$cell_count), ]
cases <- cases[order(-cases$cell_count), ]

# Combine ordered donor IDs
ordered_donors <- c(controls$donor_id, cases$donor_id)

# Print or use the ordered donor IDs
print(ordered_donors)


            
cell_class_df$Var2 = factor(cell_class_df$Var2, levels = ordered_donors)

ggplot(cell_class_df, aes(x = Var2, y = Freq.x, fill = Var1)) +
  geom_bar(stat = "identity") + xlab("Donors") + ylab("Number of cells by Neuron Subclasses") + labs(fill = "Neuron Subclass")+ geom_vline(xintercept =  12.5, linetype = "dashed", color = "black") +theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(cell_class_df, aes(x = Var2, y = cell_proportions, fill = Var1)) +
  geom_bar(stat = "identity", postion= "stack") + xlab("Donors") + ylab("Neuron Subclass Proportion") + labs(fill = "Neuron Subclass")+ geom_vline(xintercept =  12.5, linetype = "dashed", color = "black")+ theme(axis.text.x = element_text(angle = 45, hjust = 1))  
```


```{r}
histograms_by_all_celltype = function(final_df, score_col, xlab, width_size, height_size){

#celltypes = c("astrocyte", "microglia", "oligo", "opc", "endothelial","immune", "ependymal", "non_SPN", "eSPN", "SPN_matrix", "SPN_patch", "SPN_exotic")

 celltypes = unique(final_df[["final_neuron_cell_class_harmony_merged"]])  
plots <- list()

for (celltype in celltypes) {
  df_sub = final_df[final_df$final_neuron_cell_class_harmony_merged == celltype, ]
   
  if (nrow(df_sub) == 0) {
    message(paste("No data for cell type:", celltype, "- skipping."))
    next
  }
  
min = min(df_sub[[score_col]])
max = max(df_sub[[score_col]])
step = (max-min)/100

limits = seq(min, max, step)
  
  a = plot_overlapping_density_histogram(df = df_sub, 
                                          hist_col = df_sub[[score_col]],
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue","BICAN_V8" = "green", "pd" = "red", "ctr" = "blue", "XDP_18_006" = "orange"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: ", celltype),
                                          xlab = xlab,
                                          fig_filename = NULL)
  
    plots[[celltype]] = a
  
}

final_plot <- plot_grid(plotlist = plots, ncol = 5)

# Display or save the final plot
print(final_plot)  # Display
ggsave("combined_plot.png", final_plot, width = width_size, height = height_size)
}


histograms_by_all_celltype_cohort = function(final_df, score_col, xlab, width_size, height_size){

 celltypes = sort(unique(final_df[["final_neuron_cell_class_harmony_merged"]]))
plots <- list()

for (celltype in celltypes) {
  df_sub = final_df[final_df$final_neuron_cell_class_harmony_merged == celltype, ]
   
  if (nrow(df_sub) == 0) {
    message(paste("No data for cell type:", celltype, "- skipping."))
    next
  }
  
min = min(df_sub[[score_col]])
max = max(df_sub[[score_col]])
step = (max-min)/100

limits = seq(min, max, step)
  
  a = plot_overlapping_density_histogram(df = df_sub, 
                                          hist_col = df_sub[[score_col]],
                                          fill_col = "Condition_Cohort",
                                          colors = c("XDP_Cohort_1" = "red", "Control_Cohort_1" = "blue","XDP_Cohort_2" = "orange", "Control_Cohort_2" = "green"),
                                          breaks = limits,
                                          title = paste0("XDP vs Control: ", celltype),
                                          xlab = xlab,
                                          fig_filename = NULL)
  
    plots[[celltype]] = a
  
}

final_plot <- plot_grid(plotlist = plots, ncol = 5)

# Display or save the final plot
print(final_plot)  # Display
ggsave("combined_plot.png", final_plot, width = width_size, height = height_size)
}

histograms_by_donor <- function(final_df, score_col, celltype, xlab, width_size, height_size) {
  
  unique_donors <- unique(final_df$donor_id)

  # Identify controls and cases
  controls <- unique_donors[grepl("CM$|CF$|CM2$", unique_donors)]
  cases <- unique_donors[!grepl("CM$|CF$|CM2$", unique_donors)]

  # Alphabetically sort both groups
  controls <- sort(controls)
  cases <- sort(cases)

  # Combine ordered donor IDs (cases first, then controls)
  ordered_donors <- c(cases, controls)
  
  print(ordered_donors)

  plots <- list()

  # Subset dataframe for the specific cell type
  final_df_cellclass <- subset(final_df, final_neuron_cell_class_harmony_merged == celltype)

  # Determine global x-axis limits (bins)
  min_val <- min(final_df_cellclass[[score_col]], na.rm = TRUE)
  max_val <- max(final_df_cellclass[[score_col]], na.rm = TRUE)
  step <- (max_val - min_val) / 100
  limits <- seq(min_val, max_val, step)

  # **Determine global y-axis limit** by finding the maximum count across all donors
  max_peak_y <- 0  # Initialize
  
   for (donor in ordered_donors) {
    df_sub <- final_df_cellclass[final_df_cellclass$donor_id == donor, ]
    if (nrow(df_sub) > 0) {
      hist_data <- hist(df_sub[[score_col]], breaks = limits, plot = FALSE)
      max_peak_y <- max(max_peak_y, max(hist_data$density, na.rm = TRUE))  # Use density (peak) instead of total count
    }
  }
  
  # **Now generate histograms with consistent y-axis limits**
  for (donor in ordered_donors) {
    df_sub <- final_df_cellclass[final_df_cellclass$donor_id == donor, ]
    
    if (nrow(df_sub) == 0) {
      message(paste("No data for donor:", donor, "- skipping."))
      next
    }

    cell_count <- nrow(df_sub)
    
    a <- plot_overlapping_density_histogram(
      df = df_sub, 
      hist_col = df_sub[[score_col]],
      fill_col = "Condition",
      colors = c("XDP" = "red", "Control" = "blue", "BICAN_V8" = "green", 
                 "pd" = "red", "ctr" = "blue", "XDP_18_006" = "orange"),
      breaks = limits,
      title = paste0(donor, ": ", celltype, " (Cells: ", cell_count, ")"),
      xlab = xlab,
      fig_filename = NULL
    )
    
    # Modify the y-axis limit directly using ggplot2
    a <- a + ggplot2::ylim(0, max_peak_y)  # Set consistent y-axis limit
    
    plots[[donor]] <- a
  }
  
  final_plot <- plot_grid(plotlist = plots, ncol = 5)
  
  print(final_plot)  
  ggsave("combined_plot.png", final_plot, width = width_size, height = height_size)
}

```



```{r}
histograms_by_donor(XDP_astro_Cohorts_1_2@meta.data, "antigen_processing_scores", "SPN_matrix" ,"antigen_processing_scores", 25, 15)
```


```{r}
library(dplyr)
library(ggplot2)

data <- xdp_co1_meta
df = subset(data, subset = final_cell_class == "neuron")
df
df_avg <- df %>%
  group_by(donor_id, cause_of_death_case_control, Condition, cause_of_death) %>%
  summarise(avg_score = mean(Scoreinterferon_alpha), .groups = 'drop')
df_avg

# Plot the average score per donor for each condition
a = ggplot(df_avg, aes(x = Condition, y = avg_score, color = Condition, shape = cause_of_death)) +
  geom_point(aes(group = donor_id), size = 3, alpha = 0.8) + scale_color_manual(values = rev(scales::hue_pal()(2)))+ # One point per donor
  labs(x = "Condition", y = "Mean interferonalpha Score", color = "Condition", shape = "Cause of Death", title = "Astrocytes")+ scale_shape_manual(values = rev(c(16, 17))) +
  theme_minimal()+ theme(axis.text.x = element_text(angle = 45, hjust = 1))  + theme(
            plot.title = element_text(size = 20), # title font size
            axis.line = element_line(color = "black"),  # Add axis lines
            axis.ticks = element_line(color = "black"),  # Add axis ticks
            axis.text = element_text(size = 14),  # Increase tick label font size
            axis.title = element_text(size = 15),  # Increase axis label font size
            axis.text.x = element_text(angle = 45, hjust = 1)  # tilt axis labels
        )+
  theme(
    legend.text = element_text(size = 16),  # Increase legend text size
    legend.title = element_text(size = 18),  # Increase legend title size
   # legend.key.size = unit(1.5, "cm")  # Increase legend key size
  ) 

print(a)

ggsave(a, filename = "dotplot.png", width = 7, height = 6)

```


#wilcox test
```{r}
xdp_meta = xdp_co1_meta
xdp_meta = subset(xdp_meta, final_cell_class == "astrocyte")
xdp_meta

xdp_meta_cases = subset(xdp_meta, Condition == "XDP")
xdp_meta_controls = subset(xdp_meta, Condition == "Control")
xdp_meta_cases
xdp_meta_controls

XDP_scores <- xdp_meta_cases$ScoreNFKB  
XDP_Control_scores <- xdp_meta_controls$ScoreNFKB 

result1 <- wilcox.test(XDP_scores, XDP_Control_scores, alternative = "two.sided")
result2 <- wilcox.test(XDP_scores, XDP_Control_scores, alternative = "less")
result3 <- wilcox.test(XDP_scores, XDP_Control_scores, alternative = "greater")
print(result1)
print(result2)
print(result3)
```



```{r}
cleaned_CaH_Put_Cohort2_meta
xdp_co1_meta
```


```{r}
histograms_by_all_celltype(cleaned_CaH_Put_Cohort2_meta, "C_minus_scores", "C_minus_scores", 20, 10)
```

```{r}
histograms_by_all_celltype(xdp_co1_meta, "C_minus_scores", "C_minus_scores", 20, 10)
```


```{r}
histograms_by_donor(xdp_co1_meta, "ScoreNFKB", "astrocyte" ,"ScoreNFKB", 25, 15)
```

```{r}
table(cleaned_CaH_Put_Cohort2_meta$neuron_cell_class)
```








