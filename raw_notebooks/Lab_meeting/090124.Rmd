---
title: "R Notebook"
output: html_notebook
---

```{r}
library(Seurat)
library(ggplot2)
library(dplyr)
library(tidyr)
library(qs)
library(tibble)
library(gridExtra)
```

#functions: plot_histogram, SPN scoring 
```{r}
plot_overlapping_density_histogram = function(
  
    df, 
    hist_col,
    fill_col,
    colors = c("blue", "red"),
    alpha=0.5,
    breaks=seq(0, 16, 1),
    title= NULL,
    xlab = NULL,
    fig_filename = NULL

){
    # hist_col is the column you're making a histogram of (e.g. nUMI)
    # fill_col is the column you're coloring by (e.g. cell_class)
    # if fig_filename is not null, the plot will be saved to that file
     
    if (is.null(xlab)){
        xlab = hist_col
    }

    if (is.null(title)){
        title = paste0("Density Histogram of ", xlab, " by ", fill_col)
    }


    p = (
        ggplot(df, aes_string(x=hist_col, fill=fill_col)) 
        + geom_histogram(aes(y=..density..), alpha=alpha, position="identity", breaks=breaks)
        + labs(title=title, x=xlab, y="Density")    
        + theme(
                plot.title = element_text(size=16),
                axis.line = element_line(color = "black"),  # Add axis lines
                axis.ticks = element_line(color = "black"),  # Add axis ticks
                axis.text = element_text(size = 14),  # Increase tick label font size
                axis.title = element_text(size = 15)  # Increase axis label font size
            ) 
        + scale_fill_manual(values=colors)   
    )

    if (!is.null(fig_filename)){
        ggsave(fig_filename, p, width=8, height=6)
    }

    return(p)
}
```

#oh, I thought this is what you were already doing. In the future, do only this. And I think you should use the Bican average expressions for all datasets (i.e. don't divide by different averages in XDP cases and XDP controls)

```{r}
SPN_score_normalized = function(gene_df, SCtransform_counts, logfc_val, method = "multiply"){

significant_genes = unique(gene_df$gene)

exp = FetchData(SCtransform_counts, vars = significant_genes)

rownames(gene_df) = gene_df$gene
gene_df$gene = NULL

# Assuming gene_df and exp are your dataframes
logfc_df <- gene_df
counts_df <- exp

print(logfc_df)
print(counts_df)

# Check if all column names in counts_df are in the row names of logfc_df
if (!all(colnames(counts_df) %in% rownames(logfc_df))) {
  stop("Not all genes in counts_df are present in logfc_df")
}

# Reorder logfc_df to match the columns in counts_df
logfc_ordered <- logfc_df[colnames(counts_df), , drop = FALSE]
logfc_ordered

logfc = logfc_ordered[[logfc_val]]

# Check for NA values in logfc_ordered
if (any(is.na(logfc))) {
  stop("There are NA values in the logFC values for the genes")
}


# Ensure logfc_ordered$logfc is a numeric vector
logfc_vector <- as.numeric(logfc)
logfc_vector

 gene_averages <- colMeans(counts_df)
 print("Printing gene averages")
 print(gene_averages)
if (method == "multiply") {
  
#THE ACTUAL
result_df <- sweep(counts_df, 2, logfc_vector, FUN = "*")
} else if(method == "log"){
  custom_log_transform <- function(x, logFC_value) {
     x * 2^logFC_value
  }
  result_df <- sweep(counts_df, 2, logfc_vector, FUN = custom_log_transform)
} else{
  stop("Calculation is not working")
}
print(result_df)
# Divide each gene's expression by its average expression
 result_df <- sweep(result_df, 2, gene_averages, FUN = "/")

# Print the result
print("Printing normalized")
print(result_df)


metadata <- SCtransform_counts@meta.data
# Assume that metadata has a column 'donor' that contains donor information
# If not, modify this part according to your metadata structure
if(!"donor_id" %in% colnames(metadata)) {
  stop("Metadata does not contain 'donor' information. Please check your metadata structure.")
}

# Create unique identifiers for cell column to avoid conflicts
expr_data <- result_df %>%
  rownames_to_column(var = "cell_id")

metadata <- metadata %>%
  rownames_to_column(var = "cell_id")

# Combine expression data with donor information
expr_data_long <- expr_data %>%
  pivot_longer(cols = -cell_id, names_to = "gene", values_to = "expression") %>%
  left_join(metadata %>% select(cell_id, donor_id, Condition, cell_class, reclustered_cell_class, reclustered_neuron_type, reclustered_patch_matrix, reclustered_subcluster, reclustered_patch_matrix_exotic, reclustered_neuron_type_joint_cluster, pct_mito, nUmi, region), by = "cell_id")
# Assuming your data frame is named expr_data_long
print(expr_data_long)
# Count the number of occurrences for each gene per donor

summarized_expr_data <- expr_data_long %>%
  group_by(cell_id, donor_id, Condition, cell_class, reclustered_cell_class, reclustered_neuron_type, reclustered_patch_matrix, reclustered_subcluster, reclustered_patch_matrix_exotic, reclustered_neuron_type_joint_cluster, pct_mito, nUmi,region) %>%
  summarize(total_expression = sum(expression), .groups = 'drop')
print(summarized_expr_data)

for (donor in donor_order) {
    test <- summarized_expr_data[summarized_expr_data$donor_id == donor, ]
    test$scaled_score <- NA  # Initialize the new column
    cell_classes = unique(test$reclustered_patch_matrix_exotic)  
    for (class in cell_classes) {
        df = test[test$reclustered_patch_matrix_exotic == class, ]
        test$scaled_score[test$reclustered_patch_matrix_exotic == class] <- scale(df$total_expression)
    }
    summarized_expr_data[summarized_expr_data$donor_id == donor, "scaled_score"] <- test$scaled_score
}

# spn_scores = summarized_expr_data$total_expression
# mean_spn <- mean(spn_scores, na.rm = TRUE)
# sd_spn <- sd(spn_scores, na.rm = TRUE)
# # Compute the z-score for each SPN score
# summarized_expr_data$z_score  <- (spn_scores - mean_spn) / sd_spn

return(summarized_expr_data)

}

# # Add z-scores to Seurat object metadata
# caudate_neurons_transformed <- AddMetaData(caudate_neurons_transformed, metadata = spn_zscores, col.name = "SPN_zscore")
# 
# # Visualize SPN z-scores on UMAP
# plot <- FeaturePlot(caudate_neurons_transformed, features = "SPN_zscore") +
#   ggtitle("SPN Z-Score on UMAP")
# 
# # Save the UMAP plot with SPN z-scores as a PNG file
# ggsave("SPN_zscore_umap.png", plot = plot, width = 10, height = 8, dpi = 300)


SPN_score_graphs <- function(SPN_score_output, 
                             donor_order = donors, 
                             total_expression = "total_expression", 
                             fillcol = "reclustered_subcluster", 
                             color = color1, 
                             donor_graph_title = "CaH SPNs vs non-SPNs", 
                             SCtransformcounts, 
                             SPN_score_col_name, limits, xlab_name) {
  
  # Ensure total_expression is a string
  total_expression <- as.character(total_expression)
  
  # Calculate min, max, and median
  min_SPN_score <- min(SPN_score_output[[total_expression]], na.rm = TRUE)
  max_SPN_score <- max(SPN_score_output[[total_expression]], na.rm = TRUE)
  median_SPN_score <- median(SPN_score_output[[total_expression]], na.rm = TRUE)
  
  print("min, max, median scores")
  print(min_SPN_score)
  print(max_SPN_score)
  print(median_SPN_score)
  
  options(repr.plot.width = 24, repr.plot.height = 16)
  plots <- list()
  
  for (donor in donor_order) {
    test <- SPN_score_output[SPN_score_output$donor_id == donor, ]
    plots[[donor]] <- plot_overlapping_density_histogram(df = test,
                                                         hist_col = total_expression,
                                                         fill_col = fillcol,
                                                         colors = color,
                                                         breaks = limits,
                                                         title = paste(donor_graph_title, ": ", donor),
                                                         xlab = xlab_name,
                                                         fig_filename = NULL)
  }
  
  layout_matrix <- rbind(
    c(1, 2, 3, 4, 5),
    c(6, 7, 8, 9, 10),
    c(11, 12, 13, NA, NA),
    c(14, 15, 16, 17, NA)
  )
  
  # Arrange the plots according to the custom layout
  grid_plots <- grid.arrange(grobs = plots, layout_matrix = layout_matrix)
  
  # Save the arranged plots to a PNG file
  ggsave(filename = "~/SPN_SCORE_Output/USETEST.png", plot = grid_plots, width = 30, height = 16)
  
  print("donor plot done")
  
  XDP <- SPN_score_output[SPN_score_output$Condition == "XDP", ]
  a <- plot_overlapping_density_histogram(df = XDP, 
                                          hist_col = total_expression,
                                          fill_col = fillcol,
                                          colors = color,
                                          breaks = limits,
                                          title = paste(donor_graph_title, ": ", "XDP"),
                                          xlab = xlab_name,
                                          fig_filename = NULL)
  
  Control <- SPN_score_output[SPN_score_output$Condition == "Control", ]
  b <- plot_overlapping_density_histogram(df = Control, 
                                          hist_col = total_expression,
                                          fill_col = fillcol,
                                          colors = color,
                                          breaks = limits,
                                          title = paste(donor_graph_title, ": ", "Control"),
                                          xlab = xlab_name,
                                          fig_filename = NULL)
  
  print("Condition plot done")
  
    
  SPN <- SPN_score_output[SPN_score_output$reclustered_subcluster == "SPN", ]
  c <- plot_overlapping_density_histogram(df = SPN, 
                                          hist_col = total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue"),
                                          breaks = limits,
                                          title = "XDP vs Control: SPN",
                                          xlab = xlab_name,
                                          fig_filename = NULL)
  
  notSPN <- SPN_score_output[SPN_score_output$reclustered_subcluster == "non-SPN", ]
  d <- plot_overlapping_density_histogram(df = notSPN, 
                                          hist_col = total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue"),
                                          breaks = limits,
                                          title = "XDP vs Control: non-SPN",
                                          xlab = xlab_name,
                                          fig_filename = NULL)
  
  print(a)
  print(b)
  print(c)
  print(d)
  
  print("graphs done")
  
  # Calculate the threshold
  threshold <- quantile(SPN_score_output[[total_expression]][SPN_score_output[["reclustered_subcluster"]] == "SPN" & SPN_score_output[["Condition"]] == "XDP"], 0.1, na.rm = TRUE)
  print(threshold)
  
  # Subset the data
  SPN_score_output_identity_loss_SPN <- SPN_score_output[SPN_score_output[[total_expression]] < threshold & SPN_score_output[["reclustered_subcluster"]] == "SPN", ]
  
  print(SPN_score_output_identity_loss_SPN)
  print(table(SPN_score_output_identity_loss_SPN$donor_id))
  
  identity_loss_cells <- unique(SPN_score_output_identity_loss_SPN$cell_id)
  
  SCtransformcounts@meta.data$SPN_identity <- "Other"
  SCtransformcounts$SPN_identity[identity_loss_cells] <- "Bottom 10%"
  SCtransformcounts@meta.data
  
  # Visualize on UMAP
  pic <- DimPlot(SCtransformcounts, reduction = "umap", group.by = "SPN_identity", split.by = "Condition", cols = c("red", "grey"))
  print(pic)
  ggsave("~/SPN_SCORE_Output/SPN_score_10pct_TEST.png", plot = pic, width = 20, height = 8, units = "in", dpi = 300)
  
  spn_scores <- setNames(SPN_score_output[[total_expression]], SPN_score_output$cell_id)
  
  SCtransformcounts <- AddMetaData(SCtransformcounts, metadata = spn_scores, col.name = SPN_score_col_name)
  
  pic2 <- FeaturePlot(SCtransformcounts, features = SPN_score_col_name, split.by = "Condition")
  print(pic2)
  ggsave("~/SPN_SCORE_Output/SPN_UMAP_TEST.png", plot = pic2, width = 20, height = 8, units = "in", dpi = 300)
  
  return(SCtransformcounts)
}


BICAN_SPN_score_normalized = function(gene_df, SCtransform_counts, logfc_val, method = "multiply"){

significant_genes = unique(gene_df$gene)

exp = FetchData(SCtransform_counts, vars = significant_genes)

rownames(gene_df) = gene_df$gene
gene_df$gene = NULL

# Assuming gene_df and exp are your dataframes
logfc_df <- gene_df
counts_df <- exp

print(logfc_df)
print(counts_df)

# Check if all column names in counts_df are in the row names of logfc_df
if (!all(colnames(counts_df) %in% rownames(logfc_df))) {
  stop("Not all genes in counts_df are present in logfc_df")
}

# Reorder logfc_df to match the columns in counts_df
logfc_ordered <- logfc_df[colnames(counts_df), , drop = FALSE]
logfc_ordered

logfc = logfc_ordered[[logfc_val]]

# Check for NA values in logfc_ordered
if (any(is.na(logfc))) {
  stop("There are NA values in the logFC values for the genes")
}


# Ensure logfc_ordered$logfc is a numeric vector
logfc_vector <- as.numeric(logfc)
logfc_vector

gene_averages <- colMeans(counts_df)
print("Printing gene averages")
print(gene_averages)
if (method == "multiply") {
  
#THE ACTUAL
result_df <- sweep(counts_df, 2, logfc_vector, FUN = "*")
} else if(method == "log"){
  custom_log_transform <- function(x, logFC_value) {
     x * 2^logFC_value
  }
  result_df <- sweep(counts_df, 2, logfc_vector, FUN = custom_log_transform)
} else{
  stop("Calculation is not working")
}
print(result_df)
# Divide each gene's expression by its average expression
result_df <- sweep(result_df, 2, gene_averages, FUN = "/")

# Print the result
print("Printing normalized")
print(result_df)


metadata <- SCtransform_counts@meta.data
# Assume that metadata has a column 'donor' that contains donor information
# If not, modify this part according to your metadata structure
if(!"DONOR" %in% colnames(metadata)) {
  stop("Metadata does not contain 'donor' information. Please check your metadata structure.")
}

# Check if 'cell_id' column already exists and remove it
if ("cell_id" %in% colnames(metadata)) {
  metadata <- metadata %>% select(-cell_id)
}

# Ensure unique row names in result_df
if (any(duplicated(rownames(result_df)))) {
  stop("Row names in result_df are not unique. Please ensure unique row names.")
}


# Create unique identifiers for cell column to avoid conflicts
expr_data <- result_df %>%
  rownames_to_column(var = "cell_id")

metadata <- metadata %>%
  rownames_to_column(var = "cell_id")

# Combine expression data with donor information
expr_data_long <- expr_data %>%
  pivot_longer(cols = -cell_id, names_to = "gene", values_to = "expression") %>%
  left_join(metadata %>% select(cell_id, DONOR, subcluster, pct_mt, NUM_TRANSCRIPTS, reclustered_cell_class, reclustered_subcluster,reclustered_neuron_type,reclustered_patch_matrix,reclustered_neuron_joint_type), by = "cell_id")

# Assuming your data frame is named expr_data_long
print(expr_data_long)
# Count the number of occurrences for each gene per donor

summarized_expr_data <- expr_data_long %>%
  group_by(cell_id, DONOR, subcluster, pct_mt, NUM_TRANSCRIPTS, reclustered_cell_class, reclustered_subcluster,reclustered_neuron_type,reclustered_patch_matrix,reclustered_neuron_joint_type) %>%
  summarize(total_expression = sum(expression), .groups = 'drop')
print(summarized_expr_data)


for (donor in donor_order) {
    test <- summarized_expr_data[summarized_expr_data$DONOR == donor, ]
    test$scaled_score <- NA  # Initialize the new column
    cell_classes = unique(test$reclustered_neuron_joint_type)  
    for (class in cell_classes) {
        df = test[test$reclustered_neuron_joint_type == class, ]
        test$scaled_score[test$reclustered_neuron_joint_type == class] <- scale(df$total_expression)
    }
    summarized_expr_data[summarized_expr_data$DONOR == donor, "scaled_score"] <- test$scaled_score
}

# spn_scores = summarized_expr_data$total_expression
# mean_spn <- mean(spn_scores, na.rm = TRUE)
# sd_spn <- sd(spn_scores, na.rm = TRUE)
# # Compute the z-score for each SPN score
# summarized_expr_data$z_score  <- (spn_scores - mean_spn) / sd_spn

return(summarized_expr_data)
}


BICAN_SPN_score_graphs <- function(SPN_score_output, 
                             donor_order = BICANdonors, 
                             total_expression = "total_expression", 
                             fillcol = "subcluster", 
                             color = color1, 
                             donor_graph_title = "BICAN SPN Matrix vs non-SPNs", 
                             SCtransformcounts, 
                             SPN_score_col_name, limits,xlab_name) {
  
  # Ensure total_expression is a string
  total_expression <- as.character(total_expression)
  
  # Calculate min, max, and median
  min_SPN_score <- min(SPN_score_output[[total_expression]], na.rm = TRUE)
  max_SPN_score <- max(SPN_score_output[[total_expression]], na.rm = TRUE)
  median_SPN_score <- median(SPN_score_output[[total_expression]], na.rm = TRUE)
  
  print("min, max, median scores")
  print(min_SPN_score)
  print(max_SPN_score)
  print(median_SPN_score)
  
  options(repr.plot.width = 24, repr.plot.height = 16)
  plots <- list()
  
  for (donor in donor_order) {
    test <- SPN_score_output[SPN_score_output$DONOR == donor, ]
    plots[[donor]] <- plot_overlapping_density_histogram(df = test,
                                                         hist_col = total_expression,
                                                         fill_col = fillcol,
                                                         colors = color,
                                                         breaks = limits,
                                                         title = paste(donor_graph_title, ": ", donor),
                                                         xlab = xlab_name,
                                                         fig_filename = NULL)
  }
  
  layout_matrix <- rbind(
    c(1, 2, 3, 4, 5),
    c(6, 7, 8, 9, 10),
    c(11, 12, 13, 14, 15),
    c(16, 17, 18, 19, NA)
  )
  
  # Arrange the plots according to the custom layout
  grid_plots <- grid.arrange(grobs = plots, layout_matrix = layout_matrix)
  
  # Save the arranged plots to a PNG file
  ggsave(filename = "~/SPN_SCORE_Output/USETEST.png", plot = grid_plots, width = 30, height = 16)
  
  print("donor plot done")
  
  b <- plot_overlapping_density_histogram(df = SPN_score_output, 
                                          hist_col = total_expression,
                                          fill_col = fillcol,
                                          colors = color,
                                          breaks = limits,
                                          title = paste(donor_graph_title, ": ", "Control"),
                                          xlab = xlab_name,
                                          fig_filename = NULL)
  
  print("Condition plot done")
  

  
  # Calculate the threshold
  threshold <- quantile(SPN_score_output[[total_expression]][SPN_score_output[["reclustered_neuron_type"]] == "SPN"], 0.1, na.rm = TRUE)
  print(threshold)
  
  # Subset the data
  SPN_score_output_identity_loss_SPN <- SPN_score_output[SPN_score_output[[total_expression]] < threshold & SPN_score_output[["reclustered_neuron_type"]] == "SPN", ]
  
  print(SPN_score_output_identity_loss_SPN)
  print(table(SPN_score_output_identity_loss_SPN$DONOR))
  
  identity_loss_cells <- unique(SPN_score_output_identity_loss_SPN$cell_id)
  
  SCtransformcounts@meta.data$SPN_identity <- "Other"
  SCtransformcounts$SPN_identity[identity_loss_cells] <- "Bottom 10%"
  SCtransformcounts@meta.data
  
  # Visualize on UMAP
  pic <- DimPlot(SCtransformcounts, reduction = "umap", group.by = "SPN_identity", cols = c("red", "grey")) 
  print(pic)
  ggsave("~/SPN_SCORE_Output/SPN_score_10pct_TEST.png", plot = pic, width = 20, height = 8, units = "in", dpi = 300)
  
  spn_scores <- setNames(SPN_score_output[[total_expression]], SPN_score_output$cell_id)
  
  SCtransformcounts <- AddMetaData(SCtransformcounts, metadata = spn_scores, col.name = SPN_score_col_name)
  
  pic2 <- FeaturePlot(SCtransformcounts, features = SPN_score_col_name)
  print(pic2)
  ggsave("~/SPN_SCORE_Output/SPN_UMAP_TEST.png", plot = pic2, width = 20, height = 8, units = "in", dpi = 300)
  
  return(SCtransformcounts)
}

```

```{r}
donor_order
```


#new scoring function (divide by BICAN Matrix average expression)
```{r}
Cell_Scorer = function(gene_df, SCtransform_counts, Reference_SCT_counts = final_V8_BICAN_neurons, logfc_val, method = "multiply", score_region = "SPN_matrix", type, donor_order1){

significant_genes = unique(gene_df$gene)

counts_df = FetchData(SCtransform_counts, vars = significant_genes)

rownames(gene_df) = gene_df$gene
gene_df$gene = NULL

# Assuming gene_df and exp are your dataframes
logfc_df <- gene_df

print(logfc_df)
print(counts_df)

# Check if all column names in counts_df are in the row names of logfc_df
if (!all(colnames(counts_df) %in% rownames(logfc_df))) {
  stop("Not all genes in counts_df are present in logfc_df")
}

# Reorder logfc_df to match the columns in counts_df
logfc_ordered <- logfc_df[colnames(counts_df), , drop = FALSE]
logfc_ordered

logfc = logfc_ordered[[logfc_val]]

# Check for NA values in logfc_ordered
if (any(is.na(logfc))) {
  stop("There are NA values in the logFC values for the genes")
}


# Ensure logfc_ordered$logfc is a numeric vector
logfc_vector <- as.numeric(logfc)
logfc_vector


BICAN_counts_df = FetchData(Reference_SCT_counts, vars = significant_genes)
matrix_cells = subset(Reference_SCT_counts, subset = reclustered_neuron_joint_type == score_region)
matrix_cells_names = rownames(matrix_cells@meta.data)
matrix_cells_names

matrix_counts_df <- subset(BICAN_counts_df, rownames(BICAN_counts_df) %in% matrix_cells_names)
matrix_counts_df

gene_averages <- colMeans(matrix_counts_df)
print("Printing gene averages")
print(gene_averages)

if (method == "multiply") {
  
#THE ACTUAL
result_df <- sweep(counts_df, 2, logfc_vector, FUN = "*")
} else if(method == "log"){
  custom_log_transform <- function(x, logFC_value) {
     x * 2^logFC_value
  }
  result_df <- sweep(counts_df, 2, logfc_vector, FUN = custom_log_transform)
} else{
  stop("Calculation is not working")
}
print(result_df)
# Divide each gene's expression by its average expression
gene_averages <- gene_averages[colnames(result_df)]
 result_df <- sweep(result_df, 2, gene_averages, FUN = "/")

# Print the result
print("Printing normalized")
print(result_df)


metadata <- SCtransform_counts@meta.data
# Assume that metadata has a column 'donor' that contains donor information
# If not, modify this part according to your metadata structure
if(!"donor_id" %in% colnames(metadata)) {
  stop("Metadata does not contain 'donor' information. Please check your metadata structure.")
}

# Check if 'cell_id' column already exists and remove it
if ("cell_id" %in% colnames(metadata)) {
  metadata <- metadata %>% select(-cell_id)
}

# Ensure unique row names in result_df
if (any(duplicated(rownames(result_df)))) {
  stop("Row names in result_df are not unique. Please ensure unique row names.")
}

# Create unique identifiers for cell column to avoid conflicts
expr_data <- result_df %>%
  rownames_to_column(var = "cell_id")

metadata <- metadata %>%
  rownames_to_column(var = "cell_id")

# Combine expression data with donor information

if (type == "XDP") {
expr_data_long <- expr_data %>%
  pivot_longer(cols = -cell_id, names_to = "gene", values_to = "expression") %>%
  left_join(metadata %>% select(cell_id, donor_id, Condition, cell_class, reclustered_cell_class, reclustered_neuron_type, reclustered_patch_matrix, reclustered_subcluster, reclustered_patch_matrix_exotic, reclustered_neuron_type_joint_cluster, pct_mito, nUmi, region), by = "cell_id")
# Assuming your data frame is named expr_data_long
print(expr_data_long)
# Count the number of occurrences for each gene per donor

summarized_expr_data <- expr_data_long %>%
  group_by(cell_id, donor_id, Condition, cell_class, reclustered_cell_class, reclustered_neuron_type, reclustered_patch_matrix, reclustered_subcluster, reclustered_patch_matrix_exotic, reclustered_neuron_type_joint_cluster, pct_mito, nUmi,region) %>%
  summarize(total_expression = sum(expression), .groups = 'drop')
print(summarized_expr_data)

for (donor in donor_order1) {
    test <- summarized_expr_data[summarized_expr_data$donor_id == donor, ]
    test$scaled_score <- NA  # Initialize the new column
    cell_classes = unique(test$reclustered_patch_matrix_exotic)  
    for (class in cell_classes) {
        df = test[test$reclustered_patch_matrix_exotic == class, ]
        test$scaled_score[test$reclustered_patch_matrix_exotic == class] <- scale(df$total_expression)
    }
    summarized_expr_data[summarized_expr_data$donor_id == donor, "scaled_score"] <- test$scaled_score
}

} else if (type == "BICAN") {
  expr_data_long <- expr_data %>%
  pivot_longer(cols = -cell_id, names_to = "gene", values_to = "expression") %>%
  left_join(metadata %>% select(cell_id, DONOR, subcluster, pct_mt, NUM_TRANSCRIPTS, reclustered_cell_class, reclustered_subcluster,reclustered_neuron_type,reclustered_patch_matrix,reclustered_patch_matrix_exotic,reclustered_neuron_joint_type), by = "cell_id")

# Assuming your data frame is named expr_data_long
print(expr_data_long)
# Count the number of occurrences for each gene per donor

summarized_expr_data <- expr_data_long %>%
  group_by(cell_id, DONOR, subcluster, pct_mt, NUM_TRANSCRIPTS, reclustered_cell_class, reclustered_subcluster,reclustered_neuron_type,reclustered_patch_matrix,reclustered_patch_matrix_exotic,reclustered_neuron_joint_type) %>%
  summarize(total_expression = sum(expression), .groups = 'drop')
print(summarized_expr_data)

for (donor in donor_order1) {
    test <- summarized_expr_data[summarized_expr_data$DONOR == donor, ]
    test$scaled_score <- NA  # Initialize the new column
    cell_classes = unique(test$reclustered_patch_matrix_exotic)  
    for (class in cell_classes) {
        df = test[test$reclustered_patch_matrix_exotic == class, ]
        test$scaled_score[test$reclustered_patch_matrix_exotic == class] <- scale(df$total_expression)
    }
    summarized_expr_data[summarized_expr_data$DONOR == donor, "scaled_score"] <- test$scaled_score
}
}

return(summarized_expr_data)
}
```




#files to load
```{r}
final_V8_BICAN_neurons = qread("~/SOBJ_USE_THESE/final_V8_BICAN_neurons.qs")
final_V8_BICAN_neurons = subset(final_V8_BICAN_neurons, subset = DONOR != "MD6701")
final_V8_BICAN_neurons

final_merged_xdp_transformed = qread("~/SOBJ_USE_THESE/final_merged_xdp_transformed_081224.qs")
final_merged_xdp_transformed

final_V17_BICAN_neurons = qread("~/SOBJ_USE_THESE/final_V17_BICAN_neurons.qs")
final_V17_BICAN_neurons

Idents(final_V8_BICAN_neurons) = "reclustered_patch_matrix"

Intersected_BICAN_matrix_markers_final_filtered = qread("~/SPN_Matrix_BICAN_findmarkers.qs")
Intersected_BICAN_matrix_markers_final_filtered

final_V8_BICAN_neurons@meta.data$donor_id = final_V8_BICAN_neurons$DONOR
final_V8_BICAN_neurons@meta.data$reclustered_patch_matrix_exotic = final_V8_BICAN_neurons$reclustered_neuron_joint_type
final_V17_BICAN_neurons@meta.data$donor_id = final_V17_BICAN_neurons$DONOR

```

```{r}
donor_order = c("PCMC-16-011","PCMC-16-012", "SCF-18-003", "SCF-18-004", "SCF-18-006", "SCF-19-009", "SCF-19-014",  "SCF-19-018", "SCF-20-023", "SCF_20-024", "SCF-20-025", "SCF-21-030", "SCF_22-043","SCF_21-037CM2","SCF-22-054CM", "SCF-22-058CF","SCF-23-068CM") 

BICANdonors = unique(final_V8_BICAN_neurons$DONOR)
BICANdonors

BICANdonors1 = unique(final_V17_BICAN_neurons$DONOR)
BICANdonors1
```


```{r}
XDP_matrix_scores = Cell_Scorer(Intersected_BICAN_matrix_markers_final_filtered, final_merged_xdp_transformed, logfc_val = "weighted_logFC", method = "multiply", type = "XDP", donor_order1 = donor_order)

XDP_matrix_scores$Village = "XDP"
XDP_matrix_scores
```


```{r}
V8_BICAN_scores = Cell_Scorer(Intersected_BICAN_matrix_markers_final_filtered, final_V8_BICAN_neurons, logfc_val = "weighted_logFC", method = "multiply", type = "BICAN", donor_order1 = BICANdonors)
V8_BICAN_scores$Village = "BICAN_V8"
V8_BICAN_scores

V17_BICAN_scores = Cell_Scorer(Intersected_BICAN_matrix_markers_final_filtered, final_V17_BICAN_neurons, logfc_val = "weighted_logFC", method = "multiply",type = "BICAN", donor_order1 = BICANdonors)
V17_BICAN_scores$Village = "BICAN_V17"
V17_BICAN_scores
```


```{r}
V17_BICAN_scores$reclustered_patch_matrix_exotic = V17_BICAN_scores$reclustered_neuron_joint_type
 V17_BICAN_scores$reclustered_patch_matrix_exotic[V17_BICAN_scores$reclustered_cell_class == "D1_patch_exotic" | V17_BICAN_scores$reclustered_cell_class == "D2_patch_exotic"] = "SPN_exotic"
table(V17_BICAN_scores$reclustered_patch_matrix_exotic)

library(dplyr)
XDP_matrix_scores_df = XDP_matrix_scores %>% select(cell_id, donor_id, Condition, reclustered_patch_matrix_exotic, reclustered_patch_matrix, reclustered_neuron_type_joint_cluster,  pct_mito, nUmi, total_expression, scaled_score, Village)

BICAN_matrix_scores_df_V8 = V8_BICAN_scores %>% select(cell_id, DONOR, reclustered_patch_matrix, reclustered_neuron_joint_type,  pct_mt, NUM_TRANSCRIPTS, total_expression , scaled_score, Village) 

BICAN_matrix_scores_df_V17 = V17_BICAN_scores %>% select(cell_id, DONOR, reclustered_patch_matrix, reclustered_neuron_joint_type,reclustered_patch_matrix_exotic,  pct_mt, NUM_TRANSCRIPTS, total_expression , scaled_score, Village) 

BICAN_matrix_scores_df_V8$Condition = "BICAN Control V8"
BICAN_matrix_scores_df_V8$reclustered_patch_matrix_exotic = BICAN_matrix_scores_df_V8$reclustered_neuron_joint_type
BICAN_matrix_scores_df_V8$reclustered_neuron_type_joint_cluster = BICAN_matrix_scores_df_V8$reclustered_neuron_joint_type
BICAN_matrix_scores_df_V8$reclustered_neuron_joint_type = NULL
BICAN_matrix_scores_df_V8$pct_mito = BICAN_matrix_scores_df_V8$pct_mt 
BICAN_matrix_scores_df_V8$pct_mt  = NULL
BICAN_matrix_scores_df_V8$nUmi = BICAN_matrix_scores_df_V8$NUM_TRANSCRIPTS 
BICAN_matrix_scores_df_V8$NUM_TRANSCRIPTS  = NULL
BICAN_matrix_scores_df_V8$donor_id = BICAN_matrix_scores_df_V8$DONOR 
BICAN_matrix_scores_df_V8$DONOR  = NULL

BICAN_matrix_scores_df_V17$Condition = "BICAN Control V17"
BICAN_matrix_scores_df_V17$reclustered_neuron_type_joint_cluster = BICAN_matrix_scores_df_V17$reclustered_neuron_joint_type
BICAN_matrix_scores_df_V17$reclustered_neuron_joint_type = NULL
BICAN_matrix_scores_df_V17$pct_mito = BICAN_matrix_scores_df_V17$pct_mt 
BICAN_matrix_scores_df_V17$pct_mt  = NULL
BICAN_matrix_scores_df_V17$nUmi = BICAN_matrix_scores_df_V17$NUM_TRANSCRIPTS 
BICAN_matrix_scores_df_V17$NUM_TRANSCRIPTS  = NULL
BICAN_matrix_scores_df_V17$donor_id = BICAN_matrix_scores_df_V17$DONOR 
BICAN_matrix_scores_df_V17$DONOR  = NULL

XDP_matrix_scores_df
BICAN_matrix_scores_df_V8
BICAN_matrix_scores_df_V17

Combined_scores_df = rbind(XDP_matrix_scores_df, BICAN_matrix_scores_df_V8, BICAN_matrix_scores_df_V17)
Combined_scores_df

table(Combined_scores_df$Condition, Combined_scores_df$reclustered_patch_matrix_exotic)
table(Combined_scores_df$Condition, Combined_scores_df$reclustered_neuron_type_joint_cluster)

min(Combined_scores_df$total_expression)
max(Combined_scores_df$total_expression)
```
```{r}
min(XDP_matrix_scores$total_expression)
max(XDP_matrix_scores$total_expression)
```


```{r}
Idents(final_merged_xdp_transformed) = "reclustered_patch_matrix_exotic"
DimPlot(final_merged_xdp_transformed, label = T)
```


```{r}
limits = seq(0, 120, 1)
xlab_name = "SPN Matrix Score"
matrix <- XDP_matrix_scores[XDP_matrix_scores$reclustered_patch_matrix_exotic == "SPN_matrix", ]
  plot_overlapping_density_histogram(df = matrix, 
                                          hist_col = matrix$total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue"),
                                          breaks = limits,
                                          title = "XDP vs Control: SPN matrix",
                                          xlab = xlab_name,
                                          fig_filename = NULL)
```


```{r}

limits = seq(0, 120, 1)
xlab_name = "SPN Matrix Score"
matrix <- Combined_scores_df[Combined_scores_df$reclustered_patch_matrix_exotic == "SPN_matrix", ]
  plot_overlapping_density_histogram(df = matrix, 
                                          hist_col = matrix$total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue", "BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: SPN matrix",
                                          xlab = xlab_name,
                                          fig_filename = NULL)
  patch <- Combined_scores_df[Combined_scores_df$reclustered_patch_matrix_exotic == "SPN_patch", ]
  plot_overlapping_density_histogram(df = patch, 
                                          hist_col = patch$total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue", "BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: SPN patch",
                                          xlab = xlab_name,
                                          fig_filename = NULL)
  nonSPN <- Combined_scores_df[Combined_scores_df$reclustered_patch_matrix_exotic == "non-SPN", ]
  plot_overlapping_density_histogram(df = nonSPN, 
                                          hist_col = nonSPN$total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue","BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: non-SPN",
                                          xlab = xlab_name,
                                          fig_filename = NULL)
    exotic <- Combined_scores_df[Combined_scores_df$reclustered_patch_matrix_exotic == "SPN_exotic", ]
  plot_overlapping_density_histogram(df = exotic, 
                                          hist_col = exotic$total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue","BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: Exotic SPN",
                                          xlab = xlab_name,
                                          fig_filename = NULL)
    eSPN <- Combined_scores_df[Combined_scores_df$reclustered_patch_matrix_exotic == "eSPN", ]
  plot_overlapping_density_histogram(df = eSPN, 
                                          hist_col = eSPN$total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue","BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: eSPN",
                                          xlab = xlab_name,
                                          fig_filename = NULL)
```
```{r}
color4 = c("SPN_matrix" = "red", "non-SPN" = "blue", "SPN_patch" = "orange")

color1 = c("SPN" = "red", "non-SPN"= "blue") #for subcluster: SPN vs non-SPNS
color2 = c("SPN_matrix" ="red", "non-SPN"="blue")
color3 = c("SPN"="red", "eSPN"="yellow", "other"="green", "IN" = "blue") #for subclass

color5 = c("SPN_matrix"="red", "SPN_patch" = "orange","eSPN"="green", "non-SPN" = "blue") 
color6 = c("SPN_matrix"="red", "SPN_patch" = "orange","SPN_exotic" = "yellow",  "eSPN"="green", "non-SPN" = "blue") 
```

```{r}
SPN_score_graphs(XDP_matrix_scores, 
                             donor_order = donor_order, 
                             total_expression = "total_expression", 
                             fillcol = "reclustered_patch_matrix_exotic", 
                             color = color6, 
                             donor_graph_title = "XDP Matrix SPN scores", 
                             final_merged_xdp_transformed, 
                             SPN_score_col_name ="SPN_Matrix_Score", xlab_name = "SPN Matrix Score", limits = seq(100, 600, 10)) 
```


```{r}
weighted_scores$test = "weighted_logFC"
Combined_scores_df$test = "avg_log2FC"

a = merge(weighted_scores,Combined_scores_df, by = "cell_id")
a
```
```{r}
classes= unique(a$reclustered_patch_matrix_exotic.x)
for (class in classes) {
  test = subset(a, subset = reclustered_patch_matrix_exotic.x == class)
  d = ggplot(data = test, aes(x = total_expression.x, y = total_expression.y, color = Condition.y)) + geom_point(alpha = 0.4) + ggtitle(paste(class)) + xlab("Scores using weighted logFC")+ ylab("Scores using  avglog2FC") 
  print(d)
}

```

#It feels like it should be possible to inspect this. Like if you order genes by their average contribution to the score, are those rankings super different in Bican and XDP? Or plotting genes' average contribution to the score against their average expression within XDP matrix? or against their average expression within BICAN matrix?
```{r}
gene_df = Intersected_BICAN_matrix_markers_final_filtered
rownames(gene_df) = gene_df$gene
gene_df$gene = NULL
# Assuming gene_df and exp are your dataframes
logfc_df <- gene_df
print(logfc_df)
```


```{r}
counts_df = FetchData(SCtransform_counts, vars = significant_genes)
print(counts_df)

# Check if all column names in counts_df are in the row names of logfc_df
if (!all(colnames(counts_df) %in% rownames(logfc_df))) {
  stop("Not all genes in counts_df are present in logfc_df")
}

# Reorder logfc_df to match the columns in counts_df
logfc_ordered <- logfc_df[colnames(counts_df), , drop = FALSE]
logfc_ordered

logfc = logfc_ordered[[logfc_val]]

# Check for NA values in logfc_ordered
if (any(is.na(logfc))) {
  stop("There are NA values in the logFC values for the genes")
}


# Ensure logfc_ordered$logfc is a numeric vector
logfc_vector <- as.numeric(logfc)
logfc_vector

result_df <- sweep(counts_df, 2, logfc_vector, FUN = "*")

```

```{r}
logfc_val = "weighted_logFC"
significant_genes = unique(Intersected_BICAN_matrix_markers_final_filtered$gene)

XDP_counts_df = FetchData(final_XDP, vars = significant_genes)
XDP_matrix_cells = subset(final_XDP, subset = reclustered_patch_matrix_exotic == "SPN_matrix")
XDP_matrix_cells_names = rownames(XDP_matrix_cells@meta.data)
XDP_matrix_counts_df <- subset(XDP_counts_df, rownames(XDP_counts_df) %in% XDP_matrix_cells_names)

counts_df =XDP_matrix_counts_df 
# Check if all column names in counts_df are in the row names of logfc_df
if (!all(colnames(counts_df) %in% rownames(logfc_df))) {
  stop("Not all genes in counts_df are present in logfc_df")
}

# Reorder logfc_df to match the columns in counts_df
logfc_ordered <- logfc_df[colnames(counts_df), , drop = FALSE]

logfc = logfc_ordered[[logfc_val]]

# Check for NA values in logfc_ordered
if (any(is.na(logfc))) {
  stop("There are NA values in the logFC values for the genes")
}


# Ensure logfc_ordered$logfc is a numeric vector
logfc_vector <- as.numeric(logfc)
XDP_result_df <- sweep(counts_df, 2, logfc_vector, FUN = "*")
XDP_result_df

XDP_Control_counts_df = FetchData(final_Control, vars = significant_genes)
XDP_Control_matrix_cells = subset(final_Control, subset = reclustered_patch_matrix_exotic == "SPN_matrix")
XDP_Control_matrix_cells_names = rownames(XDP_Control_matrix_cells@meta.data)
XDP_Control_matrix_counts_df <- subset(XDP_Control_counts_df, rownames(XDP_Control_counts_df) %in% XDP_Control_matrix_cells_names)

counts_df =XDP_Control_matrix_counts_df 
# Check if all column names in counts_df are in the row names of logfc_df
if (!all(colnames(counts_df) %in% rownames(logfc_df))) {
  stop("Not all genes in counts_df are present in logfc_df")
}

# Reorder logfc_df to match the columns in counts_df
logfc_ordered <- logfc_df[colnames(counts_df), , drop = FALSE]
logfc = logfc_ordered[[logfc_val]]

# Check for NA values in logfc_ordered
if (any(is.na(logfc))) {
  stop("There are NA values in the logFC values for the genes")
}

# Ensure logfc_ordered$logfc is a numeric vector
logfc_vector <- as.numeric(logfc)

XDP_Control_result_df <- sweep(counts_df, 2, logfc_vector, FUN = "*")
XDP_Control_result_df

BICAN_counts_df = FetchData(final_V8_BICAN_neurons, vars = significant_genes)
matrix_cells = subset(final_V8_BICAN_neurons, subset = reclustered_neuron_joint_type == "SPN_matrix")
matrix_cells_names = rownames(matrix_cells@meta.data)
matrix_counts_df <- subset(BICAN_counts_df, rownames(BICAN_counts_df) %in% matrix_cells_names)

counts_df =matrix_counts_df 
# Check if all column names in counts_df are in the row names of logfc_df
if (!all(colnames(counts_df) %in% rownames(logfc_df))) {
  stop("Not all genes in counts_df are present in logfc_df")
}

# Reorder logfc_df to match the columns in counts_df
logfc_ordered <- logfc_df[colnames(counts_df), , drop = FALSE]

logfc = logfc_ordered[[logfc_val]]

# Check for NA values in logfc_ordered
if (any(is.na(logfc))) {
  stop("There are NA values in the logFC values for the genes")
}


# Ensure logfc_ordered$logfc is a numeric vector
logfc_vector <- as.numeric(logfc)

BICAN_result_df <- sweep(counts_df, 2, logfc_vector, FUN = "*")

```

```{r}
XDP_result_avg = colMeans(XDP_result_df)
XDP_Control_result_avg = colMeans(XDP_Control_result_df)
BICAN_result_avg = colMeans(BICAN_result_df)
XDP_result_avg
XDP_Control_result_avg
BICAN_result_avg
```


```{r}
 a= as.data.frame(XDP_result_avg)
a$gene = rownames(a)
b= as.data.frame(BICAN_result_avg)
b$gene = rownames(b)
c= as.data.frame(XDP_Control_result_avg)
c$gene = rownames(c)
d= merge(a, b, by = "gene")
d= merge(d, c, by = "gene")
d
```

```{r}
 e= as.data.frame(XDP_gene_averages)
e$gene = rownames(e)
 f= as.data.frame(XDP_Control_gene_averages)
f$gene = rownames(f)
 g= as.data.frame(gene_averages)
g$gene = rownames(g)

h= merge(d, e, by = "gene")
h= merge(h, f, by = "gene")
h= merge(h, g, by = "gene")
h

write.csv(h, "~/gene_expression_weight.csv")
```

```{r}
ggplot(data = c, aes(x = XDP_result_avg, y = XDP_gene_averages)) + geom_point(alpha = 0.4, color = "red") + xlab("XDP gene weights")+ ylab("XDP average gene expression") #+ geom_text(aes(label = gene), hjust = 0.5, vjust = -0.5, size = 3) 

ggplot(data = c, aes(x = BICAN_result_avg, y = XDP_Control_gene_averages)) + geom_point(alpha = 0.4, color = "red") + xlab("BICAN Control gene weights")+ ylab("XDP Control average gene expression") + geom_text(aes(label = gene), hjust = 0.5, vjust = -0.5, size = 3) 

ggplot(data = c, aes(x = BICAN_result_avg, y = gene_averages)) + geom_point(alpha = 0.4, color = "red") + xlab("BICAN gene weights")+ ylab("BICAN average gene expression") + geom_text(aes(label = gene), hjust = 0.5, vjust = -0.5, size = 3) 
```


```{r}
ggplot(data = c, aes(x = XDP_result_avg, y = BICAN_result_avg)) + geom_point(alpha = 0.4, color = "red") + xlab("XDP gene weights")+ ylab("BICAN V8 gene weights") #+ geom_text(aes(label = gene), hjust = 0.5, vjust = -0.5, size = 3) 

ggplot(data = c, aes(x = XDP_Control_result_avg, y = BICAN_result_avg)) + geom_point(alpha = 0.4, color = "red") + xlab("XDP Control gene weights")+ ylab("BICAN V8 gene weights") #+ geom_text(aes(label = gene), hjust = 0.5, vjust = -0.5, size = 3) 

ggplot(data = c, aes(x = XDP_result_avg, y = XDP_Control_result_avg)) + geom_point(alpha = 0.4, color = "red") + xlab("XDP gene weights")+ ylab("XDP Control gene weights") #+ geom_text(aes(label = gene), hjust = 0.5, vjust = -0.5, size = 3) 
```




```{r}
BICAN_SPN_score_graphs(V8_BICAN_scores, 
                             donor_order = BICANdonors, 
                             total_expression = "total_expression", 
                             fillcol = "reclustered_neuron_joint_type", 
                             color = color2, 
                             donor_graph_title = "BICAN Matrix SPN scores", 
                             final_V8_BICAN_neurons, 
                             SPN_score_col_name = "BICAN_SPN_Matrix_Score", xlab_name = "SPN Matrix Score", limits = seq(0, 120, 2))
```

```{r}
BICAN_SPN_score_graphs(V17_BICAN_scores, 
                             donor_order = BICANdonors1, 
                             total_expression = "total_expression", 
                             fillcol = "reclustered_patch_matrix_exotic", 
                             color = color2, 
                             donor_graph_title = "BICAN Matrix SPN scores", 
                             final_V17_BICAN_neurons, 
                             SPN_score_col_name = "BICAN_SPN_Matrix_Score", xlab_name = "SPN Matrix Score", limits = seq(0, 120, 2))
```



#AddModuleScores
```{r}
Combined_scores_df
```


```{r}
spn_genes = c("PMS2", "MSH3")
  
  #c("MSH2", "MSH3", "PMS2", "POLD3", "LIG1", "RFC5", "RFC3", "RFC4", "MLH3", "MSH6", "POLE", "MLH1", "RFC2", "RFC1", "PMS1", "PCNA", "PARP1") 

  #c("HLA-A", "HLA-B", "HLA-C", "HLA-F")
  
  #c("BAX", "BAK1", "BID", "BCL2L11", "BAD", "BBC3", "PMAIP1",  "HRK", "CYCS", "SMAC", "AIFM1", "CASP9", "CASP3", "CASP7")
  
  #c("PARP1", "TDG", "LIG3", "OGG1", "TDP1", "UNG", "APEX1", "XRCC1", "NEIL1", "TOP1", "POLB", "HMGB1")

  #Intersected_BICAN_matrix_markers_final_filtered$gene
  
  
  #c("MSH2", "MSH3", "PMS2", "POLD3", "LIG1", "RFC5", "RFC3", "RFC4", "MLH3", "MSH6", "POLE", "MLH1", "RFC2", "RFC1", "PMS1", "PCNA", "PARP1")
  
  #c("PARP1", "TDG", "LIG3", "OGG1", "TDP1", "UNG", "APEX1", "XRCC1", "NEIL1", "TOP1", "POLB", "HMGB1")
  

spn_genes
```

```{r}
a =FindMarkers(final_V8_BICAN_neurons, ident.1 = "SPN_matrix", ident.2 = "non-SPN", min.pct = 0.5, only.pos = TRUE)
b = subset(a, pct.2 <0.2)
b
```


#Add module score
```{r}
# Add SPN score
seurat_obj <- AddModuleScore(
  object = seurat_obj,
  features = list(SPN = spn_genes),
  name = 'MSH3_PMS2_score'
)
new_df = seurat_obj@meta.data 
new_df
```


```{r}
min(new_df$MSH3_PMS2_score1)
max(new_df$MSH3_PMS2_score1)
```


```{r}
# Define a threshold to identify low SPN score cells
threshold <- quantile(seurat_obj@meta.data$SPN_Matrix_Score1, 0.1)  # Example threshold at the 10th percentile

# Find cells with low SPN scores
low_spn_cells <- seurat_obj@meta.data[seurat_obj@meta.data$SPN_Matrix_Score1 < threshold, ]

# Visualize
DimPlot(seurat_obj, group.by = "SPN_Matrix_Score1", split.by = "Condition")

```


```{r}
limits = seq(-0.8, 1.4, 0.02)

matrix <- new_df[new_df$reclustered_patch_matrix_exotic == "SPN_matrix", ]
  plot_overlapping_density_histogram(df = matrix, 
                                          hist_col = matrix$MSH3_PMS2_score1,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue", "BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: SPN matrix",
                                          xlab = "MHS3_PMS2 score",
                                          fig_filename = NULL)
  
  patch <- new_df[new_df$reclustered_patch_matrix_exotic == "SPN_patch", ]
  plot_overlapping_density_histogram(df = patch, 
                                          hist_col = patch$MSH3_PMS2_score1,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue", "BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: SPN patch",
                                          xlab = "MHS3_PMS2 score",
                                          fig_filename = NULL)
  nonSPN <- new_df[new_df$reclustered_patch_matrix_exotic == "non-SPN", ]
  plot_overlapping_density_histogram(df = nonSPN, 
                                          hist_col = nonSPN$MSH3_PMS2_score1,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue","BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: non-SPN",
                                          xlab = "MHS3_PMS2 score",
                                          fig_filename = NULL)
    exotic <- new_df[new_df$reclustered_patch_matrix_exotic == "SPN_exotic", ]
  plot_overlapping_density_histogram(df = exotic, 
                                          hist_col = exotic$MSH3_PMS2_score1,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue","BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: Exotic SPN",
                                          xlab = "MHS3_PMS2 score",
                                          fig_filename = NULL)
    eSPN <- new_df[new_df$reclustered_patch_matrix_exotic == "eSPN", ]
  plot_overlapping_density_histogram(df = eSPN, 
                                          hist_col = eSPN$MSH3_PMS2_score1,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue","BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: eSPN",
                                          xlab = "MHS3_PMS2 score",
                                          fig_filename = NULL)
```

```{r}
average_scores_df <- data.frame(donor_id = character(), MSH3_PMS2_score = numeric(), stringsAsFactors = FALSE)

new_df1 = subset(new_df, subset = reclustered_patch_matrix_exotic == "non-SPN")
new_df1
for (donor in donor_order) {
  test <- subset(new_df1, donor_id == donor)
  average_SPN_matrix <- mean(test$MSH3_PMS2_score1, na.rm = TRUE)
  average_scores_df <- rbind(average_scores_df, data.frame(donor_id = donor, MSH3_PMS2_score = average_SPN_matrix))
}

average_scores_df$Condition = ifelse(grepl("SCF_21-037CM2|SCF-23-068CM|SCF-22-058CF|SCF-22-054CM", average_scores_df$donor_id), "Control", "XDP")

print(average_scores_df)

XDP_MMR_scores_cases = subset(average_scores_df, subset = Condition == "XDP")
XDP_MMR_scores_cases
XDP_MMR_scores_controls = subset(average_scores_df, subset = Condition == "Control") 
XDP_MMR_scores_controls

 ggplot(average_scores_df, aes(x = Condition, y = MSH3_PMS2_score, color = donor_id)) +
  geom_jitter(width = 0.2, height = 0) +  # Adjust width for horizontal jitter
  labs(x = "Condition", y = "Average MSH3_PMS2 scores", title = "SPN_matrix") +
  theme_minimal()

XDP_MMR_scores <- XDP_MMR_scores_cases$MSH3_PMS2_score  
XDP_Control_MMR_scores <- XDP_MMR_scores_controls$MSH3_PMS2_score 
XDP_MMR_scores
XDP_Control_MMR_scores

result1 <- wilcox.test(XDP_MMR_scores, XDP_Control_MMR_scores, alternative = "two.sided")
result2 <- wilcox.test(XDP_MMR_scores, XDP_Control_MMR_scores, alternative = "less")
result3 <- wilcox.test(XDP_MMR_scores, XDP_Control_MMR_scores, alternative = "greater")
print(result1)
print(result2)
print(result3)

```




```{r}
color3 = c("SPN_matrix" = "red")
SPN_score_graphs(new_df, 
                             donor_order = donor_order, 
                             total_expression = "BER_Score1", 
                             fillcol = "reclustered_patch_matrix_exotic", 
                             color = color3, 
                             donor_graph_title = "XDP BER scores", 
                             final_merged_xdp_transformed, 
                             SPN_score_col_name ="BER_Score", xlab_name = "BER Score", limits = seq(-0.4, 0.4, 0.01)) 
```

```{r}
new_df$cell_id = rownames(new_df)
XDP_orig = XDP_matrix_scores %>% select(cell_id, total_expression, scaled_score)
XDP_orig

merged_df = merge(new_df, XDP_orig, by = "cell_id")
merged_df
```

```{r}
classes= unique(merged_df$reclustered_patch_matrix_exotic)
for (class in classes) {
  test = subset(merged_df, subset = reclustered_patch_matrix_exotic == class)
  d = ggplot(data = test, aes(x = SPN_Matrix_Score1, y = total_expression, color = region)) + geom_point(alpha = 0.4) + ggtitle(paste(class)) + xlab("SPN Matrix Scores from AddModuleScores")+ ylab("Original SPN Matrix Scores") 
  print(d)
}

```
```{r}
classes= unique(merged_df$reclustered_patch_matrix_exotic)
for (class in classes) {
  test = subset(merged_df, subset = reclustered_patch_matrix_exotic == class)
  d = ggplot(data = test, aes(x = MMR_Score1, y = BER_Score1, color = Condition)) + geom_point(alpha = 0.4) + ggtitle(paste(class)) + xlab("MMR Score")+ ylab("BER Score") 
  print(d)
}
```


```{r}
classes= unique(merged_df$reclustered_patch_matrix_exotic)
for (class in classes) {
  test = subset(merged_df, subset = reclustered_patch_matrix_exotic == class)
  d = ggplot(data = test, aes(x = MMR_Score1, y = total_expression, color = Condition)) + geom_point(alpha = 0.4) + ggtitle(paste(class)) + xlab("MMR Score")+ ylab("Original SPN Matrix Scores") 
  print(d)
}
```
```{r}
classes= unique(merged_df$reclustered_patch_matrix_exotic)
for (class in classes) {
  test = subset(merged_df, subset = reclustered_patch_matrix_exotic == class)
  d = ggplot(data = test, aes(x = SPN_Matrix_Score1, y = Apoptosis_Score1, color = Condition)) + geom_point(alpha = 0.4) + ggtitle(paste(class)) + xlab("SPN Matrix Score")+ ylab("Apoptosis Score") 
  print(d)
}
```




```{r}
XDP_matrix_scores = SPN_score_normalized(Intersected_BICAN_matrix_markers_final_filtered, final_merged_xdp_transformed, logfc_val = "weighted_logFC", method = "multiply")
XDP_matrix_scores
```

```{r}
XDP_matrix_scores_sub = XDP_matrix_scores %>% select(cell_id, total_expression, scaled_score)
XDP_matrix_scores_sub
```
```{r}
new_df$cell_id = rownames(new_df)
new_df1 = merge(new_df, XDP_matrix_scores_sub, by = "cell_id")
new_df1
```

```{r}
new_df1_matrix = subset(new_df1, subset = reclustered_patch_matrix_exotic == "SPN_matrix")
new_df1_matrix
```


```{r}
ggplot(data = new_df1_matrix, aes(x = MMR_score1, y = BER_score1)) + geom_point(alpha = 0.4, color = "red")
ggplot(data = new_df1_matrix, aes(x = MMR_score1, y = total_expression)) + geom_point(alpha = 0.4, color = "red")
```



#wilcox

```{r}
meta = seurat_obj@meta.data
```


```{r}
MMR_scores= subset(meta, subset = reclustered_patch_matrix_exotic == "SPN_matrix")

average_scores_df <- data.frame(donor_id = character(), average_score_MMR = numeric(), average_score_BER= numeric(),  stringsAsFactors = FALSE)

for (donor in donor_order) {
  test <- subset(MMR_scores, donor_id == donor)
  average_MMR <- mean(test$MMR_Score1, na.rm = TRUE)
  average_BER <- mean(test$BER_Score1, na.rm = TRUE)
  condition = test$Condition
  average_scores_df <- rbind(average_scores_df, data.frame(donor_id = donor, average_score_MMR = average_MMR, average_score_BER = average_BER))
}

average_scores_df$Condition = ifelse(grepl("SCF_21-037CM2|SCF-23-068CM|SCF-22-058CF|SCF-22-054CM", average_scores_df$donor_id), "Control", "XDP")

print(average_scores_df)

XDP_MMR_scores_cases = subset(average_scores_df, subset = Condition == "XDP")
XDP_MMR_scores_cases
XDP_MMR_scores_controls = subset(average_scores_df, subset = Condition == "Control") 
XDP_MMR_scores_controls
```

```{r}
a = ggplot(average_scores_df, aes(x = Condition, y = average_score_MMR, color = donor_id)) +
  geom_jitter(width = 0.2, height = 0) +  # Adjust width for horizontal jitter
  labs(x = "Condition", y = "Average MMR score", title = "non-SPN - MMR") +
  theme_minimal()

b = ggplot(average_scores_df, aes(x = Condition, y = average_score_BER, color = donor_id)) +
  geom_jitter(width = 0.2, height = 0) +  # Adjust width for horizontal jitter
  labs(x = "Condition", y = "Average BER score", title = "non-SPN - BER") +
  theme_minimal()

a + b
```


```{r}
XDP_MMR_scores <- XDP_MMR_scores_cases$average_score_MMR  
XDP_Control_MMR_scores <- XDP_MMR_scores_controls$average_score_MMR 
XDP_MMR_scores
XDP_Control_MMR_scores

result1 <- wilcox.test(XDP_MMR_scores, XDP_Control_MMR_scores, alternative = "two.sided")
result2 <- wilcox.test(XDP_MMR_scores, XDP_Control_MMR_scores, alternative = "less")
result3 <- wilcox.test(XDP_MMR_scores, XDP_Control_MMR_scores, alternative = "greater")
print(result1)
print(result2)
print(result3)

XDP_BER_scores <- XDP_MMR_scores_cases$average_score_BER
XDP_Control_BER_scores <- XDP_MMR_scores_controls$average_score_BER 

result1 <- wilcox.test(XDP_BER_scores, XDP_Control_BER_scores, alternative = "two.sided")
result2 <- wilcox.test(XDP_BER_scores, XDP_Control_BER_scores, alternative = "less")
result3 <- wilcox.test(XDP_BER_scores, XDP_Control_BER_scores, alternative = "greater")
print(result1)
print(result2)
print(result3)

```















#now other celltypes:

```{r}
Idents(final_V8_BICAN_neurons) = "reclustered_neuron_joint_type"
DimPlot(final_V8_BICAN_neurons, label = T)
```


```{r}
new_markers =FindAllMarkers(object = final_V8_BICAN_neurons, only.pos = TRUE)
                                #,  min.pct = 0.2, logfc.threshold = 1.25)
new_markers
```


```{r}
new_markers_final = subset(new_markers, subset = cluster == "non-SPN")

new_markers_final = subset(new_markers_final, subset = p_val_adj < 0.05)
new_markers_final$pct_subtract = new_markers_final$pct.1 - new_markers_final$pct.2
new_markers_final$weighted_logFC = new_markers_final$avg_log2FC * new_markers_final$pct_subtract
new_markers_final

new_markers_final$gene = rownames(new_markers_final)
new_markers_final
```

```{r}
gene_df = new_markers_final
SCtransform_counts = final_merged_xdp_transformed
logfc_val = "weighted_logFC"
method = "multiply"

significant_genes = unique(gene_df$gene)

exp = FetchData(SCtransform_counts, vars = significant_genes)

rownames(gene_df) = gene_df$gene
gene_df$gene = NULL

# Assuming gene_df and exp are your dataframes
logfc_df <- gene_df
counts_df <- exp
counts_df

#this is the list of genes to us
genes_in_both = colnames(counts_df)

 Intersected_new_markers_final = subset(new_markers_final, subset = gene %in% genes_in_both)
 Intersected_new_markers_final

Intersected_new_markers_final_filtered =subset(Intersected_new_markers_final, subset = pct_subtract > 0)
Intersected_new_markers_final_filtered
```
```{r}
write.csv(Intersected_new_markers_final_filtered, "~/non_SPN_markers083024.csv")
```


```{r}
matrix_markers = read.csv("~/matrix_markers083024.csv")
patch_markers = read.csv("~/patch_markers083024.csv")
eSPN_markers = read.csv("~/eSPN_markers083024.csv")
non_SPN_markers = read.csv("~/non_SPN_markers083024.csv")

matrix_markers
patch_markers
eSPN_markers
non_SPN_markers
```


```{r}
XDP_matrix_scores = Cell_Scorer(matrix_markers, final_merged_xdp_transformed, logfc_val = "weighted_logFC", method = "multiply", type = "XDP", donor_order1 = donor_order, score_region = "SPN_matrix")

XDP_matrix_scores$Village = "XDP"
XDP_matrix_scores

V8_BICAN_scores = Cell_Scorer(matrix_markers, final_V8_BICAN_neurons, logfc_val = "weighted_logFC", method = "multiply", type = "BICAN", donor_order1 = BICANdonors,score_region = "SPN_matrix")
V8_BICAN_scores$Village = "BICAN_V8"
V8_BICAN_scores

V17_BICAN_scores = Cell_Scorer(matrix_markers, final_V17_BICAN_neurons, logfc_val = "weighted_logFC", method = "multiply",type = "BICAN", donor_order1 = BICANdonors,score_region = "SPN_matrix")
V17_BICAN_scores$Village = "BICAN_V17"
V17_BICAN_scores

V17_BICAN_scores$reclustered_patch_matrix_exotic = V17_BICAN_scores$reclustered_neuron_joint_type
 V17_BICAN_scores$reclustered_patch_matrix_exotic[V17_BICAN_scores$reclustered_cell_class == "D1_patch_exotic" | V17_BICAN_scores$reclustered_cell_class == "D2_patch_exotic"] = "SPN_exotic"
table(V17_BICAN_scores$reclustered_patch_matrix_exotic)

library(dplyr)
XDP_matrix_scores_df = XDP_matrix_scores %>% select(cell_id, donor_id, Condition, reclustered_patch_matrix_exotic, reclustered_patch_matrix, reclustered_neuron_type_joint_cluster,  pct_mito, nUmi, total_expression, scaled_score, Village)

BICAN_matrix_scores_df_V8 = V8_BICAN_scores %>% select(cell_id, DONOR, reclustered_patch_matrix, reclustered_neuron_joint_type,  pct_mt, NUM_TRANSCRIPTS, total_expression , scaled_score, Village) 

BICAN_matrix_scores_df_V17 = V17_BICAN_scores %>% select(cell_id, DONOR, reclustered_patch_matrix, reclustered_neuron_joint_type,reclustered_patch_matrix_exotic,  pct_mt, NUM_TRANSCRIPTS, total_expression , scaled_score, Village) 

BICAN_matrix_scores_df_V8$Condition = "BICAN Control V8"
BICAN_matrix_scores_df_V8$reclustered_patch_matrix_exotic = BICAN_matrix_scores_df_V8$reclustered_neuron_joint_type
BICAN_matrix_scores_df_V8$reclustered_neuron_type_joint_cluster = BICAN_matrix_scores_df_V8$reclustered_neuron_joint_type
BICAN_matrix_scores_df_V8$reclustered_neuron_joint_type = NULL
BICAN_matrix_scores_df_V8$pct_mito = BICAN_matrix_scores_df_V8$pct_mt 
BICAN_matrix_scores_df_V8$pct_mt  = NULL
BICAN_matrix_scores_df_V8$nUmi = BICAN_matrix_scores_df_V8$NUM_TRANSCRIPTS 
BICAN_matrix_scores_df_V8$NUM_TRANSCRIPTS  = NULL
BICAN_matrix_scores_df_V8$donor_id = BICAN_matrix_scores_df_V8$DONOR 
BICAN_matrix_scores_df_V8$DONOR  = NULL

BICAN_matrix_scores_df_V17$Condition = "BICAN Control V17"
BICAN_matrix_scores_df_V17$reclustered_neuron_type_joint_cluster = BICAN_matrix_scores_df_V17$reclustered_neuron_joint_type
BICAN_matrix_scores_df_V17$reclustered_neuron_joint_type = NULL
BICAN_matrix_scores_df_V17$pct_mito = BICAN_matrix_scores_df_V17$pct_mt 
BICAN_matrix_scores_df_V17$pct_mt  = NULL
BICAN_matrix_scores_df_V17$nUmi = BICAN_matrix_scores_df_V17$NUM_TRANSCRIPTS 
BICAN_matrix_scores_df_V17$NUM_TRANSCRIPTS  = NULL
BICAN_matrix_scores_df_V17$donor_id = BICAN_matrix_scores_df_V17$DONOR 
BICAN_matrix_scores_df_V17$DONOR  = NULL

XDP_matrix_scores_df
BICAN_matrix_scores_df_V8
BICAN_matrix_scores_df_V17

Combined_scores_df = rbind(XDP_matrix_scores_df, BICAN_matrix_scores_df_V8, BICAN_matrix_scores_df_V17)
Combined_scores_df

table(Combined_scores_df$Condition, Combined_scores_df$reclustered_patch_matrix_exotic)
table(Combined_scores_df$Condition, Combined_scores_df$reclustered_neuron_type_joint_cluster)

min(Combined_scores_df$total_expression)
max(Combined_scores_df$total_expression)
```

```{r}
limits = seq(0, 500, 5)
xlab_name = "non-SPN Score"
matrix <- Combined_scores_df[Combined_scores_df$reclustered_patch_matrix_exotic == "SPN_matrix", ]
  plot_overlapping_density_histogram(df = matrix, 
                                          hist_col = matrix$total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue", "BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: SPN matrix",
                                          xlab = xlab_name,
                                          fig_filename = NULL)
  patch <- Combined_scores_df[Combined_scores_df$reclustered_patch_matrix_exotic == "SPN_patch", ]
  plot_overlapping_density_histogram(df = patch, 
                                          hist_col = patch$total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue", "BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: SPN patch",
                                          xlab = xlab_name,
                                          fig_filename = NULL)
  nonSPN <- Combined_scores_df[Combined_scores_df$reclustered_patch_matrix_exotic == "non-SPN", ]
  plot_overlapping_density_histogram(df = nonSPN, 
                                          hist_col = nonSPN$total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue","BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: non-SPN",
                                          xlab = xlab_name,
                                          fig_filename = NULL)
    exotic <- Combined_scores_df[Combined_scores_df$reclustered_patch_matrix_exotic == "SPN_exotic", ]
  plot_overlapping_density_histogram(df = exotic, 
                                          hist_col = exotic$total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue","BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: Exotic SPN",
                                          xlab = xlab_name,
                                          fig_filename = NULL)
    eSPN <- Combined_scores_df[Combined_scores_df$reclustered_patch_matrix_exotic == "eSPN", ]
  plot_overlapping_density_histogram(df = eSPN, 
                                          hist_col = eSPN$total_expression,
                                          fill_col = "Condition",
                                          colors = c("XDP" = "red", "Control" = "blue","BICAN Control V8" = "green", "BICAN Control V17" = "orange"),
                                          breaks = limits,
                                          title = "XDP vs Control: eSPN",
                                          xlab = xlab_name,
                                          fig_filename = NULL)
```

```{r}
SPN_score_graphs(XDP_matrix_scores, 
                             donor_order = donor_order, 
                             total_expression = "total_expression", 
                             fillcol = "reclustered_patch_matrix_exotic", 
                             color = color6, 
                             donor_graph_title = "XDP non-SPN scores", 
                             final_merged_xdp_transformed, 
                             SPN_score_col_name ="non-SPN_Score", xlab_name = "non-SPN Score", limits = seq(0, 350, 3.5)) 
```



```{r}
BICAN_SPN_score_graphs(V8_BICAN_scores, 
                             donor_order = BICANdonors, 
                             total_expression = "total_expression", 
                             fillcol = "reclustered_neuron_joint_type", 
                             color = color6, 
                             donor_graph_title = "BICAN V8 non-SPN scores", 
                             final_V8_BICAN_neurons, 
                             SPN_score_col_name = "BICAN_V8_non-SPN_Score", limits = seq(0, 350, 3.5), xlab_name = "non-SPN Score")
```

```{r}
BICAN_SPN_score_graphs(V17_BICAN_scores, 
                             donor_order = BICANdonors1, 
                             total_expression = "total_expression", 
                             fillcol = "reclustered_patch_matrix_exotic", 
                             color = color6, 
                             donor_graph_title = "BICAN V17 non-SPN scores", 
                             final_V17_BICAN_neurons, 
                             SPN_score_col_name = "BICAN_V17_non-SPN_Score", limits = seq(0, 350, 3.5), xlab_name = "non-SPN Score")
```


```{r}
matrix_markers
patch_markers
eSPN_markers
non_SPN_markers
```


```{r}
XDP_SPN_matrix_scores = Cell_Scorer(Intersected_BICAN_matrix_markers_final_filtered, final_merged_xdp_transformed, logfc_val = "weighted_logFC", method = "multiply", type = "XDP", donor_order1 = donor_order, score_region = "SPN_matrix")

XDP_SPN_matrix_scores$Village = "XDP"
XDP_SPN_matrix_scores
```


```{r}
XDP_scores = XDP_SPN_matrix_scores %>% select(cell_id, total_expression, scaled_score)
XDP_scores$
meta
```




```{r}
XDP_SPN_matrix_scores1 = subset(XDP_SPN_matrix_scores, subset = reclustered_patch_matrix_exotic == "non-SPN")

XDP_SPN_matrix_scores_cases = subset(XDP_SPN_matrix_scores1, subset = Condition == "XDP")
XDP_SPN_matrix_scores_cases
XDP_SPN_matrix_scores_controls = subset(XDP_SPN_matrix_scores1, subset = Condition == "Control") 
XDP_SPN_matrix_scores_controls
```


```{r}
XDP_matrix_scores <- XDP_SPN_matrix_scores_cases$total_expression  
XDP_Control_matrix_scores <- XDP_SPN_matrix_scores_controls$total_expression 

result1 <- wilcox.test(XDP_matrix_scores, XDP_Control_matrix_scores, alternative = "two.sided")
result2 <- wilcox.test(XDP_matrix_scores, XDP_Control_matrix_scores, alternative = "less")
result3 <- wilcox.test(XDP_matrix_scores, XDP_Control_matrix_scores, alternative = "greater")
print(result1)
print(result2)
print(result3)
```




