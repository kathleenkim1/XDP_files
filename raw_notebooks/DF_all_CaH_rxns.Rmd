---
title: "R Notebook"
output: html_notebook
---

```{r}
CaH_rxn1_cellbender
filtered_CaH_rxn1_cellbender <- subset(CaH_rxn1_cellbender, subset = pct_mito < 10 & pct_intronic >= 0.25)
filtered_CaH_rxn1_cellbender = subset(filtered_CaH_rxn1_cellbender, subset = nUmi > 500)
filtered_CaH_rxn1_cellbender

CaH_rxn2_cellbender
filtered_CaH_rxn2_cellbender <- subset(CaH_rxn2_cellbender, subset = pct_mito < 10 & pct_intronic >= 0.25)
filtered_CaH_rxn2_cellbender = subset(filtered_CaH_rxn2_cellbender, subset = nUmi > 500)
filtered_CaH_rxn2_cellbender

CaH_rxn3_cellbender
filtered_CaH_rxn3_cellbender <- subset(CaH_rxn3_cellbender, subset = pct_mito < 10 & pct_intronic >= 0.25)
filtered_CaH_rxn3_cellbender = subset(filtered_CaH_rxn3_cellbender, subset = nUmi > 500)
filtered_CaH_rxn3_cellbender

CaH_rxn4_cellbender
filtered_CaH_rxn4_cellbender <- subset(CaH_rxn4_cellbender, subset = pct_mito < 10 & pct_intronic >= 0.25)
filtered_CaH_rxn4_cellbender = subset(filtered_CaH_rxn4_cellbender, subset = nUmi > 500)
filtered_CaH_rxn4_cellbender

filtered_CaH_rxn1_cellbender = subset(filtered_CaH_rxn1_cellbender, subset = donor_id != "unassigned" &  donor_id != "doublet")
filtered_CaH_rxn1_cellbender

filtered_CaH_rxn2_cellbender = subset(filtered_CaH_rxn2_cellbender, subset = donor_id != "unassigned" &  donor_id != "doublet")
filtered_CaH_rxn2_cellbender

filtered_CaH_rxn3_cellbender = subset(filtered_CaH_rxn3_cellbender, subset = donor_id != "unassigned" &  donor_id != "doublet")
filtered_CaH_rxn3_cellbender

filtered_CaH_rxn4_cellbender = subset(filtered_CaH_rxn4_cellbender, subset = donor_id != "unassigned" &  donor_id != "doublet")
filtered_CaH_rxn4_cellbender
```


#HVG calculation helper function
```{r}
getSeuratVarFeatureIntersectByCol = function(
   seurat_obj,
   subset_col,
   original_nfeatures,
   n_subsets_to_cover=NULL
){
  
   hvgs = list()


   unique_ids = unique(seurat_obj@meta.data[[subset_col]])


   if (is.null(n_subsets_to_cover)){
       n_subsets_to_cover = floor(length(unique_ids)/2)
   }


   i=1
   for (id in unique_ids) {
       print(paste("Subset", id, "--", i, "of", length(unique_ids)))
       i = i + 1
      
       seurat_subset = seurat_obj[, seurat_obj[[subset_col]] == id]
      
       if (ncol(seurat_subset) < 2){next}
      
       suppressWarnings({
           seurat_subset = FindVariableFeatures(
               seurat_subset, selection.method = "vst", nfeatures=original_nfeatures, verbose = TRUE)
       })
      
       hvgs[[id]] = getSeuratVarFeatures(seurat_subset)
      print(length(VariableFeatures(seurat_subset)))  # Should be > 0

   }


   common_hvgs = getCommonStrings(hvgs, n_subsets_to_cover)
   print(paste("Number of HVGs in common across", n_subsets_to_cover, "--", length(common_hvgs)))


   return(common_hvgs)
}


getSeuratVarFeatures = function(sobj){
    rna_assay <- GetAssay(sobj, assay = "RNA")  # Explicitly get the assay
    return(VariableFeatures(rna_assay))  # Use VariableFeatures() instead of direct slot access
}

# getSeuratVarFeatures = function(sobj){
#     # the magical incantation that returns the slot of the attribute of the slot that actually holds the list of variable feature -_-
#     return(sobj@assays$RNA@var.features)
# }

getCommonStrings <- function(list_of_lists, n) {
  # Create an empty list to store string occurrences
  string_occurrences <- list()

  # Iterate over each sublist
  for (sublist in list_of_lists) {
    # For each string in the sublist, increment its count in string_occurrences
    for (string in unique(sublist)) {
      if (!is.null(string_occurrences[[string]])) {
        string_occurrences[[string]] <- string_occurrences[[string]] + 1
      } else {
        string_occurrences[[string]] <- 1
      }
    }
  }

  # Filter the strings that occur at least n times
  common_strings <- names(string_occurrences)[string_occurrences >= n]

  return(common_strings)
}
```


#remove unassigned + doublets first

```{r}
hvgs = getSeuratVarFeatureIntersectByCol(filtered_CaH_rxn4_cellbender, subset_col="donor_id", original_nfeatures=2500)

n_dims_use=20

filtered_CaH_rxn4_cellbender <- filtered_CaH_rxn4_cellbender %>%
   NormalizeData() %>%
   { hvgs <- getSeuratVarFeatureIntersectByCol(., subset_col="donor_id", original_nfeatures=2500); . } %>%
   ScaleData(features=hvgs, split.by="donor_id") %>%
   { VariableFeatures(.) <- hvgs; . } %>%  # Ensure HVGs are stored
   RunPCA(features=hvgs, npcs=n_dims_use) %>%
   FindNeighbors(dims = 1:n_dims_use) %>%
   FindClusters(resolution = 0.2) %>%
   FindClusters(resolution = 0.3) %>%
   FindClusters(resolution = 0.4) %>%
   FindClusters(resolution = 0.5) %>%
   FindClusters(resolution = 0.6) %>%
   FindClusters(resolution = 0.7) %>%
   FindClusters(resolution = 0.8) %>%
   FindClusters(resolution = 0.9) %>%
   FindClusters(resolution = 1) %>%
   RunUMAP(dims = 1:n_dims_use)

# Check if HVGs are retained:
print(length(VariableFeatures(filtered_CaH_rxn4_cellbender)))  # Should be ~2200+

filtered_CaH_rxn4_cellbender

filtered_CaH_rxn4_cellbender@meta.data$GT = "Singlet"
filtered_CaH_rxn4_cellbender$GT[filtered_CaH_rxn4_cellbender$donor_id == "doublet"] = "Doublet"


DimPlot(filtered_CaH_rxn4_cellbender, group.by = "donor_id") 
DimPlot(filtered_CaH_rxn4_cellbender, group.by = "GT") 
DimPlot(filtered_CaH_rxn4_cellbender, group.by = "RNA_snn_res.0.2", label=T) 
DimPlot(filtered_CaH_rxn4_cellbender, group.by = "RNA_snn_res.0.3", label=T) 
DimPlot(filtered_CaH_rxn4_cellbender, group.by = "RNA_snn_res.0.4", label=T) 
DimPlot(filtered_CaH_rxn4_cellbender, group.by = "RNA_snn_res.0.5", label=T) 
DimPlot(filtered_CaH_rxn4_cellbender, group.by = "RNA_snn_res.0.6", label=T) 
DimPlot(filtered_CaH_rxn4_cellbender, group.by = "RNA_snn_res.0.7", label=T) 
DimPlot(filtered_CaH_rxn4_cellbender, group.by = "RNA_snn_res.0.8", label=T) 
```

```{r}
FeaturePlot(filtered_CaH_rxn4_cellbender, features = c("SYT1", "RBFOX3", "GAD2", "SLC17A6"), raster = F)
FeaturePlot(filtered_CaH_rxn4_cellbender, features = c("AQP4", "GINS3", "GFAP"), raster = F)
FeaturePlot(filtered_CaH_rxn4_cellbender, features = c("C1QA", "C1QB", "CX3CR1", "P2RY12"), raster = F)
FeaturePlot(filtered_CaH_rxn4_cellbender, features = c("FLT1", "DCN", "RGS5"), raster = F)
FeaturePlot(filtered_CaH_rxn4_cellbender, features = c("OLIG1", "MOG", "MOBP"), raster = F)
FeaturePlot(filtered_CaH_rxn4_cellbender, features = c("OLIG2", "VCAN", "GAPDH"), raster = F)
FeaturePlot(filtered_CaH_rxn4_cellbender, features = c("ZBBX", "CFAP157", "CFAP299", "BSG"), raster = F)
FeaturePlot(filtered_CaH_rxn4_cellbender, features = c("CD96", "NKG7", "SKAP1"), raster = F)
FeaturePlot(filtered_CaH_rxn4_cellbender, features = c("UBB", "GAPDH", "TUBB2A"),raster=FALSE) 
```

```{r}
 marker_genes <- c("SYT1", "RBFOX3", "GAD2", "SLC17A6","AQP4", "GINS3", "GFAP","C1QA", "C1QB", "CX3CR1", "P2RY12","FLT1", "DCN", "RGS5", "OLIG1", "MOG", "MOBP", "OLIG2", "VCAN", "GAPDH","ZBBX", "CFAP157", "CFAP299", "BSG","CD96", "NKG7", "SKAP1")
 Dotplot = DotPlot(object = filtered_CaH_rxn4_cellbender, features = marker_genes, group.by = "RNA_snn_res.0.3")
Dotplot  <- Dotplot  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ coord_flip() 
print(Dotplot)
```

```{r}
Idents(filtered_CaH_rxn4_cellbender) = filtered_CaH_rxn4_cellbender$RNA_snn_res.0.3

classes = c("oligo", "oligo", "oligo", "neuron", "astrocyte", "oligo", "microglia", "astrocyte", "oligo", "astrocyte", "opc", "neuron", "endothelial", "neuron", "ependymal", "oligo", "neuron", "immune")


filtered_CaH_rxn4_cellbender= assignCellClasses(filtered_CaH_rxn4_cellbender, classes=classes, cluster_col="RNA_snn_res.0.3", class_col = "cell_class")

DimPlot(filtered_CaH_rxn4_cellbender, group.by = "cell_class" ,label = T, raster = FALSE)
```


```{r}
DimPlot(filtered_CaH_rxn1_cellbender, group.by = "cell_class" ,label = T, raster = FALSE)
DimPlot(filtered_CaH_rxn2_cellbender, group.by = "cell_class" ,label = T, raster = FALSE)
DimPlot(filtered_CaH_rxn3_cellbender, group.by = "cell_class" ,label = T, raster = FALSE)
DimPlot(filtered_CaH_rxn4_cellbender, group.by = "cell_class" ,label = T, raster = FALSE)
```


```{r}
filtered_CaH_rxn1_cellbender@meta.data
filtered_CaH_rxn2_cellbender@meta.data
filtered_CaH_rxn3_cellbender@meta.data
filtered_CaH_rxn4_cellbender@meta.data

filtered_CaH_rxn2_cellbender_temp =filtered_CaH_rxn2_cellbender
filtered_CaH_rxn3_cellbender_temp = filtered_CaH_rxn3_cellbender
filtered_CaH_rxn4_cellbender_temp=filtered_CaH_rxn4_cellbender
```


#Runninng DF
```{r}
# Try running paramSweep() after explicitly setting HVGs
#Redoing findvariable...doesn't seem right
filtered_CaH_rxn4_cellbender <- FindVariableFeatures(filtered_CaH_rxn4_cellbender, selection.method = "vst", nfeatures = 2000)
sweep.res.list_CaH_rxn1 <- paramSweep(filtered_CaH_rxn4_cellbender, PCs = 1:10, sct = FALSE)

## pK Identification (no ground-truth) ---------------------------------------------------------------------------------------
sweep.stats_CaH_rxn1 <- summarizeSweep(sweep.res.list_CaH_rxn1, GT = FALSE)
bcmvn_CaH_rxn1 <- find.pK(sweep.stats_CaH_rxn1)
bcmvn_CaH_rxn1
```


```{r}
bcmvn_CaH_rxn1 <- find.pK(sweep.stats_CaH_rxn1)
bcmvn_CaH_rxn1
```


#Allegedly 8% per 10K recovered cells (17K loading)
```{r}
## Homotypic Doublet Proportion Estimate -------------------------------------------------------------------------------------
homotypic.prop <- modelHomotypic(filtered_CaH_rxn4_cellbender@meta.data$cell_class)           ## ex: annotations <- 
nExp_poi <- round(0.035*nrow(filtered_CaH_rxn4_cellbender@meta.data))  ## Assuming 7.5% doublet formation rate - tailor for your dataset
nExp_poi.adj <- round(nExp_poi*(1-homotypic.prop))

filtered_CaH_rxn4_cellbender@meta.data
```


```{r}
filtered_CaH_rxn4_cellbender <- doubletFinder(filtered_CaH_rxn4_cellbender, 
                             PCs = 1:10, 
                             pN = 0.25, 
                             pK = 0.03, #0.04 
                             nExp = nExp_poi.adj, 
                             reuse.pANN = FALSE, 
                             sct = FALSE)
filtered_CaH_rxn4_cellbender@meta.data
```



```{r}
table(filtered_CaH_rxn4_cellbender$GT)
table(filtered_CaH_rxn4_cellbender$DF.classifications_0.25_0.03_243)
```

```{r}
# Assuming DoubletFinder has already been run and results are stored in the metadata of seu_kidney:
# - "DF.classifications_0.25_0.09_774" stores "Singlet" or "Doublet"
# - "pANN_0.25_0.09_774" stores the pANN scores for each cell

# First, create a new classification column that includes low-confidence and high-confidence doublets
filtered_CaH_rxn4_cellbender$doublet_confidence <- ifelse(
  filtered_CaH_rxn4_cellbender@meta.data$DF.classifications_0.25_0.03_243 == "Doublet" & 
    filtered_CaH_rxn4_cellbender@meta.data$pANN_0.25_0.03_243 < 0.5, "Low Confidence Doublet", 
  ifelse(
    filtered_CaH_rxn4_cellbender@meta.data$DF.classifications_0.25_0.03_243 == "Doublet" & 
      filtered_CaH_rxn4_cellbender@meta.data$pANN_0.25_0.03_243 >= 0.5, "High Confidence Doublet", 
    "Singlet"
  )
)

# Now plot the cells, coloring by the doublet classification
library(Seurat)
DimPlot(filtered_CaH_rxn4_cellbender, group.by = "doublet_confidence", 
        cols = c("Singlet" = "lightgrey", "Low Confidence Doublet" = "orange", "High Confidence Doublet" = "red"))

```


#Manual

```{r}
filtered_CaH_rxn1_cellbender
filtered_CaH_rxn2_cellbender
filtered_CaH_rxn3_cellbender
filtered_CaH_rxn4_cellbender

table(filtered_CaH_rxn4_cellbender$cell_class)
```


```{r}
temp_sobj = subset(filtered_CaH_rxn4_cellbender, subset = cell_class == "neuron")

# this code should take 3-10 minutes
hvgs = getSeuratVarFeatureIntersectByCol(temp_sobj, subset_col="donor_id", original_nfeatures=2500)
n_dims_use=20
temp_sobj = (temp_sobj
   %>% NormalizeData() # log normalizes raw counts
   %>% ScaleData(features=hvgs, split.by="donor_id") # within each cell, for each gene scale the data (i.e. subtract the donor's mean and divide by the donor's standard deviation of that gene)
   %>% RunPCA(features=hvgs, npcs=n_dims_use) # Reduce the dimensions to the n_dims_use dimensions that best explain the data https://en.wikipedia.org/wiki/Principal_component_analysis
   %>% FindNeighbors(dims = 1:n_dims_use) # Finds every cells closest neighbors in the PCA space
   %>% FindClusters(resolution = 0.2) # finds clusters at a variety of resolutions
   %>% FindClusters(resolution = 0.3) # after clustering, the cluster labels are accessible via filtered_merged_caudate$RNA_snn_res.{resolution}
   %>% FindClusters(resolution = 0.4) # e.g.: filtered_merged_caudate$RNA_snn_res.0.4 here
   %>% FindClusters(resolution = 0.5)
   %>% FindClusters(resolution = 0.6)
   %>% FindClusters(resolution = 0.7)
   %>% FindClusters(resolution = 0.8)
   %>% FindClusters(resolution = 0.9)
   %>% FindClusters(resolution = 1)
   %>% RunUMAP(dims = 1:n_dims_use) # projects the PCA onto 2 dimensions, such that both "global structure" and "local structure" are optimally preserved
)

setwh = function(w, h){
   # set the width of the ensuing figures to w, height to h
   options(repr.plot.width = w, repr.plot.height = h)
}

DimPlot(temp_sobj, group.by = "donor_id") 
DimPlot(temp_sobj, group.by = "GT") 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.2", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.3", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.4", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.5", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.6", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.7", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.8", label=T) 

FeaturePlot(temp_sobj, features = c("SYT1", "RBFOX3", "GAD2", "SLC17A6"), raster = F)
FeaturePlot(temp_sobj, features = c("AQP4", "GINS3", "GFAP"), raster = F)
FeaturePlot(temp_sobj, features = c("C1QA", "C1QB", "CX3CR1", "P2RY12"), raster = F)
FeaturePlot(temp_sobj, features = c("FLT1", "DCN", "RGS5"), raster = F)
FeaturePlot(temp_sobj, features = c("OLIG1", "MOG", "MOBP"), raster = F)
FeaturePlot(temp_sobj, features = c("OLIG2", "VCAN", "GAPDH"), raster = F)
FeaturePlot(temp_sobj, features = c("ZBBX", "CFAP157", "CFAP299", "BSG"), raster = F)
FeaturePlot(temp_sobj, features = c("CD96", "NKG7", "SKAP1"), raster = F)
FeaturePlot(temp_sobj, features = c("UBB", "GAPDH", "TUBB2A"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("pct_mito", "pct_intronic", "nUmi"),raster=FALSE) 

```


```{r}
marker_genes <- c("CD96", "CX3CR1", "P2RY12", "C1QB", "C1QA", "CASZ1", "FLT1", "TF", "MOBP", "MOG", "MBP", "OLIG2", "OLIG1", "ST18", "GFAP", "AQP4", "SEMA3E", "EPHA4", "PPP1R1B", "DRD2", "DRD1", "GAD2", "GAD1", "SYT1", "RBFOX3", "SLC17A6", "SLC17A7", "VCAN")

Dotplot = DotPlot(object = temp_sobj, features = marker_genes, group.by = "RNA_snn_res.0.4")
Dotplot  <- Dotplot  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ coord_flip() 
print(Dotplot)


 marker_genes <- c("SYT1", "RBFOX3", "GAD2", "SLC17A6","AQP4", "GINS3", "GFAP","C1QA", "C1QB", "CX3CR1", "P2RY12","FLT1", "DCN", "RGS5", "OLIG1", "MOG", "MOBP", "OLIG2", "VCAN", "GAPDH","ZBBX", "CFAP157", "CFAP299", "BSG","CD96", "NKG7", "SKAP1")
 Dotplot = DotPlot(object = temp_sobj, features = marker_genes, group.by = "RNA_snn_res.0.4")
Dotplot  <- Dotplot  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ coord_flip() 
print(Dotplot)
```
```{r}
temp_sobj@meta.data$KK_doublets = "Singlet"
temp_sobj$KK_doublets[temp_sobj$RNA_snn_res.0.4 == "2"] = "Doublet"
table(temp_sobj$KK_doublets)
```

```{r}
KK_CaH_rxn4_opc= temp_sobj
```


```{r}
KK_CaH_rxn4_astrocyte@meta.data$neuron_cell_class = KK_CaH_rxn4_astrocyte$cell_class
KK_CaH_rxn4_endo@meta.data$neuron_cell_class = KK_CaH_rxn4_endo$cell_class
KK_CaH_rxn4_ependymal@meta.data$neuron_cell_class = KK_CaH_rxn4_ependymal$cell_class
KK_CaH_rxn4_immune@meta.data$neuron_cell_class = KK_CaH_rxn4_immune$cell_class
KK_CaH_rxn4_micro@meta.data$neuron_cell_class = KK_CaH_rxn4_micro$cell_class

KK_CaH_rxn4_neuron

KK_CaH_rxn4_oligo@meta.data$neuron_cell_class = KK_CaH_rxn4_oligo$cell_class
KK_CaH_rxn4_opc@meta.data$neuron_cell_class = KK_CaH_rxn4_opc$cell_class
```

```{r}
KK_CaH_rxn1_neuron
```

```{r}
FeaturePlot(temp_sobj, features = c("SYT1", "AQP4", "C1QA","FLT1"),raster=FALSE)
FeaturePlot(temp_sobj, features = c("OLIG1", "OLIG2", "MOG" ,"CD96"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("MBP", "MOBP", "TF", "ST18"),raster=FALSE)
FeaturePlot(temp_sobj, features = c("RBFOX3", "CX3CR1", "GFAP" ,"AQP4"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("GAD1", "GAD2", "SLC17A7" ,"SLC17A6"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("DRD1", "DRD2", "CASZ1" ,"PPP1R1B"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("EPHA4", "SEMA3E", "SLC17A7" ,"SLC17A6"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("P2RY12", "CX3CR1", "C1QB", "BCAS1"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("SEMA5B", "KREMEN1", "PDE1C"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("TAC1", "NNAT", "OPRM1", "ID4"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("SGK1", "EPHA4", "SV2B"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("SST", "CALB1", "PVALB", "LAMP5"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("pct_mito"),raster=FALSE) 

```



```{r}
Idents(temp_sobj) = temp_sobj$RNA_snn_res.0.8

classes = c("D2_matrix", "D1_matrix", "non_SPN", "unsure", "eSPN", "D1_patch", "non_SPN", "D1_matrix", "D2_patch", "doublet", "non_SPN", "non_SPN", "non_SPN", "doublet")

temp_sobj= assignCellClasses(temp_sobj, classes=classes, cluster_col="RNA_snn_res.0.8", class_col = "neuron_cell_class")

DimPlot(temp_sobj, group.by = "neuron_cell_class" ,label = T, raster = FALSE)
```

```{r}
DimPlot(temp_sobj)

marker_genes <- c("CD96", "CX3CR1", "P2RY12", "C1QB", "C1QA", "CASZ1", "FLT1", "TF", "MOBP", "MOG", "MBP", "OLIG2", "OLIG1", "ST18", "GFAP", "AQP4", "SEMA3E", "EPHA4", "PPP1R1B", "DRD2", "DRD1", "GAD2", "GAD1", "SYT1", "RBFOX3", "SLC17A6", "SLC17A7")

Dotplot = DotPlot(object = temp_sobj, features = marker_genes, group.by = "neuron_cell_class")
Dotplot  <- Dotplot  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ coord_flip() 
print(Dotplot)
```

```{r}
KK_CaH_rxn4_neuron = temp_sobj
```

```{r}
KK_CaH_rxn4_neuron@meta.data$KK_doublets = "Singlet"
KK_CaH_rxn4_neuron$KK_doublets[KK_CaH_rxn4_neuron$neuron_cell_class == "doublet"] = "Doublet"
table(KK_CaH_rxn4_neuron$KK_doublets)
```




```{r}
sobj_list = list(KK_CaH_rxn4_astrocyte,
KK_CaH_rxn4_endo,
KK_CaH_rxn4_ependymal,
KK_CaH_rxn4_immune,
KK_CaH_rxn4_micro,
KK_CaH_rxn4_neuron,
KK_CaH_rxn4_oligo,
KK_CaH_rxn4_opc)

counts_list <- lapply(sobj_list, function(sobj) GetAssayData(sobj, slot = "counts"))

merged_counts <- do.call(cbind, counts_list)

metadata_list <- lapply(sobj_list, function(sobj) sobj@meta.data)

merged_metadata <- do.call(rbind, metadata_list)
merged_metadata

stopifnot(all(rownames(merged_metadata) == colnames(merged_counts)))

# Create Seurat object
CaH_rxn4_KK <- CreateSeuratObject(counts = merged_counts, meta.data = merged_metadata)
CaH_rxn4_KK
```

```{r}
dim(merged_counts)
dim(merged_metadata)
lapply(sobj_list, function(sobj) dim(sobj))
merged_metadata <- merged_metadata[match(colnames(merged_counts), rownames(merged_metadata)), ]

setdiff(colnames(merged_counts), rownames(merged_metadata))  # Cells in counts but not in metadata
setdiff(rownames(merged_metadata), colnames(merged_counts))  # Cells in metadata but not in counts

```



```{r}
# this code should take 3-10 minutes
hvgs = getSeuratVarFeatureIntersectByCol(CaH_rxn4_KK, subset_col="donor_id", original_nfeatures=2500)
n_dims_use=20
CaH_rxn4_KK = (CaH_rxn4_KK
   %>% NormalizeData() # log normalizes raw counts
   %>% ScaleData(features=hvgs, split.by="donor_id") # within each cell, for each gene scale the data (i.e. subtract the donor's mean and divide by the donor's standard deviation of that gene)
   %>% RunPCA(features=hvgs, npcs=n_dims_use) # Reduce the dimensions to the n_dims_use dimensions that best explain the data https://en.wikipedia.org/wiki/Principal_component_analysis
   %>% FindNeighbors(dims = 1:n_dims_use) # Finds every cells closest neighbors in the PCA space
   %>% FindClusters(resolution = 0.2) # finds clusters at a variety of resolutions
   %>% FindClusters(resolution = 0.3) # after clustering, the cluster labels are accessible via filtered_merged_caudate$RNA_snn_res.{resolution}
   %>% FindClusters(resolution = 0.4) # e.g.: filtered_merged_caudate$RNA_snn_res.0.4 here
   %>% FindClusters(resolution = 0.5)
   %>% FindClusters(resolution = 0.6)
   %>% FindClusters(resolution = 0.7)
   %>% FindClusters(resolution = 0.8)
   %>% FindClusters(resolution = 0.9)
   %>% FindClusters(resolution = 1)
   %>% RunUMAP(dims = 1:n_dims_use) # projects the PCA onto 2 dimensions, such that both "global structure" and "local structure" are optimally preserved
)

setwh = function(w, h){
   # set the width of the ensuing figures to w, height to h
   options(repr.plot.width = w, repr.plot.height = h)
}

DimPlot(CaH_rxn4_KK, group.by = "donor_id") 
DimPlot(CaH_rxn4_KK, group.by = "GT") 
DimPlot(CaH_rxn4_KK, group.by = "RNA_snn_res.0.2", label=T) 
DimPlot(CaH_rxn4_KK, group.by = "RNA_snn_res.0.3", label=T) 
DimPlot(CaH_rxn4_KK, group.by = "RNA_snn_res.0.4", label=T) 
DimPlot(CaH_rxn4_KK, group.by = "RNA_snn_res.0.5", label=T) 
DimPlot(CaH_rxn4_KK, group.by = "RNA_snn_res.0.6", label=T) 
DimPlot(CaH_rxn4_KK, group.by = "RNA_snn_res.0.7", label=T) 
DimPlot(CaH_rxn4_KK, group.by = "RNA_snn_res.0.8", label=T)

DimPlot(CaH_rxn4_KK, group.by = "cell_class", label=T)
DimPlot(CaH_rxn4_KK, group.by = "neuron_cell_class", label=T)
```


```{r}
Idents(CaH_rxn4_KK) = CaH_rxn4_KK$RNA_snn_res.0.2

classes = c("oligo", "astrocyte", "oligo", "oligo", "neuron", "oligo", "microglia", "oligo", "astrocyte", "opc", "endothelial", "neuron", "ependymal", "oligo", "neuron", "neuron", "immune")


CaH_rxn4_KK= assignCellClasses(CaH_rxn4_KK, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "final_cell_class")

DimPlot(CaH_rxn4_KK, group.by = "final_cell_class" ,label = T, raster = FALSE)

```

```{r}
CaH_rxn1_KK
CaH_rxn2_KK
CaH_rxn3_KK
CaH_rxn4_KK
```



#manual

```{r}
CaH_rxn4_KK@meta.data
```


```{r}
table(CaH_rxn4_KK$GT)
table(CaH_rxn4_KK$DF.classifications_0.25_0.03_243)
table(CaH_rxn4_KK$KK_doublets)
```

```{r}
library(caret)
library(ggplot2)
library(reshape2)  # For data manipulation

# Extract classifications
true_labels <- CaH_rxn4_KK@meta.data$KK_doublets  # Ground truth labels
pred_labels <- CaH_rxn4_KK@meta.data$DF.classifications_0.25_0.03_243  # DoubletFinder results

# Ensure factors have the same levels
true_labels <- factor(true_labels, levels = c("Singlet", "Doublet"))
pred_labels <- factor(pred_labels, levels = c("Singlet", "Doublet"))

# Compute confusion matrix
conf_matrix <- table(Predicted = pred_labels, True = true_labels)

# Convert to long format for ggplot2
conf_df <- as.data.frame(as.table(conf_matrix))
colnames(conf_df) <- c("Predicted", "True", "Freq")

ggplot(conf_df, aes(x = True, y = Predicted, fill = Freq)) +
    geom_tile() +
    geom_text(aes(label = Freq), color = "white", size = 6) +  # Add text labels
    scale_fill_gradient(low = "lightblue", high = "darkblue") +  # Customize colors
    theme_minimal() +
    labs(title = "KK Doublets vs DoubletFinder (CaH Rxn 4)", x = "True Label", y = "Predicted Label") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
true_labels <- CaH_rxn4_KK@meta.data$KK_doublets

# Calculate ROC AUC for DoubletFinder results
roc_curve <- roc(true_labels, CaH_rxn4_KK@meta.data$pANN_0.25_0.03_243)
auc(roc_curve)

# Confusion Matrix
table(true_labels, CaH_rxn4_KK@meta.data$DF.classifications_0.25_0.03_243)


df <- CaH_rxn4_KK@meta.data %>%
  select(pANN_0.25_0.03_243, KK_doublets) %>%  # Replace 'pANN_col' with the actual column name in metadata
  mutate(
    KK_binary = ifelse(KK_doublets == "Doublet", 1, 0)  # Convert Vireo ground truth to 1 (doublet) / 0 (singlet)
  )

# Compute ROC Curve using pANN scores
roc_pANN <- roc(df$KK_binary, df$pANN_0.25_0.03_243)  # pANN_col should be the column with pANN scores

# Print AUC value
auc_value <- auc(roc_pANN)
print(paste("AUC =", round(auc_value, 3)))

# Plot ROC Curve
ggroc(roc_pANN) +
  ggtitle(paste("Rxn 4: Doubletfinder vs KK (AUC =", round(auc_value, 3), ")")) +
  theme_minimal()
```

#combine all
```{r}
CaH_rxn1_KK@meta.data$library = "CaH_rxn1"
CaH_rxn2_KK@meta.data$library = "CaH_rxn2"
CaH_rxn3_KK@meta.data$library = "CaH_rxn3"
CaH_rxn4_KK@meta.data$library = "CaH_rxn4"

CaH_rxn1_KK@meta.data$pANN = CaH_rxn1_KK$pANN_0.25_0.04_220
CaH_rxn1_KK$pANN_0.25_0.04_220= NULL
CaH_rxn1_KK@meta.data$DF = CaH_rxn1_KK$DF.classifications_0.25_0.04_220
CaH_rxn1_KK$DF.classifications_0.25_0.04_220 = NULL

CaH_rxn2_KK@meta.data$pANN = CaH_rxn2_KK$pANN_0.25_0.03_226
CaH_rxn2_KK$pANN_0.25_0.03_226= NULL
CaH_rxn2_KK@meta.data$DF = CaH_rxn2_KK$DF.classifications_0.25_0.03_226
CaH_rxn2_KK$DF.classifications_0.25_0.03_226 = NULL

CaH_rxn3_KK@meta.data$pANN = CaH_rxn3_KK$pANN_0.25_0.03_242
CaH_rxn3_KK$pANN_0.25_0.03_242=NULL
CaH_rxn3_KK@meta.data$DF = CaH_rxn3_KK$DF.classifications_0.25_0.03_242
CaH_rxn3_KK$DF.classifications_0.25_0.03_242 = NULL

CaH_rxn4_KK@meta.data$pANN = CaH_rxn4_KK$pANN_0.25_0.03_243
CaH_rxn4_KK$pANN_0.25_0.03_243 = NULL
CaH_rxn4_KK@meta.data$DF = CaH_rxn4_KK$DF.classifications_0.25_0.03_243
CaH_rxn4_KK$DF.classifications_0.25_0.03_243 = NULL
```

```{r}
rownames(CaH_rxn1_KK@meta.data) = paste0(rownames(CaH_rxn1_KK@meta.data), "_",CaH_rxn1_KK@meta.data$library )
rownames(CaH_rxn2_KK@meta.data)= paste0(rownames(CaH_rxn2_KK@meta.data), "_",CaH_rxn2_KK@meta.data$library )
rownames(CaH_rxn3_KK@meta.data)= paste0(rownames(CaH_rxn3_KK@meta.data), "_",CaH_rxn3_KK@meta.data$library )
rownames(CaH_rxn4_KK@meta.data)= paste0(rownames(CaH_rxn4_KK@meta.data), "_",CaH_rxn4_KK@meta.data$library )

CaH_rxn1_KK@meta.data
CaH_rxn2_KK@meta.data
CaH_rxn3_KK@meta.data
CaH_rxn4_KK@meta.data
```


```{r}
sobj_list = list(CaH_rxn1_KK,CaH_rxn2_KK,CaH_rxn3_KK,CaH_rxn4_KK)

counts_list <- lapply(sobj_list, function(sobj) GetAssayData(sobj, slot = "counts"))

merged_counts <- do.call(cbind, counts_list)

metadata_list <- lapply(sobj_list, function(sobj) sobj@meta.data)

merged_metadata <- do.call(rbind, metadata_list)
merged_metadata

stopifnot(all(rownames(merged_metadata) == colnames(merged_counts)))

# Create Seurat object
CaH_combined_KK <- CreateSeuratObject(counts = merged_counts, meta.data = merged_metadata)
CaH_combined_KK
```

```{r}
merged_counts <- merged_counts[, !duplicated(colnames(merged_counts))]
merged_counts

any(duplicated(colnames(merged_counts)))  # Should return FALSE now

identical(rownames(merged_metadata), colnames(merged_counts))

# Keep only the barcodes in merged_metadata that are also in merged_counts
merged_metadata <- merged_metadata[colnames(merged_counts), , drop = FALSE]
merged_metadata

identical(rownames(merged_metadata), colnames(merged_counts))  # Should return TRUE


```


```{r}
dim(merged_counts)
dim(merged_metadata)
lapply(sobj_list, function(sobj) dim(sobj))
merged_metadata <- merged_metadata[match(colnames(merged_counts), rownames(merged_metadata)), ]

setdiff(colnames(merged_counts), rownames(merged_metadata))  # Cells in counts but not in metadata
setdiff(rownames(merged_metadata), colnames(merged_counts))  # Cells in metadata but not in counts

```


```{r}
CaH_rxn1_cellbender
filtered_CaH_rxn1_cellbender <- subset(CaH_rxn1_cellbender, subset = pct_mito < 10 & pct_intronic >= 0.25)
filtered_CaH_rxn1_cellbender = subset(filtered_CaH_rxn1_cellbender, subset = nUmi > 500)
filtered_CaH_rxn1_cellbender

CaH_rxn2_cellbender
filtered_CaH_rxn2_cellbender <- subset(CaH_rxn2_cellbender, subset = pct_mito < 10 & pct_intronic >= 0.25)
filtered_CaH_rxn2_cellbender = subset(filtered_CaH_rxn2_cellbender, subset = nUmi > 500)
filtered_CaH_rxn2_cellbender

CaH_rxn3_cellbender
filtered_CaH_rxn3_cellbender <- subset(CaH_rxn3_cellbender, subset = pct_mito < 10 & pct_intronic >= 0.25)
filtered_CaH_rxn3_cellbender = subset(filtered_CaH_rxn3_cellbender, subset = nUmi > 500)
filtered_CaH_rxn3_cellbender

CaH_rxn4_cellbender
filtered_CaH_rxn4_cellbender <- subset(CaH_rxn4_cellbender, subset = pct_mito < 10 & pct_intronic >= 0.25)
filtered_CaH_rxn4_cellbender = subset(filtered_CaH_rxn4_cellbender, subset = nUmi > 500)
filtered_CaH_rxn4_cellbender

filtered_CaH_rxn1_cellbender = subset(filtered_CaH_rxn1_cellbender, subset = donor_id != "unassigned" &  donor_id != "doublet")
filtered_CaH_rxn1_cellbender

filtered_CaH_rxn2_cellbender = subset(filtered_CaH_rxn2_cellbender, subset = donor_id != "unassigned" &  donor_id != "doublet")
filtered_CaH_rxn2_cellbender

filtered_CaH_rxn3_cellbender = subset(filtered_CaH_rxn3_cellbender, subset = donor_id != "unassigned" &  donor_id != "doublet")
filtered_CaH_rxn3_cellbender

filtered_CaH_rxn4_cellbender = subset(filtered_CaH_rxn4_cellbender, subset = donor_id != "unassigned" &  donor_id != "doublet")
filtered_CaH_rxn4_cellbender
```


```{r}
# Ensure unique cell names before extracting counts and metadata
sobj_list <- list(CaH_rxn1_cellbender, CaH_rxn2_cellbender, CaH_rxn3_cellbender, CaH_rxn4_cellbender)

for (i in seq_along(sobj_list)) {
    sobj <- sobj_list[[i]]
    new_cell_names <- paste0("Rxn", i, "__", colnames(sobj))  # Prefix with Rxn1, Rxn2, etc.
    colnames(sobj) <- new_cell_names
    rownames(sobj@meta.data) <- new_cell_names  # Ensure metadata matches
    sobj_list[[i]] <- sobj
}

# Extract counts and metadata
counts_list <- lapply(sobj_list, function(sobj) GetAssayData(sobj, slot = "counts"))
merged_counts <- do.call(cbind, counts_list)

metadata_list <- lapply(sobj_list, function(sobj) sobj@meta.data)
merged_metadata <- do.call(rbind, metadata_list)

# Check if rownames and colnames match
stopifnot(all(rownames(merged_metadata) == colnames(merged_counts)))

# Create Seurat object
CaH_combined_KK <- CreateSeuratObject(counts = merged_counts, meta.data = merged_metadata)
CaH_combined_KK


filtered_CaH_combined_KK <- subset(CaH_combined_KK, subset = pct_mito < 10 & pct_intronic >= 0.25)
filtered_CaH_combined_KK = subset(filtered_CaH_combined_KK, subset = nUmi > 500)
filtered_CaH_combined_KK = subset(filtered_CaH_combined_KK, subset = donor_id != "unassigned" &  donor_id != "doublet")
filtered_CaH_combined_KK
```

```{r}
# this code should take 3-10 minutes
hvgs = getSeuratVarFeatureIntersectByCol(filtered_CaH_combined_KK, subset_col="donor_id", original_nfeatures=2500)
n_dims_use=20
filtered_CaH_combined_KK = (filtered_CaH_combined_KK
   %>% NormalizeData() # log normalizes raw counts
   %>% ScaleData(features=hvgs, split.by="donor_id") # within each cell, for each gene scale the data (i.e. subtract the donor's mean and divide by the donor's standard deviation of that gene)
   %>% RunPCA(features=hvgs, npcs=n_dims_use) # Reduce the dimensions to the n_dims_use dimensions that best explain the data https://en.wikipedia.org/wiki/Principal_component_analysis
   %>% FindNeighbors(dims = 1:n_dims_use) # Finds every cells closest neighbors in the PCA space
   %>% FindClusters(resolution = 0.2) # finds clusters at a variety of resolutions
   %>% FindClusters(resolution = 0.3) # after clustering, the cluster labels are accessible via filtered_merged_caudate$RNA_snn_res.{resolution}
   %>% FindClusters(resolution = 0.4) # e.g.: filtered_merged_caudate$RNA_snn_res.0.4 here
   %>% FindClusters(resolution = 0.5)
   %>% FindClusters(resolution = 0.6)
   %>% FindClusters(resolution = 0.7)
   %>% FindClusters(resolution = 0.8)
   %>% FindClusters(resolution = 0.9)
   %>% FindClusters(resolution = 1)
   %>% RunUMAP(dims = 1:n_dims_use) # projects the PCA onto 2 dimensions, such that both "global structure" and "local structure" are optimally preserved
)

setwh = function(w, h){
   # set the width of the ensuing figures to w, height to h
   options(repr.plot.width = w, repr.plot.height = h)
}

DimPlot(filtered_CaH_combined_KK, group.by = "donor_id") 
DimPlot(filtered_CaH_combined_KK, group.by = "RNA_snn_res.0.2", label=T) 
DimPlot(filtered_CaH_combined_KK, group.by = "RNA_snn_res.0.3", label=T) 
DimPlot(filtered_CaH_combined_KK, group.by = "RNA_snn_res.0.4", label=T) 
DimPlot(filtered_CaH_combined_KK, group.by = "RNA_snn_res.0.5", label=T) 
DimPlot(filtered_CaH_combined_KK, group.by = "RNA_snn_res.0.6", label=T) 
DimPlot(filtered_CaH_combined_KK, group.by = "RNA_snn_res.0.7", label=T) 
DimPlot(filtered_CaH_combined_KK, group.by = "RNA_snn_res.0.8", label=T)
```


```{r}
Idents(filtered_CaH_combined_KK) = filtered_CaH_combined_KK$RNA_snn_res.0.2

classes = c("oligo", "astrocyte", "oligo", "oligo", "neuron", "oligo", "microglia", "oligo", "astrocyte", "opc", "endothelial", "neuron", "ependymal", "oligo", "neuron", "neuron", "immune")


filtered_CaH_combined_KK= assignCellClasses(filtered_CaH_combined_KK, classes=classes, cluster_col="RNA_snn_res.0.2", class_col = "final_cell_class_combined")

DimPlot(filtered_CaH_combined_KK, group.by = "final_cell_class_combined" ,label = T, raster = FALSE)

```





```{r}
filtered_CaH_combined_KK@meta.data
```


```{r}
DimPlot(filtered_CaH_combined_KK, group.by )
```






#Manual

```{r}
filtered_CaH_rxn1_cellbender
filtered_CaH_rxn2_cellbender
filtered_CaH_rxn3_cellbender
filtered_CaH_rxn4_cellbender

table(filtered_CaH_rxn4_cellbender$cell_class)
```


```{r}
temp_sobj = subset(filtered_CaH_rxn4_cellbender, subset = cell_class == "neuron")

# this code should take 3-10 minutes
hvgs = getSeuratVarFeatureIntersectByCol(temp_sobj, subset_col="donor_id", original_nfeatures=2500)
n_dims_use=20
temp_sobj = (temp_sobj
   %>% NormalizeData() # log normalizes raw counts
   %>% ScaleData(features=hvgs, split.by="donor_id") # within each cell, for each gene scale the data (i.e. subtract the donor's mean and divide by the donor's standard deviation of that gene)
   %>% RunPCA(features=hvgs, npcs=n_dims_use) # Reduce the dimensions to the n_dims_use dimensions that best explain the data https://en.wikipedia.org/wiki/Principal_component_analysis
   %>% FindNeighbors(dims = 1:n_dims_use) # Finds every cells closest neighbors in the PCA space
   %>% FindClusters(resolution = 0.2) # finds clusters at a variety of resolutions
   %>% FindClusters(resolution = 0.3) # after clustering, the cluster labels are accessible via filtered_merged_caudate$RNA_snn_res.{resolution}
   %>% FindClusters(resolution = 0.4) # e.g.: filtered_merged_caudate$RNA_snn_res.0.4 here
   %>% FindClusters(resolution = 0.5)
   %>% FindClusters(resolution = 0.6)
   %>% FindClusters(resolution = 0.7)
   %>% FindClusters(resolution = 0.8)
   %>% FindClusters(resolution = 0.9)
   %>% FindClusters(resolution = 1)
   %>% RunUMAP(dims = 1:n_dims_use) # projects the PCA onto 2 dimensions, such that both "global structure" and "local structure" are optimally preserved
)

setwh = function(w, h){
   # set the width of the ensuing figures to w, height to h
   options(repr.plot.width = w, repr.plot.height = h)
}

DimPlot(temp_sobj, group.by = "donor_id") 
DimPlot(temp_sobj, group.by = "GT") 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.2", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.3", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.4", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.5", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.6", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.7", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.8", label=T) 

FeaturePlot(temp_sobj, features = c("SYT1", "RBFOX3", "GAD2", "SLC17A6"), raster = F)
FeaturePlot(temp_sobj, features = c("AQP4", "GINS3", "GFAP"), raster = F)
FeaturePlot(temp_sobj, features = c("C1QA", "C1QB", "CX3CR1", "P2RY12"), raster = F)
FeaturePlot(temp_sobj, features = c("FLT1", "DCN", "RGS5"), raster = F)
FeaturePlot(temp_sobj, features = c("OLIG1", "MOG", "MOBP"), raster = F)
FeaturePlot(temp_sobj, features = c("OLIG2", "VCAN", "GAPDH"), raster = F)
FeaturePlot(temp_sobj, features = c("ZBBX", "CFAP157", "CFAP299", "BSG"), raster = F)
FeaturePlot(temp_sobj, features = c("CD96", "NKG7", "SKAP1"), raster = F)
FeaturePlot(temp_sobj, features = c("UBB", "GAPDH", "TUBB2A"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("pct_mito", "pct_intronic", "nUmi"),raster=FALSE) 

```


```{r}
marker_genes <- c("CD96", "CX3CR1", "P2RY12", "C1QB", "C1QA", "CASZ1", "FLT1", "TF", "MOBP", "MOG", "MBP", "OLIG2", "OLIG1", "ST18", "GFAP", "AQP4", "SEMA3E", "EPHA4", "PPP1R1B", "DRD2", "DRD1", "GAD2", "GAD1", "SYT1", "RBFOX3", "SLC17A6", "SLC17A7", "VCAN")

Dotplot = DotPlot(object = temp_sobj, features = marker_genes, group.by = "RNA_snn_res.0.4")
Dotplot  <- Dotplot  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ coord_flip() 
print(Dotplot)


 marker_genes <- c("SYT1", "RBFOX3", "GAD2", "SLC17A6","AQP4", "GINS3", "GFAP","C1QA", "C1QB", "CX3CR1", "P2RY12","FLT1", "DCN", "RGS5", "OLIG1", "MOG", "MOBP", "OLIG2", "VCAN", "GAPDH","ZBBX", "CFAP157", "CFAP299", "BSG","CD96", "NKG7", "SKAP1")
 Dotplot = DotPlot(object = temp_sobj, features = marker_genes, group.by = "RNA_snn_res.0.4")
Dotplot  <- Dotplot  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ coord_flip() 
print(Dotplot)
```
```{r}
temp_sobj@meta.data$KK_doublets = "Singlet"
temp_sobj$KK_doublets[temp_sobj$RNA_snn_res.0.4 == "2"] = "Doublet"
table(temp_sobj$KK_doublets)
```

```{r}
KK_CaH_rxn4_opc= temp_sobj
```


```{r}
KK_CaH_rxn4_astrocyte@meta.data$neuron_cell_class = KK_CaH_rxn4_astrocyte$cell_class
KK_CaH_rxn4_endo@meta.data$neuron_cell_class = KK_CaH_rxn4_endo$cell_class
KK_CaH_rxn4_ependymal@meta.data$neuron_cell_class = KK_CaH_rxn4_ependymal$cell_class
KK_CaH_rxn4_immune@meta.data$neuron_cell_class = KK_CaH_rxn4_immune$cell_class
KK_CaH_rxn4_micro@meta.data$neuron_cell_class = KK_CaH_rxn4_micro$cell_class

KK_CaH_rxn4_neuron

KK_CaH_rxn4_oligo@meta.data$neuron_cell_class = KK_CaH_rxn4_oligo$cell_class
KK_CaH_rxn4_opc@meta.data$neuron_cell_class = KK_CaH_rxn4_opc$cell_class
```

```{r}
KK_CaH_rxn1_neuron
```

```{r}
FeaturePlot(temp_sobj, features = c("SYT1", "AQP4", "C1QA","FLT1"),raster=FALSE)
FeaturePlot(temp_sobj, features = c("OLIG1", "OLIG2", "MOG" ,"CD96"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("MBP", "MOBP", "TF", "ST18"),raster=FALSE)
FeaturePlot(temp_sobj, features = c("RBFOX3", "CX3CR1", "GFAP" ,"AQP4"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("GAD1", "GAD2", "SLC17A7" ,"SLC17A6"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("DRD1", "DRD2", "CASZ1" ,"PPP1R1B"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("EPHA4", "SEMA3E", "SLC17A7" ,"SLC17A6"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("P2RY12", "CX3CR1", "C1QB", "BCAS1"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("SEMA5B", "KREMEN1", "PDE1C"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("TAC1", "NNAT", "OPRM1", "ID4"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("SGK1", "EPHA4", "SV2B"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("SST", "CALB1", "PVALB", "LAMP5"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("pct_mito"),raster=FALSE) 

```



```{r}
Idents(temp_sobj) = temp_sobj$RNA_snn_res.0.8

classes = c("D2_matrix", "D1_matrix", "non_SPN", "unsure", "eSPN", "D1_patch", "non_SPN", "D1_matrix", "D2_patch", "doublet", "non_SPN", "non_SPN", "non_SPN", "doublet")

temp_sobj= assignCellClasses(temp_sobj, classes=classes, cluster_col="RNA_snn_res.0.8", class_col = "neuron_cell_class")

DimPlot(temp_sobj, group.by = "neuron_cell_class" ,label = T, raster = FALSE)
```

```{r}
DimPlot(temp_sobj)

marker_genes <- c("CD96", "CX3CR1", "P2RY12", "C1QB", "C1QA", "CASZ1", "FLT1", "TF", "MOBP", "MOG", "MBP", "OLIG2", "OLIG1", "ST18", "GFAP", "AQP4", "SEMA3E", "EPHA4", "PPP1R1B", "DRD2", "DRD1", "GAD2", "GAD1", "SYT1", "RBFOX3", "SLC17A6", "SLC17A7")

Dotplot = DotPlot(object = temp_sobj, features = marker_genes, group.by = "neuron_cell_class")
Dotplot  <- Dotplot  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ coord_flip() 
print(Dotplot)
```

```{r}
KK_CaH_rxn4_neuron = temp_sobj
```

```{r}
KK_CaH_rxn4_neuron@meta.data$KK_doublets = "Singlet"
KK_CaH_rxn4_neuron$KK_doublets[KK_CaH_rxn4_neuron$neuron_cell_class == "doublet"] = "Doublet"
table(KK_CaH_rxn4_neuron$KK_doublets)
```




```{r}
sobj_list = list(KK_CaH_rxn4_astrocyte,
KK_CaH_rxn4_endo,
KK_CaH_rxn4_ependymal,
KK_CaH_rxn4_immune,
KK_CaH_rxn4_micro,
KK_CaH_rxn4_neuron,
KK_CaH_rxn4_oligo,
KK_CaH_rxn4_opc)

counts_list <- lapply(sobj_list, function(sobj) GetAssayData(sobj, slot = "counts"))

merged_counts <- do.call(cbind, counts_list)

metadata_list <- lapply(sobj_list, function(sobj) sobj@meta.data)

merged_metadata <- do.call(rbind, metadata_list)
merged_metadata

stopifnot(all(rownames(merged_metadata) == colnames(merged_counts)))

# Create Seurat object
CaH_rxn4_KK <- CreateSeuratObject(counts = merged_counts, meta.data = merged_metadata)
CaH_rxn4_KK
```





```{r}
table(filtered_CaH_rxn1_cellbender$GT, filtered_CaH_rxn1_cellbender$final_doublets, filtered_CaH_rxn1_cellbender$DF.classifications_0.25_0.03_226)
```


```{r}
filtered_CaH_rxn1_cellbender$doublet_agreement <- paste(
  filtered_CaH_rxn1_cellbender$GT,
  filtered_CaH_rxn1_cellbender$final_doublets,
  filtered_CaH_rxn1_cellbender$DF.classifications_0.25_0.04_220,
  sep = "_"
)

table(filtered_CaH_rxn1_cellbender$doublet_agreement)


DimPlot(filtered_CaH_rxn1_cellbender, group.by = "doublet_agreement", cols = c("red", "green", "blue", "lightgrey"))
```

```{r}
filtered_CaH_rxn1_cellbender$doublet_status <- ifelse(
  (filtered_CaH_rxn1_cellbender$final_doublets == "Doublet" & filtered_CaH_rxn1_cellbender$DF.classifications_0.25_0.04_220 == "Doublet"), 
  "Both Agree", 
  "Other"
)

DimPlot(filtered_CaH_rxn1_cellbender, group.by = "doublet_status", cols = c("blue", "red"))

```

```{r}
library(ComplexUpset)

# Convert columns to binary (1 = doublet, 0 = singlet)
doublet_matrix <- data.frame(
  Vireo = filtered_CaH_rxn1_cellbender$GT == "Doublet",
  Manual = filtered_CaH_rxn1_cellbender$final_doublets == "Doublet",
  DoubletFinder = filtered_CaH_rxn1_cellbender$DF.classifications_0.25_0.04_220 == "Doublet"
)

doublet_matrix
# Make UpSet plot
ComplexUpset::upset(doublet_matrix, names(doublet_matrix))


```

```{r}
doublet_matrix <- data.frame(
  #Vireo = filtered_CaH_rxn1_cellbender$GT == "Doublet",
  Manual = filtered_CaH_rxn1_cellbender$final_doublets == "Doublet",
  DoubletFinder = filtered_CaH_rxn1_cellbender$DF.classifications_0.25_0.04_220 == "Doublet"
)

doublet_matrix
# Make UpSet plot
ComplexUpset::upset(doublet_matrix, names(doublet_matrix))


```



```{r}
filtered_CaH_rxn1_cellbender@meta.data$cell_class_vireodoublets = paste0(filtered_CaH_rxn1_cellbender$cell_class, "_", filtered_CaH_rxn1_cellbender$GT)
table(filtered_CaH_rxn1_cellbender$cell_class_vireodoublets)

filtered_CaH_rxn1_cellbender@meta.data$cell_class_KKdoublets = paste0(filtered_CaH_rxn1_cellbender$cell_class, "_", filtered_CaH_rxn1_cellbender$KK_doublet)
table(filtered_CaH_rxn1_cellbender$cell_class_KKdoublets)

filtered_CaH_rxn1_cellbender@meta.data$cell_class_DFdoublets = paste0(filtered_CaH_rxn1_cellbender$cell_class, "_", filtered_CaH_rxn1_cellbender$DF.classifications_0.25_0.04_220)
table(filtered_CaH_rxn1_cellbender$cell_class_DFdoublets)
```



```{r}
filtered_CaH_rxn1_cellbender@meta.data

filtered_CaH_rxn1_cellbender@meta.data$cell_class_vireodoublets = paste0(filtered_CaH_rxn1_cellbender$cell_class, "_", filtered_CaH_rxn1_cellbender$GT)
a = as.data.frame(table(filtered_CaH_rxn1_cellbender$cell_class_vireodoublets))
a

a$cell_class = a$Var1
a$Var1 = NULL
a$Count = a$Freq
a$Method = "Vireo"
a$Freq = NULL
a

filtered_CaH_rxn1_cellbender@meta.data$cell_class_KKdoublets = paste0(filtered_CaH_rxn1_cellbender$cell_class, "_", filtered_CaH_rxn1_cellbender$KK_doublet)
b = as.data.frame(table(filtered_CaH_rxn1_cellbender$cell_class_KKdoublets))
b$cell_class = b$Var1
b$Var1 = NULL
b$Count = b$Freq
b$Method = "Manual_doublets"
b$Freq = NULL
b

filtered_CaH_rxn1_cellbender@meta.data$cell_class_DFdoublets = paste0(filtered_CaH_rxn1_cellbender$cell_class, "_", filtered_CaH_rxn1_cellbender$DF.classifications_0.25_0.04_220)
c = as.data.frame(table(filtered_CaH_rxn1_cellbender$cell_class_DFdoublets))
c$cell_class = c$Var1
c$Var1 = NULL
c$Count = c$Freq
c$Method = "DoubletFinder_doublets"
c$Freq = NULL
c

a
b
c
```
```{r}
merged_doublets = rbind(a, b, c)
merged_doublets

# Plot
ggplot(merged_doublets, aes(x = cell_class, y = Count, fill = Method)) +
  geom_col(position = "dodge") + # "dodge" places bars side by side
 # labs(x = "Category", y = "Value") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
```{r}
filtered_CaH_rxn1_cellbender@meta.data
```

```{r}
filtered_CaH_rxn1_cellbender@meta.data
```


```{r}
library(ggplot2)
library(tidyr)
library(dplyr)

# Example Data
df <- filtered_CaH_rxn1_cellbender@meta.data %>% select(donor_id, GT, KK_doublet, 
DF.classifications_0.25_0.04_220)
df

# Pivot to long format
df_long <- df %>%
  pivot_longer(cols = c("GT", "KK_doublet", "DF.classifications_0.25_0.04_220"),  # Select all method columns
               names_to = "Detection_Method",  # New column to store method names
               values_to = "Count")  # New column to store count values
df_long

```




```{r}
DimPlot(filtered_CaH_rxn1_cellbender, group.by = "cell_class")

cellclass = unique(filtered_CaH_rxn1_cellbender@meta.data$cell_class)
cellclass


for (cellclass in cellclass){
new_temp_sobj = subset(filtered_CaH_rxn1_cellbender, subset = cell_class == cellclass)


# this code should take 3-10 minutes
hvgs = getSeuratVarFeatureIntersectByCol(new_temp_sobj, subset_col="donor_id", original_nfeatures=2500)
n_dims_use=20
new_temp_sobj = (new_temp_sobj
   %>% NormalizeData() # log normalizes raw counts
   %>% ScaleData(features=hvgs, split.by="donor_id") # within each cell, for each gene scale the data (i.e. subtract the donor's mean and divide by the donor's standard deviation of that gene)
   %>% RunPCA(features=hvgs, npcs=n_dims_use) # Reduce the dimensions to the n_dims_use dimensions that best explain the data https://en.wikipedia.org/wiki/Principal_component_analysis
   %>% FindNeighbors(dims = 1:n_dims_use) # Finds every cells closest neighbors in the PCA space
   %>% FindClusters(resolution = 0.2) # finds clusters at a variety of resolutions
   %>% FindClusters(resolution = 0.3) # after clustering, the cluster labels are accessible via filtered_merged_caudate$RNA_snn_res.{resolution}
   %>% FindClusters(resolution = 0.4) # e.g.: filtered_merged_caudate$RNA_snn_res.0.4 here
   %>% FindClusters(resolution = 0.5)
   %>% FindClusters(resolution = 0.6)
   %>% FindClusters(resolution = 0.7)
   %>% FindClusters(resolution = 0.8)
   %>% FindClusters(resolution = 0.9)
   %>% FindClusters(resolution = 1)
   %>% RunUMAP(dims = 1:n_dims_use) # projects the PCA onto 2 dimensions, such that both "global structure" and "local structure" are optimally preserved
)

setwh = function(w, h){
   # set the width of the ensuing figures to w, height to h
   options(repr.plot.width = w, repr.plot.height = h)
}

a = DimPlot(new_temp_sobj, group.by = "cell_class", label = T)
b = DimPlot(new_temp_sobj, group.by = "RNA_snn_res.0.5", label = T)
c = DimPlot(new_temp_sobj, group.by = "KK_doublet", label = T)
d = DimPlot(new_temp_sobj, group.by = "DF.classifications_0.25_0.04_471", label = T)

all = a + b+c +d
ggsave(all, filename = paste0(cellclass, ".png"), width = 16, height =8)
}
```





```{r}
temp_sobj = subset(filtered_CaH_rxn1_cellbender, subset = cell_class == "neuron")

# this code should take 3-10 minutes
hvgs = getSeuratVarFeatureIntersectByCol(temp_sobj, subset_col="donor_id", original_nfeatures=2500)
n_dims_use=20
temp_sobj = (temp_sobj
   %>% NormalizeData() # log normalizes raw counts
   %>% ScaleData(features=hvgs, split.by="donor_id") # within each cell, for each gene scale the data (i.e. subtract the donor's mean and divide by the donor's standard deviation of that gene)
   %>% RunPCA(features=hvgs, npcs=n_dims_use) # Reduce the dimensions to the n_dims_use dimensions that best explain the data https://en.wikipedia.org/wiki/Principal_component_analysis
   %>% FindNeighbors(dims = 1:n_dims_use) # Finds every cells closest neighbors in the PCA space
   %>% FindClusters(resolution = 0.2) # finds clusters at a variety of resolutions
   %>% FindClusters(resolution = 0.3) # after clustering, the cluster labels are accessible via filtered_merged_caudate$RNA_snn_res.{resolution}
   %>% FindClusters(resolution = 0.4) # e.g.: filtered_merged_caudate$RNA_snn_res.0.4 here
   %>% FindClusters(resolution = 0.5)
   %>% FindClusters(resolution = 0.6)
   %>% FindClusters(resolution = 0.7)
   %>% FindClusters(resolution = 0.8)
   %>% FindClusters(resolution = 0.9)
   %>% FindClusters(resolution = 1)
   %>% RunUMAP(dims = 1:n_dims_use) # projects the PCA onto 2 dimensions, such that both "global structure" and "local structure" are optimally preserved
)

setwh = function(w, h){
   # set the width of the ensuing figures to w, height to h
   options(repr.plot.width = w, repr.plot.height = h)
}

DimPlot(temp_sobj, group.by = "donor_id") 
DimPlot(temp_sobj, group.by = "GT") 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.2", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.3", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.4", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.5", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.6", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.7", label=T) 
DimPlot(temp_sobj, group.by = "RNA_snn_res.0.8", label=T) 

FeaturePlot(temp_sobj, features = c("SYT1", "RBFOX3", "GAD2", "SLC17A6"), raster = F)
FeaturePlot(temp_sobj, features = c("AQP4", "GINS3", "GFAP"), raster = F)
FeaturePlot(temp_sobj, features = c("C1QA", "C1QB", "CX3CR1", "P2RY12"), raster = F)
FeaturePlot(temp_sobj, features = c("FLT1", "DCN", "RGS5"), raster = F)
FeaturePlot(temp_sobj, features = c("OLIG1", "MOG", "MOBP"), raster = F)
FeaturePlot(temp_sobj, features = c("OLIG2", "VCAN", "GAPDH"), raster = F)
FeaturePlot(temp_sobj, features = c("ZBBX", "CFAP157", "CFAP299", "BSG"), raster = F)
FeaturePlot(temp_sobj, features = c("CD96", "NKG7", "SKAP1"), raster = F)
FeaturePlot(temp_sobj, features = c("UBB", "GAPDH", "TUBB2A"),raster=FALSE) 
FeaturePlot(temp_sobj, features = c("pct_mito", "pct_intronic", "nUmi"),raster=FALSE) 

```


```{r}
FeaturePlot(filtered_CaH_rxn1_cellbender, features = c("pct_mito"),raster=FALSE) 
FeaturePlot(filtered_CaH_rxn1_cellbender, features = c("pct_intronic"),raster=FALSE) 
FeaturePlot(filtered_CaH_rxn1_cellbender, features = c("nUmi"),raster=FALSE) 
DimPlot(filtered_CaH_rxn1_cellbender, group.by = "KK_doublet", label = T)
DimPlot(filtered_CaH_rxn1_cellbender, group.by = "DF.classifications_0.25_0.04_471", label = T)
DimPlot(filtered_CaH_rxn1_cellbender, group.by = "GT", label = T)

```



```{r}
marker_genes <- c("CD96", "CX3CR1", "P2RY12", "C1QB", "C1QA", "CASZ1", "FLT1", "TF", "MOBP", "MOG", "MBP", "OLIG2", "OLIG1", "ST18", "GFAP", "AQP4", "SEMA3E", "EPHA4", "PPP1R1B", "DRD2", "DRD1", "GAD2", "GAD1", "SYT1", "RBFOX3", "SLC17A6", "SLC17A7")

Dotplot = DotPlot(object = temp_sobj, features = marker_genes, group.by = "RNA_snn_res.0.6")
Dotplot  <- Dotplot  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ coord_flip() 
print(Dotplot)


 marker_genes <- c("SYT1", "RBFOX3", "GAD2", "SLC17A6","AQP4", "GINS3", "GFAP","C1QA", "C1QB", "CX3CR1", "P2RY12","FLT1", "DCN", "RGS5", "OLIG1", "MOG", "MOBP", "OLIG2", "VCAN", "GAPDH","ZBBX", "CFAP157", "CFAP299", "BSG","CD96", "NKG7", "SKAP1")
 Dotplot = DotPlot(object = temp_sobj, features = marker_genes, group.by = "RNA_snn_res.0.6")
Dotplot  <- Dotplot  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ coord_flip() 
print(Dotplot)
```
```{r}
temp_sobj= KK_CaH_rxn1_opc_clean
```

```{r}
df = as.data.frame(table(filtered_CaH_rxn1_cellbender$cell_class,filtered_CaH_rxn1_cellbender$GT))
df
df$cell_class = df$Var1
df$Var1= NULL
df$GT = df$Var2
df$Var2 = NULL
df$count = df$Freq
df$Freq = NULL

df_summary <- df %>%
  group_by(cell_class) %>%
  summarise(total_cells = sum(count))
df_summary
```

```{r}
df = merge(df, df_summary, by = "cell_class")
df
```
```{r}
df$proportion = df$count/df$total_cells

ggplot(df, aes(x = cell_class, y = proportion, fill = GT)) + geom_col(position = "dodge") + # "dodge" places bars side by side
 # labs(x = "Category", y = "Value") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ggtitle("Proportion of Vireo Doublets by Cell Class")

```
```{r}
filtered_CaH_rxn1_cellbender@meta.data
```

```{r}

 marker_genes <- c("SYT1", "RBFOX3", "GAD2", "SLC17A6","AQP4", "GINS3", "GFAP","C1QA", "C1QB", "CX3CR1", "P2RY12","FLT1", "DCN", "RGS5", "OLIG1", "MOG", "MOBP", "OLIG2", "VCAN","ZBBX", "CFAP157", "CFAP299", "BSG","CD96", "NKG7", "SKAP1")
 Dotplot = DotPlot(object = filtered_CaH_rxn1_cellbender, features = marker_genes, group.by = "cell_class_KKdoublets")
Dotplot  <- Dotplot  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ coord_flip() + ggtitle("KK")
print(Dotplot)

 Dotplot = DotPlot(object = filtered_CaH_rxn1_cellbender, features = marker_genes, group.by = "cell_class_DFdoublets")
Dotplot  <- Dotplot  + theme(axis.text.x = element_text(angle = 45, hjust = 1))+ coord_flip() + ggtitle("DoubletFinder")
print(Dotplot)
```

